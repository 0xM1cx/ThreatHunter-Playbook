
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extended NetNTLM Downgrade &#8212; Threat Hunter Playbook</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://threathunterplaybook.com/notebooks/windows/05_defense_evasion/WIN-191224222300.html" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Enable Remote Desktop Conections Registry" href="WIN-190407183310.html" />
    <link rel="prev" title="Wuauclt CreateRemoteThread Execution" href="WIN-201012183248.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      <img src="../../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Threat Hunter Playbook</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Knowledge Library
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../library/windows/intro.html">
   Windows
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/service_control_manager.html">
     Service Control Manager
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/mimikatz_openprocess_modules.html">
     Mimikatz OpenProcess Modules
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/security_account_manager_database.html">
     Security Account Manager (SAM) Database
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/security_account_manager_protocol.html">
     Security Account Manager Remote Protocol (SAMRP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/adfs_dkm_keys.html">
     Active Directory Federation Services (ADFS) Distributed Key Manager (DKM) Keys
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/syskey.html">
     SysKey
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/logon_session.html">
     Logon Session
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/security_assertion_markup_language.html">
     Security Assertion Markup Language (SAML)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/active_directory_replication.html">
     Active Directory Replication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/lsa_policy_objects.html">
     LSA Policy Objects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/process_access_rights.html">
     Process Security and Access Rights
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/data_protection_api.html">
     Data Protection API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../library/windows/task_scheduler_service.html">
     Task Scheduler Service
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Pre-Hunt Activities
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../pre-hunt/data_management.html">
   Data Management
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../pre-hunt/data_documentation.html">
     Data Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../pre-hunt/data_standardization.html">
     Data Standardization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../pre-hunt/data_modeling.html">
     Data Modeling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../pre-hunt/data_quality.html">
     Data Quality
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Campaign Notebooks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../evals/intro.html">
   ATT&amp;CK Evaluations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../evals/apt29/intro.html">
     APT 29
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../evals/apt29/report.html">
       Free Telemetry Report
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../campaigns/apt29Evals.html">
       Free Telemetry Notebook
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Targeted Notebooks
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../intro.html">
   Windows
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../02_execution/intro.html">
     Execution
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-190815181010.html">
       Remote Service creation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-190810201010.html">
       WMI Win32_Process Class and Create Method for Remote Execution
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-201009173318.html">
       Remote WMI Wbemcomn DLL Hijack
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-190410151110.html">
       Basic PowerShell Execution
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-190813181020.html">
       Service Creation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-190610201010.html">
       Alternate PowerShell Hosts
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-190811201010.html">
       WMI Module Load
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../02_execution/WIN-190511223310.html">
       PowerShell Remote Session
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../03_persistence/intro.html">
     Persistence
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../03_persistence/WIN-190810170510.html">
       WMI Eventing
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../03_persistence/WIN-200902020333.html">
       Remote WMI ActiveScriptEventConsumers
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../04_privilege_escalation/intro.html">
     Privilege Escalation
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
    <label for="toctree-checkbox-8">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../04_privilege_escalation/WIN-200902020333.html">
       Remote WMI ActiveScriptEventConsumers
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="intro.html">
     Defense Evasion
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="WIN-180719170510.html">
       DLL Injection via CreateRemoteThread and LoadLibrary
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="WIN-201012183248.html">
       Wuauclt CreateRemoteThread Execution
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Extended NetNTLM Downgrade
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="WIN-190407183310.html">
       Enable Remote Desktop Conections Registry
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="WIN-190510202010.html">
       WDigest Downgrade
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="WIN-190101151110.html">
       Active Directory Replication User Backdoor
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../06_credential_access/intro.html">
     Credential Access
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
    <label for="toctree-checkbox-10">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../06_credential_access/WIN-190620024610.html">
       Domain DPAPI Backup Key Extraction
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../06_credential_access/WIN-190725024610.html">
       SAM Registry Hive Handle Request
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../06_credential_access/WIN-180815210510.html">
       Active Directory Replication From Non-Domain-Controller Accounts
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../06_credential_access/WIN-191030201010.html">
       Remote Interactive Task Manager LSASS Dump
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../06_credential_access/WIN-170105221010.html">
       LSASS Access from Non System Account
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../07_discovery/intro.html">
     Discovery
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
    <label for="toctree-checkbox-11">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../07_discovery/WIN-190725024610.html">
       SAM Registry Hive Handle Request
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../07_discovery/WIN-190625024610.html">
       SysKey Registry Keys Access
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../07_discovery/WIN-190826010110.html">
       Remote Service Control Manager Handle
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../08_lateral_movement/intro.html">
     Lateral Movement
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
    <label for="toctree-checkbox-12">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../08_lateral_movement/WIN-190815181010.html">
       Remote Service creation
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../08_lateral_movement/WIN-190810201010.html">
       WMI Win32_Process Class and Create Method for Remote Execution
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../08_lateral_movement/WIN-200902020333.html">
       Remote WMI ActiveScriptEventConsumers
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../08_lateral_movement/WIN-201012004336.html">
       SMB Create Remote File
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../08_lateral_movement/WIN-201009173318.html">
       Remote WMI Wbemcomn DLL Hijack
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../08_lateral_movement/WIN-201009183000.html">
       Remote DCOM IErtUtil DLL Hijack
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../08_lateral_movement/WIN-190511223310.html">
       PowerShell Remote Session
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../09_collection/intro.html">
     Collection
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
    <label for="toctree-checkbox-13">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../09_collection/WIN-200609225055.html">
       Access to Microphone Device
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../tutorials/jupyter/introduction.html">
   Jupyter Notebooks
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../tutorials/jupyter/installing_jupyter.html">
     Jupyter Server Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../tutorials/jupyter/notebooks/01_intro_to_python.html">
     Introduction to Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../tutorials/jupyter/notebooks/02_intro_to_numpy_arrays.html">
     Introduction to Python NumPy Arrays
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../tutorials/jupyter/notebooks/03_intro_to_pandas.html">
     Introduction to Pandas
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/notebooks/windows/05_defense_evasion/WIN-191224222300.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/OTRF/ThreatHunter-Playbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/OTRF/ThreatHunter-Playbook/issues/new?title=Issue%20on%20page%20%2Fnotebooks/windows/05_defense_evasion/WIN-191224222300.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/OTRF/ThreatHunter-Playbook/edit/master/docs/notebooks/windows/05_defense_evasion/WIN-191224222300.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/OTRF/ThreatHunter-Playbook/master?urlpath=tree/docs/notebooks/windows/05_defense_evasion/WIN-191224222300.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/OTRF/ThreatHunter-Playbook/blob/master/docs/notebooks/windows/05_defense_evasion/WIN-191224222300.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#metadata">
   Metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hypothesis">
   Hypothesis
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#technical-context">
   Technical Context
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#offensive-tradecraft">
   Offensive Tradecraft
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mordor-test-data">
   Mordor Test Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analytics">
   Analytics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initialize-analytics-engine">
     Initialize Analytics Engine
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-process-mordor-dataset">
     Download &amp; Process Mordor Dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analytic-i">
     Analytic I
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analytic-ii">
     Analytic II
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analytic-iii">
     Analytic III
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#known-bypasses">
   Known Bypasses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#false-positives">
   False Positives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hunter-notes">
   Hunter Notes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hunt-output">
   Hunt Output
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="extended-netntlm-downgrade">
<h1>Extended NetNTLM Downgrade<a class="headerlink" href="#extended-netntlm-downgrade" title="Permalink to this headline">¶</a></h1>
<div class="section" id="metadata">
<h2>Metadata<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:left head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>collaborators</p></td>
<td class="text-align:left"><p>[‘&#64;Cyb3rWard0g’, ‘&#64;Cyb3rPandaH’]</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>creation date</p></td>
<td class="text-align:left"><p>2019/12/24</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>modification date</p></td>
<td class="text-align:left"><p>2020/09/20</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>playbook related</p></td>
<td class="text-align:left"><p>[]</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="hypothesis">
<h2>Hypothesis<a class="headerlink" href="#hypothesis" title="Permalink to this headline">¶</a></h2>
<p>Adversaries might be downgrading the challenge/response authentication protocol used for network logons, the minimum security negotiated for applications using NTLMSSP, and security settings that restrict outgoing NTLM traffic to remote servers in my environment</p>
</div>
<div class="section" id="technical-context">
<h2>Technical Context<a class="headerlink" href="#technical-context" title="Permalink to this headline">¶</a></h2>
<p>LAN Manager (LM) includes client computer and server software from Microsoft that allows users to link personal devices together on a single network.
Network capabilities include transparent file and print sharing, user security features, and network administration tools.
In Active Directory domains, the Kerberos protocol is the default authentication protocol.
However, if the Kerberos protocol is not negotiated for some reason, Active Directory uses LM, NTLM, or NTLM version 2 (NTLMv2).</p>
<p>LAN Manager authentication includes the LM, NTLM, and NTLMv2 variants, and it is the protocol that is used to authenticate all client devices running the Windows operating system when they perform the following operations</p>
<ul class="simple">
<li><p>Join a domain</p></li>
<li><p>Authenticate between Active Directory forests</p></li>
<li><p>Authenticate to domains based on earlier versions of the Windows operating system</p></li>
<li><p>Authenticate to computers that do not run Windows operating systems, beginning with Windows 2000</p></li>
<li><p>Authenticate to computers that are not in the domain</p></li>
</ul>
<p>Prior to Windows NT 4.0 Service Pack 4 (SP4), Windows NT supported two kinds of challenge/response authentication -&gt; LanManager (LM) challenge/response and Windows NT challenge/response (also known as NTLM challenge/response)
Windows NT also supported session security mechanisms that provided for Message confidentiality and integrity.
To allow access to servers that only support LM authentication, Windows NT clients prior to SP4 always use both, even to Windows NT servers that supported NTLM authentication.</p>
<p>LM authentication is not as strong as Windows NT authentication so some customers may want to disable its use, because an attacker eavesdropping on network traffic will attack the weaker protocol.
A successful attack can compromise the user’s password.
Microsoft has developed an enhancement to NTLM called NTLMv2 that significantly improves both the authentication and session security mechanisms.</p>
<p>In addition, the implementation of the NTLM Security Service Provider (SSP) has been enhanced to allow clients to control which variants of NTLM are used, and to allow servers to control which variants they will accept, by setting a new registry key appropriately.
It also allows clients and servers to require the negotiation of Message confidentiality (encryption), Message integrity, 128-bit encryption, and NTLMv2 session security.</p>
<p>Control of NTLM security is through the following registry key</p>
<ul class="simple">
<li><p>HKEY_LOCAL_MACHINE\System\CurrentControlSet\control\LSA</p></li>
</ul>
<p>Choice of the authentication protocol variants used and accepted is through the following value of that key</p>
<p>Value -&gt; LMCompatibilityLevel
Value Type -&gt; REG_DWORD - Number
Valid Range -&gt; 0-5
Default -&gt; 0
Description -&gt; This parameter specifies the type of authentication to be
used.</p>
<p>Level 0 - Send LM response and NTLM response; never use NTLMv2 session security
Level 1 - Use NTLMv2 session security if negotiated
Level 2 - Send NTLM authenication only
Level 3 - Send NTLMv2 authentication  only
Level 4 - DC refuses LM authentication
Level 5 - DC refuses LM and NTLM authenication (accepts only NTLMv2)</p>
<p>Control over the minimum security negotiated for applications using NTLMSSP is
through the following key</p>
<ul class="simple">
<li><p>HKEY_LOCAL_MACHINE\System\CurrentControlSet\control\LSA\MSV1_0</p></li>
</ul>
<p>The following values are for this key</p>
<ul class="simple">
<li><p>Value -&gt; NtlmMinClientSec</p></li>
<li><p>Value Type -&gt; REG_DWORD - Number</p></li>
<li><p>Valid Range -&gt; the logical ‘or’ of any of the following values</p>
<ul>
<li><p>0x00000010</p></li>
<li><p>0x00000020</p></li>
<li><p>0x00080000</p></li>
<li><p>0x20000000</p></li>
</ul>
</li>
<li><p>Default -&gt; 0</p></li>
<li><p>Value -&gt; NtlmMinServerSec</p></li>
<li><p>Value Type -&gt; REG_DWORD - Number</p></li>
<li><p>Valid Range -&gt; same as NtlmMinClientSec</p></li>
<li><p>Default -&gt; 0</p></li>
<li><p>Description -&gt; This parameter specifies the minimum security to be used.</p>
<ul>
<li><p>0x00000010  Message integrity</p></li>
<li><p>0x00000020  Message confidentiality</p></li>
<li><p>0x00080000  NTLMv2 session security</p></li>
<li><p>0x20000000  128 bit encryption</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="offensive-tradecraft">
<h2>Offensive Tradecraft<a class="headerlink" href="#offensive-tradecraft" title="Permalink to this headline">¶</a></h2>
<p>An adversary with administrator rights to a compromised endpoint could easily modify these settings and downgrade the challenge/response authentication protocol used for network logons and the minimum security negotiated for applications using NTLMSSP.
This is very dangerous because it could enable NetNTLMv1 as a client on the compromised endpoit and make it authenticate to a rogue SMB server to capture the client’s response (an NTLM Hash).
If an organization is already restricting outgoing NTLM traffic to remote servers, it can be easily disabled by modifying the following registry key Property and setting it to 0.</p>
<ul class="simple">
<li><p>Key -&gt; HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0</p></li>
<li><p>Property -&gt; RestrictSendingNTLMTraffic</p></li>
</ul>
</div>
<div class="section" id="mordor-test-data">
<h2>Mordor Test Data<a class="headerlink" href="#mordor-test-data" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:left head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>metadata</p></td>
<td class="text-align:left"><p><a class="reference external" href="https://mordordatasets.com/notebooks/small/windows/05_defense_evasion/SDWIN-191225045202.html">https://mordordatasets.com/notebooks/small/windows/05_defense_evasion/SDWIN-191225045202.html</a></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>link</p></td>
<td class="text-align:left"><p><a class="reference external" href="https://raw.githubusercontent.com/OTRF/mordor/master/datasets/small/windows/defense_evasion/host/empire_monologue_netntlm_downgrade.zip">https://raw.githubusercontent.com/OTRF/mordor/master/datasets/small/windows/defense_evasion/host/empire_monologue_netntlm_downgrade.zip</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="analytics">
<h2>Analytics<a class="headerlink" href="#analytics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="initialize-analytics-engine">
<h3>Initialize Analytics Engine<a class="headerlink" href="#initialize-analytics-engine" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openhunt.mordorutils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">get_spark</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="download-process-mordor-dataset">
<h3>Download &amp; Process Mordor Dataset<a class="headerlink" href="#download-process-mordor-dataset" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mordor_file</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/OTRF/mordor/master/datasets/small/windows/defense_evasion/host/empire_monologue_netntlm_downgrade.zip&quot;</span>
<span class="n">registerMordorSQLTable</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">mordor_file</span><span class="p">,</span> <span class="s2">&quot;mordorTable&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[+] Processing a Spark DataFrame..
[+] DataFrame Returned !
[+] Temporary SparkSQL View: mordorTable 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="analytic-i">
<h3>Analytic I<a class="headerlink" href="#analytic-i" title="Permalink to this headline">¶</a></h3>
<p>Look for non-system accounts getting a handle and accessing \REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa and \REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa\MSV1_0 registry keys from a non-lsass process</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Data source</p></th>
<th class="text-align:left head"><p>Event Provider</p></th>
<th class="head"><p>Relationship</p></th>
<th class="head"><p>Event</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Windows Registry</p></td>
<td class="text-align:left"><p>Microsoft-Windows-Security-Auditing</p></td>
<td><p>Process accessed Windows registry key</p></td>
<td><p>4663</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Windows Registry</p></td>
<td class="text-align:left"><p>Microsoft-Windows-Security-Auditing</p></td>
<td><p>User accessed Windows registry key</p></td>
<td><p>4663</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Windows Registry</p></td>
<td class="text-align:left"><p>Microsoft-Windows-Security-Auditing</p></td>
<td><p>Process requested access Windows registry key</p></td>
<td><p>4656</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Windows Registry</p></td>
<td class="text-align:left"><p>Microsoft-Windows-Security-Auditing</p></td>
<td><p>User requested access Windows registry key</p></td>
<td><p>4656</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT `@timestamp`, Hostname, SubjectUserName, ProcessName, ObjectName, AccessMask, EventID, SubjectLogonId</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID IN (4663, 4656)</span>
<span class="sd">    AND ObjectType = &#39;Key&#39;</span>
<span class="sd">    AND (ObjectName LIKE &quot;%Lsa&quot; OR ObjectName LIKE &quot;%Lsa\MSV1_0&quot;)</span>
<span class="sd">    AND ProcessName NOT LIKE &quot;%lsass.exe&quot;</span>
<span class="sd">    AND SubjectLogonId != &quot;0x3e7&quot;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------------------+---------------+---------------+---------------------------------------------------------+--------------------------------------------------+----------+-------+--------------+
|@timestamp             |Hostname       |SubjectUserName|ProcessName                                              |ObjectName                                        |AccessMask|EventID|SubjectLogonId|
+-----------------------+---------------+---------------+---------------------------------------------------------+--------------------------------------------------+----------+-------+--------------+
|2019-12-24 23:52:33.145|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa|0x2       |4663   |0x49631       |
|2019-12-24 23:52:33.145|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa|0x2001f   |4656   |0x49631       |
|2019-12-24 23:52:33.154|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa|0x2001f   |4656   |0x49631       |
|2019-12-24 23:52:33.154|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa|0x2       |4663   |0x49631       |
+-----------------------+---------------+---------------+---------------------------------------------------------+--------------------------------------------------+----------+-------+--------------+
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="analytic-ii">
<h3>Analytic II<a class="headerlink" href="#analytic-ii" title="Permalink to this headline">¶</a></h3>
<p>Look for processes modifying the values of the following registry key properties LMCompatibilityLevel,NtlmMinClientSec and RestrictSendingNTLMTraffic</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Data source</p></th>
<th class="text-align:left head"><p>Event Provider</p></th>
<th class="head"><p>Relationship</p></th>
<th class="head"><p>Event</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Windows Registry</p></td>
<td class="text-align:left"><p>Microsoft-Windows-Security-Auditing</p></td>
<td><p>Process modified Windows registry key value</p></td>
<td><p>4657</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT `@timestamp`, Hostname, SubjectUserName, ProcessName, ObjectName, OldValue, NewValue, SubjectLogonId</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4657</span>
<span class="sd">    AND ObjectValueName in (&quot;LMCompatibilityLevel&quot;,&quot;NtlmMinClientSec&quot;,&quot;RestrictSendingNTLMTraffic&quot;)</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------------------+---------------+---------------+---------------------------------------------------------+---------------------------------------------------------+---------+---------+--------------+
|@timestamp             |Hostname       |SubjectUserName|ProcessName                                              |ObjectName                                               |OldValue |NewValue |SubjectLogonId|
+-----------------------+---------------+---------------+---------------------------------------------------------+---------------------------------------------------------+---------+---------+--------------+
|2019-12-24 23:52:33.148|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa\MSV1_0|2        |0        |0x49631       |
|2019-12-24 23:52:33.157|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa       |2        |3        |0x49631       |
|2019-12-24 23:52:33.158|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa\MSV1_0|536870912|537395200|0x49631       |
|2019-12-24 23:52:33.145|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa       |3        |2        |0x49631       |
|2019-12-24 23:52:33.146|IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa\MSV1_0|537395200|536870912|0x49631       |
|2019-12-24 23:52:33.16 |IT001.shire.com|pgustavo       |C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|\REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa\MSV1_0|0        |2        |0x49631       |
+-----------------------+---------------+---------------+---------------------------------------------------------+---------------------------------------------------------+---------+---------+--------------+
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="analytic-iii">
<h3>Analytic III<a class="headerlink" href="#analytic-iii" title="Permalink to this headline">¶</a></h3>
<p>Look for processes modifying the values of the following registry key properties LMCompatibilityLevel,NtlmMinClientSec and RestrictSendingNTLMTraffic</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Data source</p></th>
<th class="text-align:left head"><p>Event Provider</p></th>
<th class="head"><p>Relationship</p></th>
<th class="head"><p>Event</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Windows Registry</p></td>
<td class="text-align:left"><p>Microsoft-Windows-Sysmon/Operational</p></td>
<td><p>Process modified Windows registry key value</p></td>
<td><p>13</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT `@timestamp`, Hostname, Image, TargetObject, Details</span>
<span class="sd">FROM mordorTable</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 13</span>
<span class="sd">    AND (</span>
<span class="sd">        TargetObject LIKE &quot;%LMCompatibilityLevel&quot; OR</span>
<span class="sd">        TargetObject LIKE &quot;%NtlmMinClientSec&quot; OR</span>
<span class="sd">        TargetObject LIKE &quot;%RestrictSendingNTLMTraffic&quot;</span>
<span class="sd">    )</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-----------------------+---------------+---------------------------------------------------------+---------------------------------------------------------------------------+------------------+
|@timestamp             |Hostname       |Image                                                    |TargetObject                                                               |Details           |
+-----------------------+---------------+---------------------------------------------------------+---------------------------------------------------------------------------+------------------+
|2019-12-24 23:52:32.078|IT001.shire.com|C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0\NtlmMinClientSec          |DWORD (0x20000000)|
|2019-12-24 23:52:32.078|IT001.shire.com|C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|HKLM\System\CurrentControlSet\Control\Lsa\LMCompatibilityLevel             |DWORD (0x00000002)|
|2019-12-24 23:52:32.08 |IT001.shire.com|C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0\RestrictSendingNTLMTraffic|DWORD (0x00000000)|
|2019-12-24 23:52:33.143|IT001.shire.com|C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0\NtlmMinClientSec          |DWORD (0x20080000)|
|2019-12-24 23:52:33.142|IT001.shire.com|C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|HKLM\System\CurrentControlSet\Control\Lsa\LMCompatibilityLevel             |DWORD (0x00000003)|
|2019-12-24 23:52:33.143|IT001.shire.com|C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe|HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0\RestrictSendingNTLMTraffic|DWORD (0x00000002)|
+-----------------------+---------------+---------------------------------------------------------+---------------------------------------------------------------------------+------------------+
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="known-bypasses">
<h2>Known Bypasses<a class="headerlink" href="#known-bypasses" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Idea</p></th>
<th class="text-align:left head"><p>Playbook</p></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
<div class="section" id="false-positives">
<h2>False Positives<a class="headerlink" href="#false-positives" title="Permalink to this headline">¶</a></h2>
<p>None</p>
</div>
<div class="section" id="hunter-notes">
<h2>Hunter Notes<a class="headerlink" href="#hunter-notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Make sure you have audit rules (SACL) applied to \REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa and \REGISTRY\MACHINE\SYSTEM\ControlSet001\Control\Lsa\MSV1_0</p></li>
<li><p>You can take the ProcessId of the process that performed the downgrade and explore its parents.</p></li>
</ul>
</div>
<div class="section" id="hunt-output">
<h2>Hunt Output<a class="headerlink" href="#hunt-output" title="Permalink to this headline">¶</a></h2>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Type</p></th>
<th class="text-align:left head"><p>Link</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Sigma Rule</p></td>
<td class="text-align:left"><p><a class="reference external" href="https://github.com/Neo23x0/sigma/blob/master/rules/windows/builtin/win_net_ntlm_downgrade.yml">https://github.com/Neo23x0/sigma/blob/master/rules/windows/builtin/win_net_ntlm_downgrade.yml</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://shenaniganslabs.io/2019/01/14/Internal-Monologue.html">https://shenaniganslabs.io/2019/01/14/Internal-Monologue.html</a></p></li>
<li><p><a class="reference external" href="https://jeffpar.github.io/kbarchive/kb/147/Q147706/">https://jeffpar.github.io/kbarchive/kb/147/Q147706/</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-lan-manager-authentication-level">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-lan-manager-authentication-level</a></p></li>
<li><p><a class="reference external" href="https://twitter.com/elad_shamir/status/975670116519063553">https://twitter.com/elad_shamir/status/975670116519063553</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-outgoing-ntlm-traffic-to-remote-servers">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-restrict-ntlm-outgoing-ntlm-traffic-to-remote-servers</a></p></li>
<li><p><a class="reference external" href="https://github.com/OTRF/Set-AuditRule/blob/master/registry/lsa.md">https://github.com/OTRF/Set-AuditRule/blob/master/registry/lsa.md</a></p></li>
<li><p><a class="reference external" href="https://www.andreafortuna.org/2018/03/26/retrieving-ntlm-hashes-without-touching-lsass-the-internal-monologue-attack/">https://www.andreafortuna.org/2018/03/26/retrieving-ntlm-hashes-without-touching-lsass-the-internal-monologue-attack/</a></p></li>
<li><p><a class="reference external" href="https://www.optiv.com/blog/post-exploitation-using-netntlm-downgrade-attacks">https://www.optiv.com/blog/post-exploitation-using-netntlm-downgrade-attacks</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "OTRF/ThreatHunter-Playbook",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "pyspark3"
        },
        kernelOptions: {
            kernelName: "pyspark3",
            path: "./notebooks/windows/05_defense_evasion"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'pyspark3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="WIN-201012183248.html" title="previous page">Wuauclt CreateRemoteThread Execution</a>
    <a class='right-next' id="next-link" href="WIN-190407183310.html" title="next page">Enable Remote Desktop Conections Registry</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Roberto Rodriguez @Cyb3rWard0g<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>